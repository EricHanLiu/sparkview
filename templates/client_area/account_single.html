<!DOCTYPE html>
{% extends 'main.html' %}
{% load staticfiles %}

{% load template_filters %}

{% block leftAside %}
{% endblock %}

{% block extraCss %}
    <style>
        .m-card-profile {
            display: inline-block;
            float: left;
            width: 200px;
            padding: 5px 15px;
            margin: 0;
        }

        .m-card-profile__pic-wrapper img {
            max-height: 80px;
        }

        {% if not account.star_flag %}
            .fa-flag:hover {
                cursor: pointer;
            }
        {% endif %}
    </style>
{% endblock %}

{% block content %}
    <!-- Modal for quick adding hours -->
    <div class="modal fade" id="quickAddModal" tabindex="-1" role="dialog" aria-labelledby="quickAddModal"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Quick Add Hours
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="m-form" id="quickadd">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Hours:</label>
                                    <input type="text" name="quickadd-hours"
                                           class="form-control m-input" required>
                                </div>
                                <div class="col-md-4">
                                    <label>Month:</label>
                                    <select class="form-control m-input"
                                            name="quickadd-month"
                                            style="width: 100%;" required>
                                        {% for monthNum, monthName in months %}
                                            <option value="{{ monthNum }}"
                                                    {% if monthnow|add:"0" == monthNum|add:"0" %}selected{% endif %}>{{ monthName }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="year">Year:</label>
                                    <select class="form-control m-input"
                                            name="quickadd-year"
                                            style="width: 100%;" required>
                                        {% for year in years %}
                                            <option value="{{ year }}"
                                                    {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row justify-content-end mt-3">
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="m-content">
        <!-- Assigned members -->
        <div class="row">
            <div class="col-xl-12">
                {% if account.has_blacklisted_accounts %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        </button>
                        <strong>Warning!</strong> One or more of the ad accounts associated with this account are
                        blacklisted. They are not retrieving any new spend information.
                    </div>
                {% endif %}
                {% if account.status == 2 %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        </button>
                        <strong>Heads Up!</strong> This account is inactive. The reason
                        is {{ account.get_inactive_reason_display }}. {% if account.inactive_return_date != None %}It is
                        supposed to return on {{ account.inactive_return_date|just_date }}{% endif %}
                    </div>
                {% endif %}
                {% if account.status == 3 %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        </button>
                        <strong>Warning!</strong> This account is lost. The reason
                        is {{ account.get_lost_reason_display }}.
                    </div>
                {% endif %}
                {% if account.has_blacklisted_accounts %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        </button>
                        <strong>Warning!</strong> One or more of the ad accounts associated with this account are
                        blacklisted. They are not retrieving any new spend information.
                    </div>
                {% endif %}
                {% if account.status == 0 %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        </button>
                        <strong>Notice:</strong> This account is in the onboarding phase. Go <a
                            href="/clients/accounts/onboard/{{ account.id }}" style="color:#fff;">here</a> to view the
                        progress.
                    </div>
                    {% if account.is_late_to_onboard %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            </button>
                            <strong>Warning!</strong> This account is late to onboard.
                            It has been in the onboarding phase for {{ account.onboarding_duration_elapsed }} days.
                            {% if account.late_onboard_reason != None and account.late_onboard_reason != '' %}
                                The reason is {{ account.late_onboard_reason }}.
                            {% endif %}
                        </div>
                    {% endif %}
                {% endif %}
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    {{ account.client_name }} Team
                                    &nbsp;
                                    <span class="m-badge m-badge--{{ status_badges|get_item_from_list:account.status }}"
                                          data-toggle="m-tooltip"
                                          data-original-title="{{ account.get_status_display }}"></span>
                                    &nbsp;
                                    <i class="fa fa-flag" {% if not account.star_flag %}data-toggle="modal"
                                       data-target="#flag_account_modal"{% endif %}
                                       data-flag="{% if account.star_flag %}1{% else %}0{% endif %}"
                                       {% if account.star_flag %}style="color:#ff5733;"{% endif %}></i>
                                    &nbsp;
                                    <a href="/clients/accounts/{{ account.id }}/edit"
                                       style="color: #000; text-decoration: none;">
                                      <span class="la la-edit">
                                      </span>
                                    </a>
                                    &nbsp;
                                    <span class="fas fa-clock" data-toggle="modal" style="cursor: pointer;"
                                          data-target="#quickAddModal">
                                    </span>
                                    &nbsp;
                                    <a class="btn btn-secondary m-btn btn-sm"
                                       href="/clients/accounts/{{ account.id }}/lifecycle">
                                        Lifecycle
                                    </a>
                                </h3>
                            </div>
                        </div>
                        <div class="m-portlet__head-tools">
                            <ul class="m-portlet__nav">
                                <li class="m-portlet__nav-item">
                                    <button type="button" class="btn btn-info m-btn"
                                            data-toggle="modal"
                                            data-target="#m_assign_members"> Assign Members
                                    </button>
                                    <button type="button" class="btn btn-info m-btn"
                                            data-toggle="modal"
                                            data-target="#m_position_allocation"> Assign %
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <!-- Assigned members -->
                    <div class="m-portlet__body" style="padding: 1.2rem 1.2rem;">
                        <div class="row">
                            <div class="col-xl-12" id="assigned-members-display">
                                {% for role, assigned_member in account.assigned_ams.items %}
                                    <div class="m-card-profile">
                                        <div class="m-card-profile__pic">
                                            <div class="m-card-profile__pic-wrapper">
                                                {% if assigned_member.member.image != None %}
                                                    <img src="{% static 'img/bloomers/'|add:assigned_member.member.image %}"/>
                                                {% else %}
                                                    <img src="{% static 'assets/app/media/img/user4.jpg' %}" alt=""/>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="m-card-profile__details">
                                            <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ assigned_member.member.id }}">{% endif %}{{ assigned_member.member.user.get_full_name }}
                                                {% if request.user.is_staff %}</a>{% endif %}</h3>
                                            <span class="m-badge  m-badge--info m-badge--wide">{{ role }}</span>
                                            <br/>
                                            <span data-toggle="m-tooltip"
                                                  data-original-title="{{ assigned_member.allocated_percentage }}%">{{ assigned_member.member|get_hours_per_member_and_account:account.id }}hr / {{ account|get_allocation_this_month_member:assigned_member.member }}hr</span>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% for role, assigned_member in account.assigned_cms.items %}
                                    <div class="m-card-profile">
                                        <div class="m-card-profile__pic">
                                            <div class="m-card-profile__pic-wrapper">
                                                {% if assigned_member.member.image != None %}
                                                    <img src="{% static 'img/bloomers/'|add:assigned_member.member.image %}"/>
                                                {% else %}
                                                    <img src="{% static 'assets/app/media/img/user4.jpg' %}" alt=""/>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="m-card-profile__details">
                                            <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ assigned_member.member.id }}">{% endif %}{{ assigned_member.member.user.get_full_name }}
                                                {% if request.user.is_staff %}</a>{% endif %}</h3>
                                            <span class="m-badge  m-badge--success m-badge--wide">{{ role }}</span>
                                            <br/>
                                            <span data-toggle="m-tooltip"
                                                  data-original-title="{{ assigned_member.allocated_percentage }}%">{{ assigned_member.member|get_hours_per_member_and_account:account.id }}hr / {{ account|get_allocation_this_month_member:assigned_member.member }}hr</span>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% for role, assigned_member in account.assigned_seos.items %}
                                    <div class="m-card-profile">
                                        <div class="m-card-profile__pic">
                                            <div class="m-card-profile__pic-wrapper">
                                                {% if assigned_member.member.image != None %}
                                                    <img src="{% static 'img/bloomers/'|add:assigned_member.member.image %}"/>
                                                {% else %}
                                                    <img src="{% static 'assets/app/media/img/user4.jpg' %}" alt=""/>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="m-card-profile__details">
                                            <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ assigned_member.member.id }}">{% endif %}{{ assigned_member.member.user.get_full_name }}
                                                {% if request.user.is_staff %}</a>{% endif %}</h3>
                                            <span class="m-badge  m-badge--warning m-badge--wide">{{ role }}</span>
                                            <br/>
                                            <span data-toggle="m-tooltip"
                                                  data-original-title="{{ assigned_member.allocated_percentage }}%">{{ assigned_member.member|get_hours_per_member_and_account:account.id }}hr / {{ account|get_allocation_this_month_member:assigned_member.member }}hr</span>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% for role, assigned_member in account.assigned_strats.items %}
                                    <div class="m-card-profile">
                                        <div class="m-card-profile__pic">
                                            <div class="m-card-profile__pic-wrapper">
                                                {% if assigned_member.member.image != None %}
                                                    <img src="{% static 'img/bloomers/'|add:assigned_member.member.image %}"/>
                                                {% else %}
                                                    <img src="{% static 'assets/app/media/img/user4.jpg' %}" alt=""/>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="m-card-profile__details">
                                            <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ assigned_member.member.id }}">{% endif %}{{ assigned_member.member.user.get_full_name }}
                                                {% if request.user.is_staff %}</a>{% endif %}</h3>
                                            <span class="m-badge  m-badge--danger m-badge--wide">{{ role }}</span>
                                            <br/>
                                            <span data-toggle="m-tooltip"
                                                  data-original-title="{{ assigned_member.allocated_percentage }}%">{{ assigned_member.member|get_hours_per_member_and_account:account.id }}hr / {{ account|get_allocation_this_month_member:assigned_member.member }}hr</span>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% for backup in backups %}
                                    {% for member in backup.members.all %}
                                        <div class="m-card-profile">
                                            <div class="m-card-profile__pic">
                                                <div class="m-card-profile__pic-wrapper">
                                                    {% if member.image != None %}
                                                        <img src="{% static 'img/bloomers/'|add:member.image %}"/>
                                                    {% else %}
                                                        <img src="{% static 'assets/app/media/img/user4.jpg' %}"
                                                             alt=""/>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="m-card-profile__details">
                                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                    {% if request.user.is_staff %}
                                                        <a href="/user_management/members/{{ member.id }}">{% endif %}{{ member.user.get_full_name }}
                                                    {% if request.user.is_staff %}</a>{% endif %}</h3>
                                                <span class="m-badge m-badge--wide"
                                                      style="background: #AA43DE; color: white;">Backup</span>
                                                <br/>
                                                <span data-toggle="m-tooltip">{{ backup.period.start_date }} - {{ backup.period.end_date }}</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                                {% if account.team_lead_override != None and account.team_lead_override != '' %}
                                    <div class="m-card-profile">
                                        <div class="m-card-profile__pic">
                                            <div class="m-card-profile__pic-wrapper">
                                                {% if account.team_lead_override.image != None %}
                                                    <img src="{% static 'img/bloomers/'|add:account.team_lead_override.image %}"/>
                                                {% else %}
                                                    <img src="{% static 'assets/app/media/img/user4.jpg' %}" alt=""/>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="m-card-profile__details">
                                            <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ account.team_lead_override.id }}">{% endif %}{{ account.team_lead_override.user.get_full_name }}
                                                {% if request.user.is_staff %}</a>{% endif %}</h3>
                                            <span class="m-badge m-badge--wide"
                                                  style="background: rgb(255, 153, 51); color: white;">Team Lead</span>
                                        </div>
                                    </div>
                                {% else %}
                                    {% for assigned_member in account.team_leads %}
                                        <div class="m-card-profile">
                                            <div class="m-card-profile__pic">
                                                <div class="m-card-profile__pic-wrapper">
                                                    {% if assigned_member.image != None %}
                                                        <img src="{% static 'img/bloomers/'|add:assigned_member.image %}"/>
                                                    {% else %}
                                                        <img src="{% static 'assets/app/media/img/user4.jpg' %}"
                                                             alt=""/>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="m-card-profile__details">
                                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                    {% if request.user.is_staff %}
                                                        <a href="/user_management/members/{{ assigned_member.member.id }}">{% endif %}{{ assigned_member.user.get_full_name }}
                                                    {% if request.user.is_staff %}</a>{% endif %}</h3>
                                                <span class="m-badge m-badge--wide"
                                                      style="background: rgb(255, 153, 51); color: white;">Team Lead</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                {% for assignment in account.active_mandate_assignments %}
                                    {% with assigned_member=assignment.member %}
                                        <div class="m-card-profile">
                                            <div class="m-card-profile__pic">
                                                <div class="m-card-profile__pic-wrapper">
                                                    {% if assigned_member.image != None %}
                                                        <img src="{% static 'img/bloomers/'|add:assigned_member.image %}"/>
                                                    {% else %}
                                                        <img src="{% static 'assets/app/media/img/user4.jpg' %}"
                                                             alt=""/>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="m-card-profile__details">
                                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                                    {% if request.user.is_staff %}
                                                        <a href="/user_management/members/{{ assigned_member.id }}">{% endif %}{{ assigned_member.user.get_full_name }}
                                                    {% if request.user.is_staff %}</a>{% endif %}</h3>
                                                <span class="m-badge m-badge--wide"
                                                      data-toggle="m-tooltip"
                                                      data-original-title="{{ assignment.mandate }}"
                                                      style="background: rgb(255, 153, 51); color: white;">Mandate</span>
                                                <br/>
                                                <span data-toggle="m-tooltip">{{ assignment.worked_this_month }}/{{ assignment.hours }}hr</span>
                                                <br/>
                                                <span data-toggle="m-tooltip">{{ assignment.mandate.start_date_pretty }} - {{ assignment.mandate.end_date_pretty }}</span>
                                            </div>
                                        </div>
                                    {% endwith %}
                                {% endfor %}
                                <div class="m-card-profile">
                                    <div class="m-card-profile__pic">
                                        <div class="m-card-profile__pic-wrapper">
                                            {% if account.soldBy.image != None %}
                                                <img src="{% static 'img/bloomers/'|add:account.soldBy.image %}"/>
                                            {% else %}
                                                <img src="{% static 'assets/app/media/img/user4.jpg' %}" alt=""/>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="m-card-profile__details">
                                        <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                            {% if request.user.is_staff %}
                                                <a href="/user_management/members/{{ account.soldBy.id }}">{% endif %}{{ account.soldBy.user.get_full_name }}
                                            {% if request.user.is_staff %}</a>{% endif %}</h3>
                                        <span class="m-badge m-badge--wide"
                                              style="background: rgb(0, 153, 151); color: white;">Sales</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End of assigned members -->
                </div>
            </div>
            <div class="col-xl-4">
                <!-- Start services -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Services
                                </h3>
                            </div>
                        </div>
                        <div class="m-portlet__head-tools">
                            <ul class="m-portlet__nav">
                                <li class="m-portlet__nav-item">
                                    <button type="button" class="btn btn-info m-btn" data-toggle="modal"
                                            data-target="#m_new_opportunity" id="new_opportunity">
                                        New Opportunity
                                    </button>
                                </li>
{#                                <li class="m-portlet__nav-item">#}
{#                                    <button type="button" class="btn btn-info m-btn" data-toggle="modal"#}
{#                                            data-target="#m_new_pitch" id="new_pitch">#}
{#                                        New Pitch#}
{#                                    </button>#}
{#                                </li>#}
                                <li class="m-portlet__nav-item">
                                    <button type="button" class="btn btn-info m-btn" data-toggle="modal"
                                            data-target="#m_update_services" id="kpi_btn">
                                        Update
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="account_change_datatable">
                            <thead class="thead-inverse">
                            <tr class="main-table-header">
                                <th>
                                    Service
                                </th>
                                <th>
                                    Status
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>
                                    PPC
                                </td>
                                <td>
                                    {% if account.sales_profile.ppc_status == 0 %}
                                        <a href="/clients/accounts/onboard/{{ account.id }}">{{ account.sales_profile.get_ppc_status_display }}</a>
                                    {% else %}
                                        {{ account.sales_profile.get_ppc_status_display }}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    SEO
                                </td>
                                <td>
                                    {% if account.sales_profile.seo_status == 0 %}
                                        <a href="/clients/accounts/onboard/{{ account.id }}">{{ account.sales_profile.get_seo_status_display }}</a>
                                    {% else %}
                                        {{ account.sales_profile.get_seo_status_display }}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    CRO
                                </td>
                                <td>
                                    {% if account.sales_profile.cro_status == 0 %}
                                        <a href="/clients/accounts/onboard/{{ account.id }}">{{ account.sales_profile.get_cro_status_display }}</a>
                                    {% else %}
                                        {{ account.sales_profile.get_cro_status_display }}
                                    {% endif %}
                                </td>
                            </tr>
                            {#                            <tr>#}
                            {#                                <td>#}
                            {#                                    Strat#}
                            {#                                </td>#}
                            {#                                <td>#}
                            {#                                    {{ account.sales_profile.get_strat_status_display }}#}
                            {#                                </td>#}
                            {#                            </tr>#}
                            {#                            <tr>#}
                            {#                                <td>#}
                            {#                                    Email Marketing#}
                            {#                                </td>#}
                            {#                                <td>#}
                            {#                                    {{ account.sales_profile.get_email_status_display }}#}
                            {#                                </td>#}
                            {#                            </tr>#}
                            {#                            <tr>#}
                            {#                                <td>#}
                            {#                                    Feed Management#}
                            {#                                </td>#}
                            {#                                <td>#}
                            {#                                    {{ account.sales_profile.get_feed_status_display }}#}
                            {#                                </td>#}
                            {#                            </tr>#}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- End services -->
                <!-- Start mandates -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Additional Services
                                </h3>
                            </div>
                        </div>
                        <div class="m-portlet__head-tools">
                            <ul class="m-portlet__nav">
                                <li class="m-portlet__nav-item">
                                    <button type="button" class="btn btn-info m-btn" data-toggle="modal"
                                            data-target="#m_new_mandate" id="kpi_btn">
                                        New Additional Service
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="account_change_datatable">
                            <thead class="thead-inverse">
                            <tr class="main-table-header">
                                <th>
                                    Type
                                </th>
                                <th>
                                    Cost
                                </th>
                                <th>
                                    Term
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for mandate in account.active_mandates %}
                                <tr>
                                    <td>
                                        {{ mandate.mandate_type }}
                                    </td>
                                    <td>
                                        {{ mandate.calculated_cost }}
                                    </td>
                                    <td>
                                        {{ mandate.start_date_pretty }} - {{ mandate.end_date_pretty }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- End mandates -->
                <!-- Opportunities -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Opportunities
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="single_client_hours_datatable">
                            <thead>
                            <tr>
                                <th>
                                    Service
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Date Created
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for opp in account.opportunities %}
                                <tr>
                                    <td>
                                        {{ opp.service_string }}
                                    </td>
                                    <td>
                                        {{ opp.reason }}
                                    </td>
                                    <td>
                                        {{ opp.created }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- end opportunities -->
                <!-- Pitches -->
{#                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">#}
{#                    <div class="m-portlet__head">#}
{#                        <div class="m-portlet__head-caption">#}
{#                            <div class="m-portlet__head-title">#}
{#                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">#}
{#                                    Pitches#}
{#                                </h3>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                    <div class="m-portlet__body">#}
{#                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'#}
{#                               id="single_client_hours_datatable">#}
{#                            <thead>#}
{#                            <tr>#}
{#                                <th>#}
{#                                    Service#}
{#                                </th>#}
{#                                <th>#}
{#                                    Description#}
{#                                </th>#}
{#                                <th>#}
{#                                    Date Created#}
{#                                </th>#}
{#                            </tr>#}
{#                            </thead>#}
{#                            <tbody>#}
{#                            {% for pitch in account.pitches %}#}
{#                                <tr>#}
{#                                    <td>#}
{#                                        {{ opp.service_string }}#}
{#                                    </td>#}
{#                                    <td>#}
{#                                        {{ opp.reason }}#}
{#                                    </td>#}
{#                                    <td>#}
{#                                        {{ opp.created }}#}
{#                                    </td>#}
{#                                </tr>#}
{#                            {% endfor %}#}
{#                            </tbody>#}
{#                        </table>#}
{#                    </div>#}
{#                </div>#}
                <!-- end pitches -->
                <!-- Details -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Details
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <div class="form-group m-form__group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Contact Name:</label>
                                    {% for clientContact in account.contactInfo.all %}
                                        <input type="text" class="form-control m-input" value="{{ clientContact.name }}"
                                               disabled>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <label>Contact Email:</label>
                                    {% for clientContact in account.contactInfo.all %}
                                        <input type="text" class="form-control m-input"
                                               value="{{ clientContact.email }}" disabled>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Contact Phone:</label>
                                    {% for clientContact in account.contactInfo.all %}
                                        <input type="text" class="form-control m-input"
                                               value="{{ clientContact.phone }}" disabled>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <label for="role">Industry:</label>
                                    <input type="text" class="form-control m-input" value="{{ account.industry.name }}"
                                           disabled>
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="team">Services:</label>
                                    {% if account.aw_budget != 0.0 %}
                                        <input type="text" class="form-control m-input" value="Adwords" disabled>
                                    {% endif %}
                                    {% if account.bing_budget != 0.0 %}
                                        <input type="text" class="form-control m-input" value="Bing" disabled>
                                    {% endif %}
                                    {% if account.fb_budget != 0.0 %}
                                        <input type="text" class="form-control m-input" value="Facebook" disabled>
                                    {% endif %}
                                    {% if account.has_seo %}
                                        <input type="text" class="form-control m-input" value="SEO" disabled>
                                    {% endif %}
                                    {% if account.has_cro %}
                                        <input type="text" class="form-control m-input" value="CRO" disabled>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="team">Team:</label>
                                    {% for team in account.team.all %}
                                        <input type="text" class="form-control m-input" value="{{ team.name }}"
                                               disabled>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end details -->
                <!-- Hours this month -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Hours This Month
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="single_client_hours_datatable">
                            <thead>
                            <tr>
                                <th>
                                    Member
                                </th>
                                <th>
                                    Hours
                                </th>
                                <th>
                                    Month
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for hourRow in accountHoursMember %}
                                <tr>
                                    <td>
                                        {{ hourRow.member }}
                                    </td>
                                    <td>
                                        {{ hourRow.hours__sum }}
                                    </td>
                                    <td>
                                        {{ hourRow.month }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- end hours this month -->

                <!-- Hours this month -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Mandates Hours This Month
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="single_client_hours_datatable">
                            <thead>
                            <tr>
                                <th>Mandate</th>
                                <th>
                                    Member
                                </th>
                                <th>
                                    Hours
                                </th>
                                <th>
                                    Month
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for hour_row in mandate_hours_this_month %}
                                <tr>
                                    <td>
                                        {{ hour_row.assignment.mandate }}
                                    </td>
                                    <td>
                                        {{ hour_row.assignment.member }}
                                    </td>
                                    <td>
                                        {{ hour_row.hours }}
                                    </td>
                                    <td>
                                        {{ hour_row.month }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- end hours this month -->

                <!-- Value added hours this month -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Value Added Hours This Month
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="single_client_hours_datatable">
                            <thead>
                            <tr>
                                <th>
                                    Member
                                </th>
                                <th>
                                    Hours
                                </th>
                                <th>
                                    Month
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for hourRow in value_hours_member %}
                                <tr>
                                    <td>
                                        {{ hourRow.member }}
                                    </td>
                                    <td>
                                        {{ hourRow.hours__sum }}
                                    </td>
                                    <td>
                                        {{ hourRow.month }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- End value added hours -->

                <!-- Account history -->
                {#                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">#}
                {#                    <div class="m-portlet__head">#}
                {#                        <div class="m-portlet__head-caption">#}
                {#                            <div class="m-portlet__head-title">#}
                {#                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">#}
                {#                                    Account History#}
                {#                                </h3>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                    <div class="m-portlet__body">#}
                {#                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'#}
                {#                               id="account_change_datatable">#}
                {#                            <thead class="thead-inverse">#}
                {#                            <tr class="main-table-header">#}
                {#                                <th>#}
                {#                                    Member#}
                {#                                </th>#}
                {#                                <th>#}
                {#                                    Field Changed#}
                {#                                </th>#}
                {#                                <th>#}
                {#                                    Changed From#}
                {#                                </th>#}
                {#                                <th>#}
                {#                                    Changed To#}
                {#                                </th>#}
                {#                                <th>#}
                {#                                    Date#}
                {#                                </th>#}
                {#                            </tr>#}
                {#                            </thead>#}
                {#                            <tbody>#}
                {#                            {% for change in changes.all %}#}
                {#                                <tr>#}
                {#                                    <td>#}
                {#                                        {{ change.member.user.first_name }} {{ change.member.user.last_name }}#}
                {#                                    </td>#}
                {#                                    <td>#}
                {#                                        {{ change.changeField }}#}
                {#                                    </td>#}
                {#                                    <td>#}
                {#                                        {{ change.changedFrom }}#}
                {#                                    </td>#}
                {#                                    <td>#}
                {#                                        {{ change.changedTo }}#}
                {#                                    </td>#}
                {#                                    <td>#}
                {#                                        {{ change.datetime }}#}
                {#                                    </td>#}
                {#                                </tr>#}
                {#                            {% endfor %}#}
                {#                            </tbody>#}
                {#                        </table>#}
                {#                    </div>#}
                {#                </div>#}
                <!-- end account history -->

                <!-- Management fee structure -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Management Fee Structure
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        {% if account.management_fee_override != None and account.management_fee_override != 0.0 %}
                            <p>Manual Override: ${{ account.management_fee_override }}</p>
                        {% else %}
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="fee_structure_datatable">
                                <thead class="thead-inverse">
                                <tr class="main-table-header">
                                    <th>
                                        Monthly Media Spend
                                    </th>
                                    <th>
                                        Monthly Fee
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for interval in account.managementFee.feeStructure.all %}
                                    <tr>
                                        <td>
                                            ${{ interval.lowerBound }} - ${{ interval.upperBound }}
                                        </td>
                                        <td>
                                            {% if interval.feeStyle == 1 %}${{ interval.fee|format_money }}{% endif %}
                                            {% if interval.feeStyle == 0 %}{{ interval.fee }}%{% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>
                <!-- end management fee structure -->
            </div>
            <div class="col-xl-8">
                <!-- Main portlet -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text">
                                    Budget Information
                                </h3>
                            </div>
                        </div>
                        <div class="m-portlet__head-tools">
                            <ul class="m-portlet__nav">
                                <li class="m-portlet__nav-item">
                                    <a class="btn btn-info m-btn" href="/budget/client/{{ account.id }}">
                                        Manage Budget
                                    </a>
                                </li>
                                <li class="m-portlet__nav-item">
                                    <a class="btn btn-info m-btn" href="/budget/client/{{ account.id }}/beta">
                                        Budgets (BETA)
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <div class="row m-row--no-padding m-row--col-separator-xl">
                            <div class="col-md-12 col-lg-12 col-xl-6">
                                <div class="m-widget1">
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Total Budget</h3>
                                                <span class="m-widget1__desc">Total monthy budget</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-brand">${{ account.current_budget|format_money }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Spend This Month</h3>
                                                <span class="m-widget1__desc">Amount spent (Adwords, FB, Bing)</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-danger">${{ account.current_spend|format_money }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Budget Remaining</h3>
                                                <span class="m-widget1__desc">Left to spend this month</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-success">${{ account.remainingBudget|format_money }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Management Fee</h3>
                                                <span class="m-widget1__desc">Projected management fee this month</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-success">${{ account.total_fee|format_money }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12 col-lg-12 col-xl-6">
                                <div class="m-widget1">
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Allocated Hours This Month</h3>
                                                <span class="m-widget1__desc">All hours allocated this month</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-info">{{ account.allocated_hours_including_mandate|floatformat }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% if account.fallback_hours is not None %}
                                        <div class="m-widget1__item">
                                            <div class="row m-row--no-padding align-items-center">
                                                <div class="col">
                                                    <h3 class="m-widget1__title">Fallback Hours</h3>
                                                    <span class="m-widget1__desc">Remaining hours leftover from override</span>
                                                </div>
                                                <div class="col m--align-right">
                                                    <span class="m-widget1__number m--font-danger">{{ account.fallback_hours|floatformat }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Hours Worked This Month</h3>
                                                <span class="m-widget1__desc">All hours worked this month</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-info">{{ account.hoursWorkedThisMonth|floatformat }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="m-widget1__item">
                                        <div class="row m-row--no-padding align-items-center">
                                            <div class="col">
                                                <h3 class="m-widget1__title">Hours Remaining This Month</h3>
                                                <span class="m-widget1__desc">All hours remaining this month</span>
                                            </div>
                                            <div class="col m--align-right">
                                                <span class="m-widget1__number m--font-{% if account.hoursRemainingMonth < 0 %}danger{% else %}info{% endif %}">{{ account.hoursRemainingMonth|floatformat }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End main portlet -->
                <!-- Promos -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text">
                                    Promos
                                </h3>
                            </div>
                        </div>
                        <div class="m-portlet__head-tools">
                            <ul class="m-portlet__nav">
                                <li class="m-portlet__nav-item">
                                    <button type="button" class="btn btn-info m-btn"
                                            data-toggle="modal"
                                            data-target="#m_new_promo"> Add Promos
                                    </button>
                                </li>
                                <li class="m-portlet__nav-item">
                                    <a class="btn btn-info m-btn" href="/clients/promos/edit">
                                        Edit Promos
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        {% if promos.count > 0 %}
                            <div id="calendar" class="fc fc-unthemed fc-ltr">

                            </div>
                        {% endif %}
                    </div>
                </div>
                <!-- End promos -->
                {% if promos.count > 0 %}
                    <!-- Promo this month summary -->
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text">
                                        Promo Summary
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="account_change_datatable">
                                <thead class="thead-inverse">
                                <tr class="main-table-header">
                                    <th>
                                        Promo Name
                                    </th>
                                    <th>
                                        Start Date
                                    </th>
                                    <th>
                                        End Date
                                    </th>
                                    <th>
                                        Desc
                                    </th>
                                    <th>
                                        Services
                                    </th>
                                    <th>
                                        Confirmed Started
                                    </th>
                                    <th>
                                        Confirmed Ended
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for promo in promos %}
                                    <tr>
                                        <td>
                                            {{ promo }}
                                        </td>
                                        <td>
                                            {{ promo.start_date }}
                                        </td>
                                        <td>
                                            {{ promo.end_date }}
                                        </td>
                                        <td>
                                            {{ promo.desc }}
                                        </td>
                                        <td>
                                            {{ promo.services_str }}
                                        </td>
                                        <td>
                                            <input type="checkbox" class="confirm-promo" data-promo-id="{{ promo.id }}"
                                                   data-account-id="{{ account.id }}" data-confirmation-type="0"
                                                   {% if promo.confirmed_started != None %}checked disabled{% endif %}/>
                                        </td>
                                        <td>
                                            <input type="checkbox" class="confirm-promo" data-promo-id="{{ promo.id }}"
                                                   data-account-id="{{ account.id }}" data-confirmation-type="1"
                                                   {% if promo.confirmed_ended != None %}checked disabled{% endif %}/>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- End promos this month summary -->
                {% endif %}
            </div>
            <!-- end assigned members -->
        </div>
        <!--End::Main Portlet-->
    </div>

    <!-- Begin assign members modal -->
    <div class="modal fade" id="m_assign_members" tabindex="-1" role="dialog" aria-labelledby="m_assign_members">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Members to {{ account.client_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/assign_members" id="m_form_assign_members">
                    {% csrf_token %}
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>AM:</label>
                                        <select class="form-control m-input"
                                                name="am1-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.am1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>AM2:</label>
                                        <select class="form-control m-input"
                                                name="am2-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.am2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>AM3:</label>
                                        <select class="form-control m-input"
                                                name="am3-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.am3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="buffer_total_percentage">CM:</label>
                                        <select class="form-control m-input"
                                                name="cm1-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.cm1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="buffer_learning_percentage">CM2:</label>
                                        <select class="form-control m-input"
                                                name="cm2-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.cm2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="buffer_trainers_percentage">CM3:</label>
                                        <select class="form-control m-input"
                                                name="cm3-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.cm3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>Strat:</label>
                                        <select class="form-control m-input"
                                                name="strat1-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.strat1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Strat 2:</label>
                                        <select class="form-control m-input"
                                                name="strat2-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.strat2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Strat 3:</label>
                                        <select class="form-control m-input"
                                                name="strat3-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.strat3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>SEO:</label>
                                        <select class="form-control m-input"
                                                name="seo1-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.seo1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>SEO2:</label>
                                        <select class="form-control m-input"
                                                name="seo2-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.seo2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>SEO3:</label>
                                        <select class="form-control m-input"
                                                name="seo3-assign"
                                                style="width: 100%;">
                                            <option value="0">
                                                None
                                            </option>
                                            {% for member in members %}
                                                <option value="{{ member.id }}"
                                                        {% if member.id == account.seo3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Submit" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End member assignment modal -->

    <!-- Allocation per position modal -->
    <div class="modal fade" id="m_position_allocation" tabindex="-1" role="dialog"
         aria-labelledby="m_position_allocation">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Percentages per position for {{ account.client_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/allocate_percentages"
                      id="m_form_allocate_percentages">
                    {% csrf_token %}
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>AM:</label>
                                        <input type="text" name="am1-percent" id="am1-percent"
                                               class="form-control m-input" value="{{ account.am1percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>AM2:</label>
                                        <input type="text" name="am2-percent" id="am2-percent"
                                               class="form-control m-input" value="{{ account.am2percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>AM3:</label>
                                        <input type="text" name="am3-percent" id="am3-percent"
                                               class="form-control m-input" value="{{ account.am3percent }}"/>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>CM:</label>
                                        <input type="text" name="cm1-percent" id="cm1-percent"
                                               class="form-control m-input" value="{{ account.cm1percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>CM2:</label>
                                        <input type="text" name="cm2-percent" id="cm2-percent"
                                               class="form-control m-input" value="{{ account.cm2percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>CM3:</label>
                                        <input type="text" name="cm3-percent" id="cm3-percent"
                                               class="form-control m-input" value="{{ account.cm3percent }}"/>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Strat:</label>
                                        <input type="text" name="strat1-percent" id="strat1-percent"
                                               class="form-control m-input" value="{{ account.strat1percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Strat 2:</label>
                                        <input type="text" name="strat2-percent" id="strat2-percent"
                                               class="form-control m-input" value="{{ account.strat2percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Strat 3:</label>
                                        <input type="text" name="strat3-percent" id="strat3-percent"
                                               class="form-control m-input" value="{{ account.strat3percent }}"/>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>SEO:</label>
                                        <input type="text" name="seo1-percent" id="seo1-percent"
                                               class="form-control m-input" value="{{ account.seo1percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>SEO 2:</label>
                                        <input type="text" name="seo2-percent" id="seo2-percent"
                                               class="form-control m-input" value="{{ account.seo2percent }}"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>SEO 3:</label>
                                        <input type="text" name="seo3-percent" id="seo3-percent"
                                               class="form-control m-input" value="{{ account.seo3percent }}"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="distribute_hours_btn"
                                style="margin-right:auto;">Distribute hours proportionately
                        </button>
                        <input type="submit" value="Submit" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End assign percentages modal -->

    <!-- Add promo -->
    <div class="modal fade" id="m_new_promo" tabindex="-1" role="dialog" aria-labelledby="m_position_allocation">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add a promo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/new_promo" id="m_form_new_promo">
                    {% csrf_token %}
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Name:</label>
                                        <input type="text" name="promo-name" class="form-control m-input"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Start Date:</label>
                                        <input type="text" name="start-date" class="form-control datetimepicker"
                                               readonly="" placeholder="Set start date here">
                                    </div>
                                    <div class="col-md-4">
                                        <label>End Date:</label>
                                        <input type="text" name="end-date" class="form-control datetimepicker"
                                               readonly="" placeholder="Set end date here">
                                    </div>
                                </div>
                                <hr/>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Description:</label>
                                        <input type="text" maxlength="140" name="promo-desc"
                                               class="form-control m-input"/>
                                    </div>
                                    <div class="col-md-1">
                                        <label>AW:</label>
                                        <input type="checkbox" name="has-aw" class="form-control"/>
                                    </div>
                                    <div class="col-md-1">
                                        <label>FB:</label>
                                        <input type="checkbox" name="has-fb" class="form-control"/>
                                    </div>
                                    <div class="col-md-1">
                                        <label>Bing:</label>
                                        <input type="checkbox" name="has-bing" class="form-control"/>
                                    </div>
                                    <div class="col-md-1">
                                        <label>Other:</label>
                                        <input type="checkbox" name="has-other" class="form-control"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Add Promo" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End add promo -->

    <!-- New opportunity modal -->
    <div class="modal fade" id="m_new_opportunity" tabindex="-1" role="dialog" aria-labelledby="m_position_allocation">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New opportunity for {{ account.client_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/set_opportunity">
                    {% csrf_token %}
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Service:</label>
                                        <select class="form-control m-input"
                                                name="service"
                                                id="service"
                                                style="width: 100%;">
                                            <option value="ppc">
                                                PPC
                                            </option>
                                            <option value="seo">
                                                SEO
                                            </option>
                                            <option value="cro">
                                                CRO
                                            </option>
                                            {% for service in additional_services %}
                                                <option value="{{ service.id }}">
                                                    {{ service }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Description:</label>
                                        <select class="form-control m-input"
                                                name="opp_reason"
                                                id="opp_reason"
                                                style="width: 100%;">
                                            {% for opp in opp_reasons %}
                                                <option value="{{ opp.id }}">
                                                    {{ opp }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Submit" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End New opportunity -->

    <!-- Set Services modal -->
    <div class="modal fade" id="m_update_services" tabindex="-1" role="dialog" aria-labelledby="m_position_allocation">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Services</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/set_services">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                            <div class="row ">
                                <div class="col-4">
                                    PPC
                                </div>
                                <div class="col-4">
                                    <select class="form-control update-service" name="set-ppc">
                                        {% for service_num, service_str in account.sales_profile.STATUS_CHOICES %}
                                            {% if service_num != 6 %}
                                                <option value="{{ service_num }}"
                                                        {% if account.sales_profile.ppc_status == service_num %}
                                                        selected
                                                        {% endif %}>
                                                    {{ service_str }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row ">
                                <div class="col-4">
                                    SEO
                                </div>
                                <div class="col-4">
                                    <select class="form-control update-service" name="set-seo">
                                        {% for service_num, service_str in account.sales_profile.STATUS_CHOICES %}
                                            {% if service_num != 6 %}
                                                <option value="{{ service_num }}"
                                                        {% if account.sales_profile.seo_status == service_num %}
                                                        selected
                                                        {% endif %}>
                                                    {{ service_str }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row ">
                                <div class="col-4">
                                    CRO
                                </div>
                                <div class="col-4">
                                    <select class="form-control update-service" name="set-cro">
                                        {% for service_num, service_str in account.sales_profile.STATUS_CHOICES %}
                                            {% if service_num != 6 %}
                                                <option value="{{ service_num }}"
                                                        {% if account.sales_profile.cro_status == service_num %}
                                                        selected
                                                        {% endif %}>
                                                    {{ service_str }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Update Services" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End set Services -->

    <!-- Flag account -->
    <div class="modal fade" id="flag_account_modal" tabindex="-1" role="dialog" aria-labelledby="m_position_allocation">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Flag Account {{ account.client_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/flag">
                    {% csrf_token %}
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Basecamp Link:</label>
                                        <input type="text" name="bc_link" class="form-control m-input" required/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Flag Account" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Flag account modal -->

    <!-- New mandate modal -->
    <div class="modal fade" id="m_new_mandate" tabindex="-1" role="dialog" aria-labelledby="m_new_mandate">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Additional Service for {{ account.client_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/clients/accounts/mandates/new">
                    {% csrf_token %}
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <input name="num_members" type="text" value="0" style="display:none;"/>

                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Additional service type:</label>
                                        <select class="form-control m-input"
                                                name="mandate_type"
                                                id="mandate_type"
                                                style="width: 100%;">
                                            {% for mandate_type in mandate_types %}
                                                <option value="{{ mandate_type.id }}"
                                                        data-hourly="{{ mandate_type.hourly_rate }}">
                                                    {{ mandate_type }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <br/>
                                <div class="row">
                                    <label class="col-2 col-form-label">Ongoing Service</label>
                                    <div class="col-2">
                                        <span class="m-switch m-switch--outline m-switch--icon m-switch--success">
                                            <label>
                                                <input name="ongoing_check" id="ongoing_check" type="checkbox">
                                                <span></span>
                                            </label>
                                        </span>
                                    </div>
                                </div>
                                <hr/>
                                <div id="set_duration_form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Cost:</label>
                                            <input type="text" name="cost" class="form-control m-input"/>
                                        </div>
                                        <div class="col-md-6">
                                            <label>Hourly rate:</label>
                                            <input type="text" name="hourly_rate" id="mandate_hourly_rate"
                                                   class="form-control m-input" value="{{ first_mandate_rate }}"
                                            />
                                        </div>
                                    </div>
                                    <br/>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Start Date:</label>
                                            <input type="text" name="start_date"
                                                   class="form-control m-input m_datepicker"/>
                                        </div>
                                        <div class="col-md-6">
                                            <label>End Date:</label>
                                            <input type="text" name="end_date"
                                                   class="form-control m-input m_datepicker"/>
                                        </div>
                                    </div>
                                </div>
                                <div id="ongoing_form" style="display: none;">
                                    <div class="row">
                                        <label class="col-2 col-form-label">Hour bank</label>
                                        <div class="col-2">
                                        <span class="m-switch m-switch--outline m-switch--icon m-switch--success">
                                            <label>
                                                <input name="hourly_check" id="hourly_check" type="checkbox">
                                                <span></span>
                                            </label>
                                        </span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Monthly Cost:</label>
                                            <input type="text" name="monthly_cost" id="monthly_cost"
                                                   class="form-control m-input"/>
                                        </div>
                                        <div class="col-md-6">
                                            <label>Hourly rate:</label>
                                            <input type="text" name="monthly_hourly_rate" id="monthly_hourly_rate"
                                                   class="form-control m-input" value="{{ first_mandate_rate }}"
                                            />
                                        </div>
                                    </div>
                                    <br/>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Monthly Hours:</label>
                                            <input type="text" name="monthly_hours" id="monthly_hours"
                                                   class="form-control m-input" disabled/>
                                        </div>
                                    </div>
                                </div>

                                <br/>
                                <div class="row">
                                    <div class="col-md-3">
                                        <button type="button" id="add_member_btn" class="btn btn-info">Add Member
                                        </button>
                                    </div>
                                </div>
                                <br/>
                                <div class="row" id="mandate_members">

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Submit" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End New mandate modal -->

    <!-- New member in mandate row -->
    <template id="member_in_mandate_template">
        <div class="col-md-9">
            <label>Member:</label>
            <select class="form-control m-input"
                    name="mandate_member"
                    style="width: 100%;">
                {% for member in members %}
                    <option value="{{ member.id }}">
                        {{ member }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label>Percentage:</label>
            <input type="text" name="percentage"
                   class="form-control m-input" required/>
        </div>
        <br/>
    </template>
    <!-- end new member in mandate row -->

{% endblock %}

{% block extraJs %}
    <script>
        // Handles update services functionality
        let $updateServiceSelects = $('.update-service');
        $updateServiceSelects.change(displayMore);
        $.each($updateServiceSelects, displayMore);

        function displayMore() {
            // get the two siblings
            let status = $(this).val();
            let $oppSelect = $(this).parent().next();
            let $pitchSelect = $oppSelect.next();
        }


        $(document).ready(function () {
            let $distrubteHoursBtn = $('#distribute_hours_btn');
            {#let $starIcon = $('.fa-flag');#}
            let $promoCheck = $('.confirm-promo');

            $promoCheck.click(function () {
                let confirmation_type = $(this).data('confirmation-type');
                let promo_type = $(this).data('promo-id');
                if ($(this).is(':checked')) {
                    $.ajax({
                        url: '/clients/promos/confirm',
                        data: {
                            'account_id': {{ account.id }},
                            'promo_id': promo_type,
                            'confirmation_type': confirmation_type
                        },
                        headers: {'X-CSRFToken': csrftoken},
                        type: 'POST',
                        success: function (data) {
                            console.log(data);
                            $(this).prop('disabled', 'disabled');
                        }
                    });
                }

            });

            /**
             * Calendar
             */
            $('#calendar').fullCalendar({
                header: {
                    left: "prev, next, today",
                    center: "title",
                    right: "month, listWeek"
                },
                aspectRatio: 2,
                defaultDate: moment(),
                defaultView: 'month',
                events: [
                    {% for promo in promos %}
                        {
                            title: "{{ promo.name }}",
                            description: "{{ promo.desc }}",
                            start: moment("{{ promo.formatted_start }}"),
                            end: moment("{{ promo.formatted_end }}"),
                            className: "{% if promo.is_active %}m-fc-event--success{% else %}m-fc-event--warning{% endif %}"
                        }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            });

            // New mandate modal controls
            let $mandateType = $('#mandate_type');
            let $mandateHourlyRate = $('#mandate_hourly_rate');
            let $addMemberBtn = $('#add_member_btn');
            let mandateMembersDiv = document.getElementById('mandate_members');

            $mandateType.change(function () {
                let init_hourly_rate = $(this).find(':selected').data('hourly');
                console.log(init_hourly_rate);
                $mandateHourlyRate.val(init_hourly_rate);
            });

            $addMemberBtn.click(function () {
                const memberMandateTemplate = document.getElementById('member_in_mandate_template').content;
                const clone = document.importNode(memberMandateTemplate, true);
                mandateMembersDiv.appendChild(clone);
            });

            // End of new mandate modal controls

            $('.m_datepicker').datepicker({
                todayHighlight: !0,
                autoclose: !0,
                format: 'yyyy-mm-dd',
                orientation: "bottom left",
                templates: {
                    leftArrow: '<i class="la la-angle-left"></i>',
                    rightArrow: '<i class="la la-angle-right"></i>'
                }
            }).on('show.bs.modal', function (event) {
                event.stopPropagation();
            });

            $('.datetimepicker').datetimepicker();


            let distributeHours = function () {
                let hasSeo = {% if account.has_seo %}true{% else %}false{% endif %};
                let seoHours = {{ account.seo_hours|escapejs }};
                let hasCro = {% if account.has_cro %}true{% else %}false{% endif %};
                let croHours = {{ account.cro_hours|escapejs }};
                let totalHours = {{ account.all_hours|escapejs }};
                let ppc_hours = {{ account.ppc_hours|escapejs }};

                // Cms
                let cms = [];
                {% if account.cm1 != None %}cms.push(1);{% endif %}
                {% if account.cm2 != None %}cms.push(2);{% endif %}
                {% if account.cm3 != None %}cms.push(3);{% endif %}
                // Ams
                let ams = [];
                {% if account.am1 != None %}ams.push(1);{% endif %}
                {% if account.am2 != None %}ams.push(2);{% endif %}
                {% if account.am3 != None %}ams.push(3);{% endif %}
                // strats
                let strats = [];
                {% if account.strat1 != None %}strats.push(1);{% endif %}
                {% if account.strat2 != None %}strats.push(2);{% endif %}
                {% if account.strat3 != None %}strats.push(3);{% endif %}
                // seos
                let seos = [];
                {% if account.seo1 != None %}seos.push(1);{% endif %}
                {% if account.seo2 != None %}seos.push(2);{% endif %}
                {% if account.seo3 != None %}seos.push(3);{% endif %}

                /**
                 * Calculate hour percentages
                 */
                let cmPortion = 0.75;
                let amPortion = 0.25;
                let seoPortion = 0.0;

                if (hasSeo || hasCro) {
                    let seoTotalPortion = ((seoHours + croHours) / totalHours);
                    seoPortion = seoTotalPortion * 0.9;
                    let remainingPortion = 1.0 - seoTotalPortion;
                    cmPortion = remainingPortion * 0.75;
                    amPortion = (remainingPortion * 0.25) + (seoPortion * 0.1);
                }

                let eachCm = (100.0 * cmPortion / cms.length).toFixed(2);
                let eachAm = (100.0 * amPortion / ams.length).toFixed(2);
                let eachSeo = (100.0 * seoPortion / seos.length).toFixed(2);

                /**
                 * First set all to 0
                 */
                for (let i = 1; i <= 3; i++) {
                    document.getElementById('cm' + i + '-percent').value = '0.0';
                    document.getElementById('am' + i + '-percent').value = '0.0';
                    document.getElementById('strat' + i + '-percent').value = '0.0';
                    document.getElementById('seo' + i + '-percent').value = '0.0';
                }

                cms.forEach(function (i) {
                    let el = document.getElementById('cm' + i + '-percent').value = eachCm;
                });

                ams.forEach(function (i) {
                    let el = document.getElementById('am' + i + '-percent').value = eachAm;
                });

                seos.forEach(function (i) {
                    let el = document.getElementById('seo' + i + '-percent').value = eachSeo;
                });

            };

            $distrubteHoursBtn.click(distributeHours);
        });

        // for quick-adding hours
        let form = $('#quickadd');
        form.submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/clients/accounts/{{ account.id }}',
                data: form.serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                error: function (jqXHR, error, errorString) {
                    let message = "Error";
                    if (errorString === "Forbidden") {
                        message = "You don't have permission to add hours to this account!";
                    }
                    toastr.error(message);
                    $('#quickAddModal').modal('toggle');
                },
                success: function () {
                    $('#quickAddModal').modal('toggle');
                    toastr.success("Hours submitted successfully!");
                    let assignedMembersDisplay = $('#assigned-members-display');
                    // refresh the team display to update hours
                    assignedMembersDisplay.load(location.href + " #assigned-members-display>*", "");
                }
            });
        });


        // Additional services stuff
        const $ongoingCheck = $('#ongoing_check');
        const $setDurationForm = $('#set_duration_form');
        const $ongoingForm = $('#ongoing_form');
        const $hourlyCheck = $('#hourly_check');

        const $monthlyCost = $('#monthly_cost');
        const $monthlyHours = $('#monthly_hours');

        $ongoingCheck.change(function () {
            if ($(this).is(':checked')) {
                $setDurationForm.hide();
                $ongoingForm.show();
            } else {
                $ongoingForm.hide();
                $setDurationForm.show();
            }
        });

        $hourlyCheck.change(function () {
            if ($(this).is(':checked')) {
                $monthlyCost.prop('disabled', true);
                $monthlyHours.prop('disabled', false);
            } else {
                $monthlyHours.prop('disabled', true);
                $monthlyCost.prop('disabled', false);
            }
        });

    </script>
{% endblock %}
