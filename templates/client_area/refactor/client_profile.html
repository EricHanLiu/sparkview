<!DOCTYPE html>
{% extends 'main_refactor.html' %}
{% load staticfiles %}
{% load template_filters %}
{% load budget_tags %}

{% block extraCss %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
    <link href="{% static 'client_profile.css' %}" type="text/css" rel="stylesheet"/>
    <link href="{% static 'assets/vendors/custom/fullcalendar/fullcalendar.bundle.css' %}" rel="stylesheet"
          type="text/css"/>
    <script defer src="{% static 'assets/vendors/custom/fullcalendar/fullcalendar.bundle.js' %}"></script>
    <script src="{% static 'assets/app/js/moment.js' %}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/css/datepicker.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/js/datepicker.min.js"></script>
    <script defer
            src="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/js/i18n/datepicker.en.min.js"></script>
    <style>
        @media (min-device-width: 1200px) {
            .middle-row .card {
                min-height: 36vh;
            }
        }
    </style>
{% endblock %}

{% block main_body %}
    {% if account.has_blacklisted_accounts %}
        <article class="message is-danger">
            <div class="message-body">
                <strong>Warning!</strong> One or more of the ad accounts associated with this account are
                blacklisted. They are not retrieving any new spend information.
                <button class="delete" style="float:right;"></button>
            </div>
        </article>
    {% endif %}
    {% if account.status == 2 %}
        <article class="message is-warning">
            <div class="message-body">
                <strong>Heads Up!</strong> This account is inactive. The reason
                is {{ account.get_inactive_reason_display }}. {% if account.inactive_return_date != None %}It is
                supposed to return on {{ account.inactive_return_date|just_date }}{% endif %}
                <button class="delete" style="float:right;"></button>
            </div>
        </article>
    {% endif %}
    {% if account.status == 3 %}
        <article class="message is-danger">
            <div class="message-body">
                <strong>Warning!</strong> This account is lost. The reason
                is {{ account.get_lost_reason_display }}.
                <button class="delete" style="float:right;"></button>
            </div>
        </article>
    {% endif %}
    {% if account.status == 0 %}
        <article class="message is-info">
            <div class="message-body">
                <strong>Notice:</strong> This account is in the onboarding phase. Go
                <a href="/clients/accounts/onboard/{{ account.id }}">here</a> to view the
                progress.
                <button class="delete" style="float:right;"></button>
            </div>
        </article>
        {% if account.is_late_to_onboard %}
            <article class="message is-info">
                <div class="message-body">
                    <strong>Warning!</strong> This account is late to onboard.
                    It has been in the onboarding phase for {{ account.onboarding_duration_elapsed }} days.
                    {% if account.late_onboard_reason != None and account.late_onboard_reason != '' %}
                        The reason is {{ account.late_onboard_reason }}.
                    {% endif %}
                    <button class="delete" style="float:right;"></button>
                </div>
            </article>
        {% endif %}
    {% endif %}
    <div class="columns">
        <div class="column is-8">
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <div class="title is-4">
                            {{ account.client_name }}
                        </div>
                    </div>
                    <div class="level-item">
                        <a class="button is-rounded is-small button-color"
                           href="/clients/accounts/{{ account.id }}/old">Old View</a>
                    </div>
                    <div class="level-item">
                        <a class="button is-rounded is-small button-color"
                           href="/clients/accounts/{{ account.id }}/lifecycle">
                            Lifecycle
                        </a>
                    </div>
                    <div class="level-item">
                        <a class="button is-rounded is-small button-color" id="quick_add_button">
                            Add Hours
                        </a>
                    </div>
                    <div class="level-item">
                        <a class="button is-rounded is-small button-color" id="flag_account_button">
                            Flag Account
                        </a>
                    </div>
                    <div class="level-item">
                        <a class="button is-rounded is-small button-color"
                           id="assign_members_button">Team</a>
                    </div>
                </div>
            </div>
            <div class="columns is-multiline" style="margin-top: 1em;">
                {% for role, assigned_member in account.assigned_members.items %}
                    {% if role != 'Sold by' %}
                        <div class="column is-2">
                            <div class="card has-background-light member-card">
                                <div class="has-text-centered">
                                    <img {% if assigned_member.member.image != None %}src="{% static 'img/bloomers/'|add:assigned_member.member.image %}"
                                         {% else %}src="{% static 'assets/app/media/img/user4.jpg' %}"{% endif %}width="75%"/>
                                </div>
                                <div class="card-content" style="margin-top: 1em; position: relative;">
                                    <div class="media">
                                        <div class="media-content">
                                            <div class="tag member-role-tag is-rounded {% if 'CM' in role %}cm-color
                                            {% elif 'AM' in role %}am-color{% elif 'SEO' in role %}seo-color{% else %}
                                            strat-color{% endif %}">
                                                {{ role }}
                                            </div>
                                            <p class="title is-6 has-text-centered" style="margin-top: 0.5em;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ assigned_member.member.id }}">
                                                        {{ assigned_member.member.user.get_full_name }}
                                                    </a>
                                                {% else %}
                                                    {{ assigned_member.member.user.get_full_name }}
                                                {% endif %}
                                            </p>
                                            <p class="subtitle is-6 has-text-centered">
                                                {{ assigned_member.member|get_hours_per_member_and_account:account.id }}hr
                                                / {{ account|get_allocation_this_month_member:assigned_member.member }}hr
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                {% for backup in backups %}
                    {% for member in backup.members.all %}
                        <div class="column is-2">
                            <div class="card has-background-light member-card">
                                <div class="has-text-centered">
                                    <img {% if member.image != None %}src="{% static 'img/bloomers/'|add:member.image %}"
                                         {% else %}src="{% static 'assets/app/media/img/user4.jpg' %}"{% endif %}width="75%"/>
                                </div>
                                <div class="card-content" style="margin-top: 1em; position: relative;">
                                    <div class="media">
                                        <div class="media-content">
                                            <div class="tag member-role-tag is-rounded backup-color">
                                                Backup
                                            </div>
                                            <p class="title is-6 has-text-centered" style="margin-top: 0.5em;">
                                                {% if request.user.is_staff %}
                                                    <a href="/user_management/members/{{ member.id }}">
                                                        {{ member.user.get_full_name }}
                                                    </a>
                                                {% else %}
                                                    {{ member.user.get_full_name }}
                                                {% endif %}
                                            </p>
                                            <p class="subtitle is-6 has-text-centered">
                                                {{ member|get_hours_per_member_and_account:account.id }}hr
                                                / {{ account|get_allocation_this_month_backup_member:member }}hr
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
        <div class="column is-4">
            <div class="card page-card" id="contact_details_card">
                <div class="card-content">
                    <div class="level">
                        <div class="level-left">
                            <h5 class="title is-5">
                                Client Details
                            </h5>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button class="button is-rounded is-small button-color" id="management_button">
                                    Management
                                </button>
                            </div>
                            <div class="level-item">
                                <button class="button is-rounded is-small button-color" id="contact_details_button">
                                    View More
                                </button>
                            </div>
                        </div>
                    </div>
                    <table>
                        <tr>
                            <td>
                                <p class="title is-6" style="padding-right: 1.5em;">Name:</p>
                                {{ account.contactInfo.all.0.name }}
                            </td>
                            <td>
                                <p class="title is-6">Phone:</p>
                                {{ account.contactInfo.all.0.phone }}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-top: 1.5em; padding-right: 1.5em;">
                                <p class="title is-6">Email:</p>
                                {{ account.contactInfo.all.0.email }}
                            </td>
                            <td style="padding-top: 1.5em;">
                                <p class="title is-6">Industry:</p>
                                {{ account.industry }}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="columns middle-row">
        <div class="column is-5">
            <div class="card page-card" id="services_card">
                <div class="card-content">
                    <div class="level">
                        <div class="level-left">
                            <h5 class="title is-5">Services</h5>
                        </div>
                        <div class="level-right">
                            <button class="button level-item is-rounded is-small button-color"
                                    id="update_services_button">
                                Update Services
                            </button>
                            <button class="button level-item is-rounded is-small button-color"
                                    id="new_opportunity_button">
                                New Opportunity
                            </button>
                            <button class="button is-rounded is-small button-color"
                                    id="new_mandate_button">
                                New Mandate
                            </button>
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column is-4">
                            <div class="box">
                                <div class="icon">
                                    <i class="fas fa-circle {% if account.sales_profile.ppc_status == 1 %}
                                        has-text-success{% elif account.sales_profile.ppc_status == 0 %}has-text-info
                                        {% elif account.sales_profile.ppc_status == 2 %}has-text-warning
                                        {% elif account.sales_profile.ppc_status == 6 %}has-text-grey
                                        {% else %}has-text-danger{% endif %}"></i>
                                </div>
                                PPC
                                <p class="has-text-grey">
                                    {{ account.sales_profile.get_ppc_status_display }}
                                </p>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="box">
                                <div class="icon">
                                    <i class="fas fa-circle {% if account.sales_profile.seo_status == 1 %}
                                        has-text-success{% elif account.sales_profile.seo_status == 0 %}has-text-info
                                        {% elif account.sales_profile.seo_status == 2 %}has-text-warning
                                        {% elif account.sales_profile.seo_status == 6 %}has-text-grey
                                        {% else %}has-text-danger{% endif %}"></i>
                                </div>
                                SEO
                                <p class="has-text-grey">
                                    {{ account.sales_profile.get_seo_status_display }}
                                </p>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="box">
                                <div class="icon">
                                    <i class="fas fa-circle {% if account.sales_profile.cro_status == 1 %}
                                        has-text-success{% elif account.sales_profile.cro_status == 0 %}has-text-info
                                        {% elif account.sales_profile.cro_status == 2 %}has-text-warning
                                        {% elif account.sales_profile.cro_status == 6 %}has-text-grey
                                        {% else %}has-text-danger{% endif %}"></i>
                                </div>
                                CRO
                                <p class="has-text-grey">
                                    {{ account.sales_profile.get_cro_status_display }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% if account.active_mandates.count > 0 %}
                        <table class="table is-hoverable" id="services_table">
                            <tr style="white-space: nowrap;">
                                <th>
                                    Type
                                </th>
                                <th>
                                    Cost
                                </th>
                                <th>
                                    End Date
                                </th>
                                <th>
                                    Members
                                </th>
                                <th>Hours</th>
                                <th></th>
                            </tr>
                            <tbody>
                            {% for mandate in account.active_mandates %}
                                <tr>
                                    <td>
                                        {{ mandate.mandate_type }}
                                    </td>
                                    <td style="white-space: nowrap;">
                                        {{ mandate.calculated_cost }}
                                    </td>
                                    <td style="white-space: nowrap;">
                                        {{ mandate.end_date_pretty }}
                                    </td>
                                    <td>
                                        {% for assignment in mandate.mandateassignment_set.all %}
                                            {{ assignment.member }}{% if not forloop.last %},{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td style="white-space: nowrap;">
                                        {{ mandate.hours_worked_this_month|floatformat:2 }}
                                        / {{ mandate.allocated_hours_this_month|floatformat:2 }}
                                    </td>
                                    <td>
                                        <button class="button is-small is-rounded delete-mandate-btn"
                                                data-mandate-id="{{ mandate.id }}"
                                                data-mandate-name="{{ mandate.name }}">
                                            <i class="fas fa-trash has-text-danger"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="column is-3">
            <div class="card page-card">
                <div class="card-content">
                    <h5 class="title is-5">Monthly Hours Information</h5>
                    <div class="progress-wrapper">
                        <progress class="progress custom-progress-color is-large"
                                  value="{{ account.hoursWorkedThisMonth }}"
                                  max="{{ account.allocated_hours_including_mandate }}" style="height: 4em;"></progress>
                        <div class="progress-value" style="color: white;">
                            {{ account.hoursWorkedThisMonth|floatformat:1 }}
                            / {{ account.allocated_hours_including_mandate|floatformat:1 }}
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column is-6 has-text-centered">
                            <div style="margin-top: 0.5em;">
                                <p class="heading">Allocated Hours</p>
                                <p class="title">{{ account.allocated_hours_including_mandate|floatformat }}</p>
                            </div>
                            <div style="margin-top: 1em;">
                                <p class="heading">Actual Hours</p>
                                <p class="title">{{ account.hoursWorkedThisMonth|floatformat:1 }}</p>
                            </div>
                        </div>
                        <div class="column is-6 has-text-centered">
                            <div style="margin-top: 0.5em;">
                                <p class="heading">Fallback Hours</p>
                                <p class="title">{{ account.fallback_hours|floatformat:1 }}</p>
                            </div>
                            <div style="margin-top: 1em;">
                                <p class="heading">Remaining Hours</p>
                                <p class="title">{{ account.hoursRemainingMonth|floatformat:1 }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="card page-card">
                <div class="card-content">
                    <div class="level">
                        <div class="level-left">
                            <h5 class="title is-5">Promos</h5>
                        </div>
                        <div class="level-right">
                            <button class="button level-item is-rounded is-small button-color"
                                    id="add_promo_button">
                                Add Promo
                            </button>
                            <button class="button level-item is-rounded is-small button-color"
                                    id="edit_promos_button">
                                Edit Promos
                            </button>
                            <button class="button level-item is-rounded is-small button-color"
                                    id="view_calendar_button">
                                View Calendar
                            </button>
                        </div>
                    </div>
                    <div style="max-height: 25vh; overflow-y: auto; overflow-x: hidden;" id="promos_list">
                        {% for promo in promos %}
                            <div class="columns">
                                <div class="column is-8">
                                    {{ promo }}
                                    <p style="margin-top: 0.5em;">
                                        {% if promo.confirmed_started %}
                                            End Date: {{ promo.end_date }}
                                        {% else %}
                                            Start Date: {{ promo.start_date }}
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="column is-4">
                                    {% if promo.confirmed_started and not promo.confirmed_ended %}
                                        <button class="button is-rounded button-color-3 is-fullwidth confirm-promo"
                                                data-promo-id="{{ promo.id }}" data-confirmation-type="1">
                                            Confirm Ended
                                        </button>
                                    {% elif promo.confirmed_ended %}
                                        <button class="button is-fullwidth is-rounded is-fullwidth" disabled>
                                            Promo Ended
                                        </button>
                                    {% else %}
                                        <button class="button is-rounded button-color-2 is-fullwidth confirm-promo"
                                                data-promo-id="{{ promo.id }}" data-confirmation-type="0">
                                            Confirm Started
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% if not forloop.last %}
                                <hr>{% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column">
            <div class="card page-card">
                <div class="card-content">
                    <div class="level">
                        <div class="level-left">
                            <h5 class="title is-5">Budgets</h5>
                        </div>
                        <div class="level-right">
                            {% if account.budget_updated_this_month %}
                                {% for additional_fee in account.additional_fee_objects_this_month %}
                                    <div class="level-item">
                                        <button class="button is-small is-rounded button-color-4 edit-additional-fee-button"
                                                data-id="{{ additional_fee.id }}" data-name="{{ additional_fee.name }}"
                                                data-fee="{{ additional_fee.fee }}"
                                                data-month="{{ additional_fee.month }}"
                                                data-year="{{ additional_fee.year }}">
                                            Additional Fee {{ additional_fee.name }}: ${{ additional_fee.fee }}
                                        </button>
                                    </div>
                                {% endfor %}
                                <div class="level-item">
                                    <button class="button button-color-4 is-rounded is-small"
                                            id="additional_fee_button">
                                        Add Additional Fee
                                    </button>
                                </div>
                                <div class="level-item">
                                    <button class="button is-small is-rounded button-color-2"
                                            id="overall_budget_button">
                                        <strong>
                                            <span style="margin: 0 0.5em;">AdWords: ${{ account.aw_budget }}</span>
                                            <span style="margin: 0 0.5em;">Facebook: ${{ account.fb_budget }}</span>
                                            <span style="margin: 0 0.5em;">Bing: ${{ account.bing_budget }}</span>
                                            <span style="margin: 0 0.5em;">Flex: ${{ account.flex_budget }}</span>
                                        </strong>
                                    </button>
                                </div>
                            {% else %}
                                <button class="button is-rounded button-color is-fullwidth is-small"
                                        id="renew_overall_budget_button">
                                    Renew Overall Budget
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <div class="columns">
                                <div class="column is-7">
                                    <div id="meta" class="field is-grouped is-grouped-multiline subtitle">
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small">Status</span>
                                                <p class="tag {{ account_status_class }} is-small">{{ account.get_status_display }}</p>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                    <span class="tag is-small {% if account.adwords.all %}is-success{% endif %}">
                                        Google Ads
                                    </span>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                    <span class="tag is-small {% if account.facebook.all %}is-success{% endif %}">
                                        Facebook Ads
                                    </span>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                    <span class="tag is-small {% if account.bing.all %}is-success{% endif %}">
                                        Bing Ads
                                    </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-5 has-text-right">
                                    <button class="button button-color is-rounded is-small" id="ga_btn">
                                        Google Analytics
                                    </button>
                                    <button class="button button-color is-rounded is-small" id="sources_btn">
                                        Pull Sources
                                    </button>
                                    <button class="button button-color is-rounded is-small" id="exclusion_btn"
                                            onclick="manualCampaigns('exclude_campaigns_select')">Master Exclusion
                                    </button>
                                    <button class="button button-color is-rounded is-small" id="add_budget_btn">
                                        Add Budget
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br/>
                    {% if account.default_budget is not None %}

                        <div class="card" style="position: relative;">
                            <header class="card-header">
                                <p class="card-header-title">
                                    <span class="tooltip" data-tooltip="{{ account.default_budget.id }}">{{ account.default_budget.name }}&nbsp;</span>
                                    - {{ account.default_budget.description }}
                                    {% if account.default_budget.is_new %}&nbsp;
                                        <span class="tag is-warning">This budget is still new, please check back in about an hour</span>
                                    {% endif %}
                                </p>
                                <span class="card-header-icon">
                                    <div id="meta" class="field is-grouped is-grouped-multiline subtitle">
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small {% if account.default_budget.has_adwords %}is-success{% endif %}">
                                                    Google
                                                </span>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small {% if account.default_budget.has_facebook %}is-success{% endif %}">
                                                    FB
                                                </span>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small {% if account.default_budget.has_bing %}is-success{% endif %}">
                                                    Bing
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    &nbsp;&nbsp;
                                    {% if account.default_budget.is_monthly %}
                                        Monthly Budget - <span class="budget-date" style="margin-left: 0.3em;"></span>
                                    {% else %}
                                        Flight Dates: {{ account.default_budget.pretty_dates }}
                                    {% endif %}
                                </span>
                            </header>
                            <div class="card-content">
                                <div class="columns">
                                    <div class="column is-2">
                                        Spend: <strong>{{ account.default_budget.calculated_spend|currency }}</strong>
                                    </div>
                                    <div class="column is-2">
                                        Budget: <strong>{{ account.default_budget.budget|currency }}</strong>
                                    </div>
                                    <div class="column is-2">
                                        Average: <strong>{{ account.default_budget.average_spend_yest|currency }}</strong>
                                    </div>
                                    <div class="column is-2">
                                        Rec Daily Spend: <strong>{{ account.default_budget.rec_spend_yest|currency }}</strong>
                                    </div>
                                    <div class="column is-2">
                                        Yesterday Spend: <strong>{{ account.default_budget.yesterday_spend|currency }}</strong>
                                    </div>
                                    <div class="column is-2">
                                        Projected Spend: <strong>{{ account.default_budget.projected_spend_avg|currency }}</strong>
                                    </div>
                                </div>
                                <div class="columns">
                                    <div class="column is-12">
                                        <div class="progress-wrapper">
                                            <progress
                                                    class="progress is-large {% if account.default_budget.underpacing_average %}is-warning{% elif account.default_budget.overpacing_average %}is-danger{% else %}is-success{% endif %}"
                                                    max="100"
                                                    value="{{ account.default_budget.spend_percentage }}">
                                            </progress>
                                            <div class="progress-value">
                                                {{ account.default_budget.spend_percentage|floatformat:2 }}%
                                            </div>
                                            <div class="budget-pacer" data-is-monthly="{{ account.default_budget.is_monthly }}"
                                                 data-start-date="{{ account.default_budget.start_date }}"
                                                 data-end-date="{{ account.default_budget.end_date }}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="level">
                                    <a class="button is-small is-info is-outlined campaigns_in_group_link"
                                       data-budget-id="{{ account.default_budget.id }}">
                                        Campaigns in group
                                    </a>
                                </div>
                            </div>
                            {% if account.default_budget.is_monthly and account.default_budget.needs_renewing %}
                                <div class="budget-renewal-overlay" style="background-color: lightgrey; opacity: 0.95;">
                                    <div class="has-text-centered" style="margin-top: 7em;">
                                        <p>A new month has started, and this budget is
                                            <strong>{{ account.default_budget.budget|currency }}</strong>. Would you like to renew it?
                                        </p>
                                        <button class="button is-rounded is-small" style="margin-top: 1em;"
                                                id="renew_monthly_budget_button" data-budget-id="{{ account.default_budget.id }}">
                                            Renew
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <br/>
                    {% endif %}
                    {% for budget in account.budgets %}
                        <div class="card" style="position: relative;">
                            <header class="card-header">
                                <p class="card-header-title">
                                    <span class="tooltip" data-tooltip="{{ budget.id }}">{{ budget.name }}&nbsp;</span>
                                    - {{ budget.description }}
                                    {% if budget.is_new %}&nbsp;
                                        <span class="tag is-warning">This budget is still new, please check back in about an hour</span>
                                    {% endif %}
                                    &nbsp;
                                    <button class="button is-outlined is-small edit-budget-btn"
                                            data-budget-id="{{ budget.id }}"
                                            data-budget-name="{{ budget.name }}">Edit
                                    </button>
                                    &nbsp;
                                    <button class="button is-danger is-outlined is-small delete-budget-btn"
                                            data-budget-id="{{ budget.id }}" data-budget-name="{{ budget.name }}">Delete
                                    </button>
                                </p>
                                <span class="card-header-icon">
                                    <div id="meta" class="field is-grouped is-grouped-multiline subtitle">
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small {% if budget.has_adwords %}is-success{% endif %}">
                                                    Google
                                                </span>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small {% if budget.has_facebook %}is-success{% endif %}">
                                                    FB
                                                </span>
                                            </div>
                                        </div>
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag is-small {% if budget.has_bing %}is-success{% endif %}">
                                                    Bing
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    &nbsp;&nbsp;
                                    {% if budget.is_monthly %}
                                        Monthly Budget - <span class="budget-date" style="margin-left: 0.3em;"></span>
                                    {% else %}
                                        Flight Dates: {{ budget.pretty_dates }}
                                    {% endif %}
                                </span>
                            </header>
                            <div class="card-content">
                                <div class="columns">
                                    <div class="column is-2">
                                        Spend: {{ budget.calculated_spend|currency }}
                                    </div>
                                    <div class="column is-2">
                                        Budget: {{ budget.budget|currency }}
                                    </div>
                                    <div class="column is-2">
                                        Average: {{ budget.average_spend_yest|currency }}
                                    </div>
                                    <div class="column is-2">
                                        Rec Daily Spend: {{ budget.rec_spend_yest|currency }}
                                    </div>
                                    <div class="column is-2">
                                        Yesterday Spend: {{ budget.yesterday_spend|currency }}
                                    </div>
                                    <div class="column is-2">
                                        Projected Spend: {{ budget.projected_spend_avg|currency }}
                                    </div>
                                </div>
                                <div class="columns">
                                    <div class="column is-12">
                                        <div class="progress-wrapper">
                                            <progress
                                                    class="progress is-large {% if budget.underpacing_average %}is-warning{% elif budget.overpacing_average %}is-danger{% else %}is-success{% endif %}"
                                                    max="100"
                                                    value="{{ budget.spend_percentage }}">
                                            </progress>
                                            <div class="progress-value">
                                                {{ budget.spend_percentage|floatformat:2 }}%
                                            </div>
                                            <div class="budget-pacer" data-is-monthly="{{ budget.is_monthly }}"
                                                 data-start-date="{{ budget.start_date }}"
                                                 data-end-date="{{ budget.end_date }}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="level">
                                    <a class="button is-small is-info is-outlined campaigns_in_group_link"
                                       data-budget-id="{{ budget.id }}">
                                        Campaigns in group
                                    </a>
                                </div>
                            </div>
                            {% if budget.is_monthly and budget.needs_renewing %}
                                <div class="budget-renewal-overlay" style="background-color: lightgrey; opacity: 0.95;">
                                    <div class="has-text-centered" style="margin-top: 7em;">
                                        <p>A new month has started, and this budget is
                                            {{ budget.budget|currency }}. Would you like to renew it?
                                        </p>
                                        <button class="button is-rounded is-small" style="margin-top: 1em;"
                                                id="renew_monthly_budget_button" data-budget-id="{{ budget.id }}">
                                            Renew
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        {% if not forloop.last %}
                            <br/>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal modal-fx-fadeInScale" id="flag_account_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Flag Account</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="flag_account_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form id="flag_account_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <input name="flagged" type="text" value="False" style="display: none;"/>
                    <div class="columns">
                        <div class="column is-6">
                            <button type="button"
                                    class="button is-fullwidth is-success {% if account.star_flag %}is-outlined{% endif %}"
                                    id="good_account_toggle_button">
                                Account Is Good
                            </button>
                        </div>
                        <div class="column is-6">
                            <button type="button" id="flag_account_toggle_button"
                                    class="button is-fullwidth is-danger {% if not account.star_flag %}is-outlined{% endif %}">
                                Flag Account
                            </button>
                        </div>
                    </div>
                    <div class="columns" id="bc_link_row">
                        <div class="column">
                            <label class="label">Basecamp Link</label>
                            <input type="text" name="bc_link" id="bc_link" class="input" maxlength="140"
                                   value="{{ account.flagged_bc_link }}" {% if account.star_flag %}required{% endif %}/>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="renew_overall_budget_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Renew Overall Budget</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="renew_overall_budget_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <div class="level">You will renew the following budget structure - make any necessary changes.</div>
                <form id="renew_overall_budget_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns">
                        <div class="column is-3">
                            <label class="label">AdWords</label>
                            <input class="input is-fullwidth" name="aw_budget" type="text"
                                   value="{{ account.aw_budget }}"/>
                        </div>
                        <div class="column is-3">
                            <label class="label">Facebook</label>
                            <input class="input is-fullwidth" name="fb_budget" type="text"
                                   value="{{ account.fb_budget }}"/>
                        </div>
                        <div class="column is-3">
                            <label class="label">Bing</label>
                            <input class="input is-fullwidth" name="bing_budget" type="text"
                                   value="{{ account.bing_budget }}"/>
                        </div>
                        <div class="column is-3">
                            <label class="label">Flex</label>
                            <input class="input is-fullwidth" name="flex_budget" type="text"
                                   value="{{ account.flex_budget }}"/>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="quick_add_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Quick Add Hours</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="quick_add_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form id="quick_add_form">
                    <div class="columns">
                        <div class="column">
                            <label>Hours:</label>
                            <input type="text" name="quick_add_hours"
                                   class="input" required>
                        </div>
                        <div class="column">
                            <label>Month:</label>
                            <div class="select is-fullwidth">
                                <select name="quick_add_month" required>
                                    {% for monthNum, monthName in months %}
                                        <option value="{{ monthNum }}"
                                                {% if monthnow|add:"0" == monthNum|add:"0" %}selected{% endif %}>
                                            {{ monthName }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column">
                            <label>Year:</label>
                            <div class="select is-fullwidth">
                                <select name="quick_add_year" required>
                                    {% for year in years %}
                                        <option value="{{ year }}"
                                                {% if year == current_year %}selected{% endif %}>
                                            {{ year }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="management_modal">
        <div class="modal-background"></div>
        <div class="modal-content" style="width: 50vw;">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Management</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="management_confirm_button">
                            Save Changes
                        </button>
                    </div>
                </div>
                <form id="management_form">
                    <input class="is-hidden" value="{{ account.id }}" name="account_id"/>
                    <div class="field">
                        <div class="columns">
                            <div class="column">
                                <div class="control">
                                    <label class="label">SEO Hours</label>
                                    <input class="input is-fullwidth" name="seo_hours" value="{{ account.seo_hours }}">
                                </div>
                            </div>
                            <div class="column">
                                <div class="control">
                                    <label class="label">CRO Hours</label>
                                    <input class="input is-fullwidth" name="cro_hours" value="{{ account.cro_hours }}">
                                </div>
                            </div>
                            <div class="column">
                                <div class="control">
                                    <label class="label">Account Status</label>
                                    <div class="select is-fullwidth">
                                        <select name="account_status" id="account_status_select">
                                            <option value="0" {% if account.status == 0 %}selected{% endif %}>
                                                Onboarding
                                            </option>
                                            <option value="1" {% if account.status == 1 %}selected{% endif %}>Active
                                            </option>
                                            <option value="2" {% if account.status == 2 %}selected{% endif %}>Inactive
                                            </option>
                                            <option value="3" {% if account.status == 3 %}selected{% endif %}>Lost
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <div class="columns" id="account_status_row" style="display: none;">
                            <div class="column">
                                <label class="label">Inactive Reason</label>
                                <div class="select is-fullwidth">
                                    <select name="account_inactive_reason" id="account_inactive_reason" disabled>
                                        <option value="0" selected>None</option>
                                        {% for num, name in inactive_reasons %}
                                            <option value="{{ num }}"
                                                    {% if num == account.inactive_reason %}selected{% endif %}>
                                                {{ name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="column">
                                <label class="label">Returning From Inactive (If Applicable)</label>
                                <input type="text" class="input datepicker-here" placeholder="Set return date here"
                                       name="account_inactive_return" id="account_inactive_return" disabled
                                       data-language="en" value="{{ account.inactive_return_date|date:'m/d/Y' }}">
                            </div>
                            <div class="column">
                                <label class="label">Reason Lost</label>
                                <div class="select is-fullwidth">
                                    <select name="account_lost_reason" id="account_lost_reason" disabled>
                                        <option value="0" selected>None</option>
                                        {% for num, name in lost_reasons %}
                                            <option value="{{ num }}"
                                                    {% if num == account.lost_reason %}selected{% endif %}>
                                                {{ name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if request.user.is_staff %}
                        <div class="field">
                            <div class="columns">
                                <div class="column">
                                    <label class="label">Management Fee Override</label>
                                    <input type="text" name="fee_override" class="input"
                                           value="{{ account.management_fee_override }}">
                                </div>
                                <div class="column">
                                    <label class="label">Allocated PPC Hours Override</label>
                                    <input type="text" name="hours_override" class="input"
                                           value="{{ account.allocated_ppc_override }}">
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    <div class="level" style="margin-top: 2em;">
                        <div class="level-left">
                            <div class="level-item">
                                <h5 class="title is-5">
                                    Existing Fee Structure - {{ account.managementFee.name }}
                                </h5>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <h6 class="subtitle is-6">Setup Fee: {{ account.managementFee.initialFee }}</h6>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            {% if account.management_fee_override != None and account.management_fee_override != 0.0 %}
                                <p>Manual Override: ${{ account.management_fee_override }}</p>
                            {% else %}
                                <table class='table is-hoverable is-striped is-fullwidth is-bordered'>
                                    <thead>
                                    <tr>
                                        <th>
                                            Monthly Media Spend
                                        </th>
                                        <th>
                                            Monthly Fee
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for interval in account.managementFee.feeStructure.all %}
                                        <tr>
                                            <td>
                                                ${{ interval.lowerBound }} - ${{ interval.upperBound }}
                                            </td>
                                            <td>
                                                {% if interval.feeStyle == 1 %}$
                                                    {{ interval.fee|format_money }}{% endif %}
                                                {% if interval.feeStyle == 0 %}{{ interval.fee }}%{% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>
                    {% if request.user.is_staff %}
                        <input type="text" value="1" id="fee_structure_type" name="fee_structure_type"
                               style="display:none;"/>
                        <div id="create_new_fee_structure">
                            <div class="level" style="margin-top: 2em;">
                                <div class="level-left"><h5 class="title is-5">
                                    Edit Management Fee Structure
                                </h5></div>
                                <div class="level-right">
                                    <button type="button" class="button is-small is-rounded"
                                            id="use_existing_fee_structure_button">
                                        Use Existing
                                    </button>
                                </div>
                            </div>
                            <div id="management_fee_form">
                                <input style="display:none;" value="1" id="row_num_input" name="row_num_input"/>
                                <div class="columns">
                                    <div class="column is-6">
                                        <label class="label">Name:</label>
                                        <input class="input" name="fee_structure_name"/>
                                    </div>
                                    <div class="column is-6">
                                        <label class="label">Setup Fee:</label>
                                        <input class="input" name="setup_fee"/>
                                    </div>
                                </div>
                                <hr/>
                                <div class="columns">
                                    <div class="column is-3">
                                        <label class="label">Low Budget Bound ($):</label>
                                        <input class="input" name="low-bound1"/>
                                    </div>
                                    <div class="column is-3">
                                        <label class="label">High Budget Bound ($):</label>
                                        <input class="input" name="high-bound1"/>
                                    </div>
                                    <div class="column is-2">
                                        <label class="label">Fee type:</label>
                                        <select class="input"
                                                name="fee-type1"
                                                style="width: 100%;">
                                            <option value="0">%</option>
                                            <option value="1">$</option>
                                        </select>
                                    </div>
                                    <div class="column is-2">
                                        <label class="label">Fee:</label>
                                        <input class="input" name="fee1"/>
                                    </div>
                                    <div class="column is-2">
                                        <label class="label">Add Level</label>
                                        <button type="button" name="button"
                                                class="button is-small is-rounded add-fee-level-button">
                                            Add Level
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="use_existing_fee_structure" style="display:none;">
                            <div class="level">
                                <div class="level-left"><h5 class="title is-5">Edit Management Fee Structure</h5></div>
                                <div class="level-right">
                                    <button type="button" class="button is-small is-rounded"
                                            id="create_new_fee_structure_button">Create New
                                    </button>
                                </div>
                            </div>
                            <div id="management_fee_select">
                                <div class="columns">
                                    <div class="column is-12">
                                        <label class="label">Management Fee Structure:</label>
                                        <div class="select is-fullwidth">
                                            <select name="existing_structure" id="existing_structure"
                                                    style="width: 100%;"
                                                    required>
                                                <option value="0">
                                                    None
                                                </option>
                                                {% for fee_structure in management_fee_structures %}
                                                    <option value="{{ fee_structure.id }}">{{ fee_structure.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div id="preset_mf" style="display:none;">
                                            <hr/>
                                            <h6 class="title is-6">
                                                Setup Fee: $<span id="setup_fee_preset"></span>
                                            </h6>
                                            <table class="table is-striped is-hoverable is-bordered">
                                                <thead>
                                                <tr>
                                                    <th>
                                                        Monthly Media Spend
                                                    </th>
                                                    <th>
                                                        Monthly Fee
                                                    </th>
                                                </tr>
                                                </thead>
                                                <tbody id="preset_mf_tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="contact_details_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Client Details</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="update_client_details_button">
                            Save Changes
                        </button>
                    </div>
                </div>
                <form id="client_details_form">
                    <input class="is-hidden" value="{{ account.id }}" name="account_id"/>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Account Name</button>
                        <div class="control is-expanded">
                            <input class="input" type="text" name="account_name"
                                   value="{{ account.client_name }}">
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Basecamp Link</button>
                        <div class="control is-expanded">
                            <input class="input" type="text" name="bc_link"
                                   value="{{ account.bc_link }}">
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Client Description</button>
                        <div class="control is-expanded">
                            <input class="input" type="text" name="description"
                                   value="{{ account.description }}">
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Client Notes</button>
                        <div class="control is-expanded">
                            <input class="input" type="text" name="notes"
                                   value="{{ account.notes }}">
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">URL</button>
                        <div class="control is-expanded">
                            <input class="input" type="text" name="url"
                                   value="{{ account.url }}">
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Tier</button>
                        <div class="control is-expanded">
                            <input class="input" type="text" disabled style="pointer-events: none;"
                                   value="{{ account.tier }}">
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">
                            Contact Name{% if account.contactInfo.all.count > 1 %}s{% endif %}
                        </button>
                        <div class="control is-expanded">
                            {% for clientContact in account.contactInfo.all %}
                                <input class="input" type="text" name="contact_names"
                                       value="{{ clientContact.name }}">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">
                            Contact Email{% if account.contactInfo.all.count > 1 %}s{% endif %}
                        </button>
                        <div class="control is-expanded">
                            {% for clientContact in account.contactInfo.all %}
                                <input class="input" type="text" name="contact_emails"
                                       value="{{ clientContact.email }}">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">
                            Contact Phone{% if account.contactInfo.all.count > 1 %}s{% endif %}
                        </button>
                        <div class="control is-expanded">
                            {% for clientContact in account.contactInfo.all %}
                                <input class="input" type="text" name="contact_phones"
                                       value="{{ clientContact.phone }}">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Industry</button>
                        <div class="control is-expanded">
                            <div class="select is-fullwidth">
                                <select id="select_industries" name="industry">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Team</button>
                        <div class="control is-expanded">
                            <div class="select is-multiple is-fullwidth">
                                <select multiple class="selectable-details" id="select_teams" name="teams">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Platforms</button>
                        <div class="control is-expanded">
                            <div class="select is-multiple is-fullwidth">
                                <select multiple class="set-details" name="platforms" disabled>
                                    <option value="Adwords"
                                            {% if account.aw_budget != 0.0 %}selected{% endif %}>
                                        Adwords
                                    </option>
                                    <option value="Bing"
                                            {% if account.bing_budget != 0.0 %}selected{% endif %}>
                                        Bing
                                    </option>
                                    <option value="Facebook"
                                            {% if account.fb_budget != 0.0 %}selected{% endif %}>
                                        Facebook
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field has-addons">
                        <button class="button is-static" type="button">Services</button>
                        <div class="control is-expanded">
                            <div class="select is-multiple is-fullwidth">
                                <select multiple class="set-details" name="services" disabled>
                                    <option value="SEO" {% if account.has_seo %}selected{% endif %}>
                                        SEO
                                    </option>
                                    <option value="CRO" {% if account.has_cro %}selected{% endif %}>
                                        CRO
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="overall_budget_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Overall Budget</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="overall_budget_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form id="overall_budget_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns">
                        <div class="column is-3">
                            <label class="label">AdWords</label>
                            <input class="input is-fullwidth" name="aw_budget" type="text"
                                   value="{{ account.aw_budget }}"/>
                        </div>
                        <div class="column is-3">
                            <label class="label">Facebook</label>
                            <input class="input is-fullwidth" name="fb_budget" type="text"
                                   value="{{ account.fb_budget }}"/>
                        </div>
                        <div class="column is-3">
                            <label class="label">Bing</label>
                            <input class="input is-fullwidth" name="bing_budget" type="text"
                                   value="{{ account.bing_budget }}"/>
                        </div>
                        <div class="column is-3">
                            <label class="label">Flex</label>
                            <input class="input is-fullwidth" name="flex_budget" type="text"
                                   value="{{ account.flex_budget }}"/>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="additional_fee_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Add Additional Fee</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="add_additional_fee_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form id="additional_fee_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns is-multiline">
                        <div class="column is-6">
                            <label class="label">Name</label>
                            <input class="input is-fullwidth" name="name" type="text"/>
                        </div>
                        <div class="column is-6">
                            <label class="label">Fee</label>
                            <input class="input is-fullwidth" name="fee" type="text"/>
                        </div>
                        <div class="column is-6">
                            <label class="label">Month</label>
                            <div class="select is-fullwidth">
                                <select name="month">
                                    {% for month_num, month_str in months %}
                                        <option value="{{ month_num }}"
                                                {% if month_num == monthnow %}selected{% endif %}>{{ month_str }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-6">
                            <label class="label">Year</label>
                            <div class="select is-fullwidth">
                                <select name="year">
                                    {% for year in years %}
                                        <option value="{{ year }}"
                                                {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="edit_additional_fee_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Edit Additional Fee</h5>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <button class="button" id="delete_additional_fee_confirm_button">
                                Delete
                            </button>
                        </div>
                        <div class="level-item">
                            <button class="button button-color" id="edit_additional_fee_confirm_button">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
                <form id="edit_additional_fee_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <input name="fee_id" type="text" style="display: none;"/>
                    <div class="columns is-multiline">
                        <div class="column is-6">
                            <label class="label">Name</label>
                            <input class="input is-fullwidth" name="name" type="text"/>
                        </div>
                        <div class="column is-6">
                            <label class="label">Fee</label>
                            <input class="input is-fullwidth" name="fee" type="text"/>
                        </div>
                        <div class="column is-6">
                            <label class="label">Month</label>
                            <div class="select is-fullwidth">
                                <select name="month">
                                    {% for month_num, month_str in months %}
                                        <option value="{{ month_num }}"
                                                {% if month_num == monthnow %}selected{% endif %}>{{ month_str }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-6">
                            <label class="label">Year</label>
                            <div class="select is-fullwidth">
                                <select name="year">
                                    {% for year in years %}
                                        <option value="{{ year }}"
                                                {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="add_promo_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Add Promo</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="add_promo_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form method="POST" action="/clients/accounts/new_promo" id="add_promo_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns">
                        <div class="column is-4">
                            <label class="label">Name:</label>
                            <input type="text" name="promo-name" class="input" required/>
                        </div>
                        <div class="column is-4">
                            <label class="label">Start Date:</label>
                            <input type="text" name="start-date" class="input datepicker-here" data-time-format="hh:ii"
                                   data-language="en" placeholder="Set start date here" required data-timepicker="true">
                        </div>
                        <div class="column is-4">
                            <label class="label">End Date:</label>
                            <input type="text" name="end-date" class="input datepicker-here" data-time-format="hh:ii"
                                   data-language="en" placeholder="Set end date here" required data-timepicker="true">
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column is-8">
                            <label class="label">Description:</label>
                            <input type="text" maxlength="140" name="promo-desc" class="input" required/>
                        </div>
                        <div class="column is-2" style="margin-top: 1em;">
                            <label class="checkbox">
                                <input type="checkbox" name="has-aw"/>
                                AW:
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" name="has-fb"/>
                                FB:
                            </label>
                        </div>
                        <div class="column is-2" style="margin-top: 1em;">
                            <label class="checkbox">
                                <input type="checkbox" name="has-bing"/>
                                Bing:
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" name="has-other"/>
                                Other:
                            </label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="assign_members_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <div class="modal-card-head">
                <div class="modal-card-title title is-5">Assign Members to {{ account.client_name }}</div>
            </div>
            <form id="assign_members_form" method="POST" action="/clients/accounts/assign_members">
                {% csrf_token %}
                <div class="modal-card-body">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns">
                        <div class="column">
                            <label class="label">AM 1:</label>
                            <div class="select is-fullwidth">
                                <select name="am1_assign" {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.am1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="am1_percent" class="input percentage-assignment"
                                           value="{{ account.am1percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">AM 2:</label>
                            <div class="select is-fullwidth">
                                <select name="am2_assign" {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.am2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="am2_percent" class="input percentage-assignment"
                                           value="{{ account.am2percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">AM 3:</label>
                            <div class="select is-fullwidth">
                                <select name="am3_assign" {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.am3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="am3_percent" class="input percentage-assignment"
                                           value="{{ account.am3percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column">
                            <label class="label">CM 1:</label>
                            <div class="select is-fullwidth">
                                <select name="cm1_assign" {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.cm1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="cm1_percent" class="input percentage-assignment"
                                           value="{{ account.cm1percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">CM 2:</label>
                            <div class="select is-fullwidth">
                                <select name="cm2_assign" {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.cm2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="cm2_percent" class="input percentage-assignment"
                                           value="{{ account.cm2percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">CM 3:</label>
                            <div class="select is-fullwidth">
                                <select name="cm3_assign" {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.cm3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="cm3_percent" class="input percentage-assignment"
                                           value="{{ account.cm3percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column">
                            <label class="label">Strat 1:</label>
                            <div class="select is-fullwidth">
                                <select name="strat1_assign"
                                        {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.strat1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="strat1_percent" class="input percentage-assignment"
                                           value="{{ account.strat1percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">Strat 2:</label>
                            <div class="select is-fullwidth">
                                <select name="strat2_assign"
                                        {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.strat2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="strat2_percent" class="input percentage-assignment"
                                           value="{{ account.strat2percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">Strat 3:</label>
                            <div class="select is-fullwidth">
                                <select name="strat3_assign"
                                        {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.strat3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="strat3_percent" class="input percentage-assignment"
                                           value="{{ account.strat3percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column">
                            <label class="label">SEO 1:</label>
                            <div class="select is-fullwidth">
                                <select name="seo1_assign"
                                        {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.seo1.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="seo1_percent" class="input percentage-assignment"
                                           value="{{ account.seo1percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">SEO 2:</label>
                            <div class="select is-fullwidth">
                                <select name="seo2_assign"
                                        {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.seo2.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="seo2_percent" class="input percentage-assignment"
                                           value="{{ account.seo2percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">SEO 3:</label>
                            <div class="select is-fullwidth">
                                <select name="seo3_assign"
                                        {% if not request.user.is_staff %}disabled{% endif %}>
                                    <option value="0">
                                        None
                                    </option>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == account.seo3.id %}selected{% endif %}>{{ member.user.first_name }} {{ member.user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field has-addons">
                                <div class="control is-expanded">
                                    <input type="text" name="seo3_percent" class="input percentage-assignment"
                                           value="{{ account.seo3percent|floatformat:2 }}"/>
                                </div>
                                <button class="button is-static" type="button">%</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-card-foot">
                    <p>Total percentage: <strong id="percentage_total"></strong></p>
                    <button type="button" class="button" id="distribute_hours_button" style="margin-left: auto;">
                        Distribute hours proportionately
                    </button>
                    <button type="submit" class="button button-color" id="submit_assign_form_button">Submit</button>
                </div>
            </form>
        </div>
        <button class="modal-close is-large"></button>
    </div>
    <div class="modal modal-fx-fadeInScale" id="update_services_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">Update Services</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="update_services_confirm_button">
                            Update
                        </button>
                    </div>
                </div>
                <form id="update_services_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns">
                        <div class="column is-4">
                            <label class="label">PPC</label>
                            <div class="select is-fullwidth">
                                <select class="update-service" name="set-ppc">
                                    {% for service_num, service_str in account.sales_profile.STATUS_CHOICES %}
                                        <option value="{{ service_num }}"
                                                {% if account.sales_profile.ppc_status == service_num %}
                                                selected
                                                {% endif %}>
                                            {{ service_str }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-4">
                            <label class="label">SEO</label>
                            <div class="select is-fullwidth">
                                <select class="pdate-service" name="set-seo">
                                    {% for service_num, service_str in account.sales_profile.STATUS_CHOICES %}
                                        <option value="{{ service_num }}"
                                                {% if account.sales_profile.seo_status == service_num %}
                                                selected
                                                {% endif %}>
                                            {{ service_str }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-4">
                            <label class="label">CRO</label>
                            <div class="select is-fullwidth">
                                <select class="update-service" name="set-cro">
                                    {% for service_num, service_str in account.sales_profile.STATUS_CHOICES %}
                                        <option value="{{ service_num }}"
                                                {% if account.sales_profile.cro_status == service_num %}
                                                selected
                                                {% endif %}>
                                            {{ service_str }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="new_opportunity_modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">New Opportunity</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="new_opportunity_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form id="new_opportunity_form" method="POST" action="/clients/accounts/set_opportunity">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <div class="columns">
                        <div class="column is-6">
                            <label class="label">Service:</label>
                            <div class="select is-fullwidth">
                                <select name="service" id="service">
                                    <option value="ppc">
                                        PPC
                                    </option>
                                    <option value="seo">
                                        SEO
                                    </option>
                                    <option value="cro">
                                        CRO
                                    </option>
                                    {% for service in additional_services %}
                                        <option value="{{ service.id }}">
                                            {{ service }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-6">
                            <label class="label">Description:</label>
                            <div class="select is-fullwidth">
                                <select name="opp_reason" id="opp_reason" class="is-fullwidth">
                                    {% for opp in opp_reasons %}
                                        <option value="{{ opp.id }}">
                                            {{ opp }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="new_mandate_modal">
        <div class="modal-background"></div>
        <div class="modal-content" style="overflow: auto;">
            <div class="box">
                <div class="level">
                    <div class="level-left">
                        <h5 class="title is-5">New Mandate</h5>
                    </div>
                    <div class="level-right">
                        <button class="button button-color" id="new_mandate_confirm_button">
                            Confirm
                        </button>
                    </div>
                </div>
                <form id="new_mandate_form">
                    <input name="account_id" type="text" value="{{ account.id }}" style="display:none;"/>
                    <input name="num_members" type="text" value="0" style="display:none;"/>
                    <div class="columns">
                        <div class="column is-9">
                            <label class="label">Additional Service Type:</label>
                            <div class="select is-fullwidth">
                                <select name="mandate_type" id="mandate_type">
                                    {% for mandate_type in mandate_types %}
                                        <option value="{{ mandate_type.id }}"
                                                data-hourly="{{ mandate_type.hourly_rate }}">
                                            {{ mandate_type }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-3">
                            <label class="label">Ongoing Service</label>
                            <label class="label">
                                <input name="ongoing_check" id="ongoing_check" type="checkbox">
                            </label>
                        </div>
                    </div>
                    <hr/>
                    <div id="set_duration_form">
                        <div class="columns">
                            <div class="column is-6">
                                <label class="label">Cost:</label>
                                <input type="text" name="cost" class="input"/>
                            </div>
                            <div class="column is-6">
                                <label class="label">Hourly rate:</label>
                                <input type="text" name="hourly_rate" id="mandate_hourly_rate"
                                       class="input" value="{{ first_mandate_rate }}"
                                />
                            </div>
                        </div>
                        <br/>
                        <div class="columns">
                            <div class="column is-6">
                                <label class="label">Start Date:</label>
                                <input type="text" name="start_date"
                                       class="input datepicker-here" data-language="en" autocomplete="off"/>
                            </div>
                            <div class="column is-6">
                                <label class="label">End Date:</label>
                                <input type="text" name="end_date"
                                       class="input datepicker-here" data-language="en" autocomplete="off"/>
                            </div>
                        </div>
                    </div>
                    <div id="ongoing_form" style="display: none;">
                        <div class="columns">
                            <div class="column is-2">
                                <label class="label">Hour bank</label>
                            </div>
                            <div class="column is-2">
                                <label class="checkbox">
                                    <input name="hourly_check" id="hourly_check" type="checkbox">
                                </label>
                            </div>
                        </div>
                        <div class="columns">
                            <div class="column is-6">
                                <label class="label">Monthly Cost:</label>
                                <input type="text" name="monthly_cost" id="monthly_cost"
                                       class="input"/>
                            </div>
                            <div class="column is-6">
                                <label class="label">Hourly rate:</label>
                                <input type="text" name="monthly_hourly_rate" id="monthly_hourly_rate"
                                       class="input" value="{{ first_mandate_rate }}"/>
                            </div>
                        </div>
                        <br/>
                        <div class="columns">
                            <div class="column is-6">
                                <label class="label">Monthly Hours:</label>
                                <input type="text" name="monthly_hours" id="monthly_hours"
                                       class="input" disabled/>
                            </div>
                        </div>
                    </div>
                    <br/>
                    <div class="columns">
                        <div class="column is-3">
                            <button type="button" id="add_member_btn" class="button">Add Member
                            </button>
                        </div>
                    </div>
                    <br/>
                    <div id="mandate_members"></div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="view_calendar_modal">
        <div class="modal-background"></div>
        <div class="modal-content" style="width: 75vw;">
            <div class="box">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
    <template id="member_in_mandate_template">
        <div class="columns">
            <div class="column is-9">
                <label class="label">Member:</label>
                <div class="select is-fullwidth">
                    <select name="mandate_member">
                        {% for member in members %}
                            <option value="{{ member.id }}">
                                {{ member }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="column is-3">
                <label class="label">Percentage:</label>
                <input type="text" name="percentage" class="input is-fullwidth" required/>
            </div>
        </div>
    </template>
    <!-- BUDGET MODALS -->
    <div class="modal modal-fx-fadeInScale" id="add_budget_modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="max-height: 100vh;">
            <header class="modal-card-head">
                <h5 class="title is-5">Add New Budget</h5>
            </header>
            <form method="post" action="/budget/new_budget">

                <section class="modal-card-body">
                    {% csrf_token %}
                    <input name="account_id" value="{{ account.id }}" class="is-hidden"/>
                    <div class="columns is-multiline">
                        <div class="column is-12">
                            <div class="field">
                                <label class="label">Budget Name</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Budget Name" name="budget_name"
                                           required>
                                </div>
                            </div>
                        </div>
                        <div class="column is-12">
                            <div class="field">
                                <label class="label">Budget</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Budget (in dollars)"
                                           name="budget_amount" required>
                                </div>
                            </div>
                        </div>
                        <div class="column is-12">
                            <div class="field">
                                <label class="label">Ad Networks</label>
                                <label class="checkbox">
                                    <input type="checkbox" name="google_ads" class="is-large"
                                           {% if not account.adwords.all %}disabled{% endif %}>
                                    Google Ads
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="facebook_ads"
                                           {% if not account.facebook.all %}disabled{% endif %}>
                                    Facebook Ads
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="bing_ads"
                                           {% if not account.bing.all %}disabled{% endif %}>
                                    Bing Ads
                                </label>
                            </div>
                        </div>
                        <div class="column is-12">
                            <input type="text" name="grouping_type" id="grouping_type" value="all_campaigns"
                                   class="is-hidden"/>
                            <div class="tabs is-centered is-boxed">
                                <ul>
                                    <li class="tab is-active" onclick="openTab(event, 'all_campaigns')"
                                        id="all_campaigns_tab">
                                        <a>
                                            <span>All Campaigns</span>
                                        </a>
                                    </li>
                                    <li class="tab" onclick="openTab(event, 'manual')" id="manual_tab">
                                        <a>
                                            <span>Manual Selection</span>
                                        </a>
                                    </li>
                                    <li class="tab" onclick="openTab(event, 'text')" id="text_tab">
                                        <a>
                                            <span>Text Filters</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div id="all_campaigns" class="content-tab">
                                <p>All campaigns will be included in this budget</p>
                            </div>
                            <div id="manual" class="content-tab" style="display:none">
                                <div class="field">
                                    <label class="label">Select Campaigns</label>
                                    <div class="control">
                                        <div class="select is-multiple is-fullwidth" id="campaign_list_across">
                                            <select name="campaigns"
                                                    multiple="multiple" id="campaigns_gr_across">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="text" class="content-tab" style="display:none">
                                <div class="field">
                                    <label class="label">Include Strings</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Separate by comma"
                                               name="include_strings">
                                    </div>
                                    <div class="field">
                                        <label class="label">Exclude Strings</label>
                                        <div class="control">
                                            <input class="input" type="text" placeholder="Separate by comma"
                                                   name="exclude_strings">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-12">
                            <hr/>
                            <div class="control">
                                <label class="radio">
                                    <input type="radio" name="time_period" value="monthly" id="monthly_time_period"
                                           required>
                                    Monthly
                                </label>
                                <label class="radio">
                                    <input type="radio" name="time_period" value="flight" id="flight_time_period"
                                           required>
                                    Flight
                                </label>
                            </div>
                        </div>
                        <div class="column is-12 is-hidden" id="flight_dates">
                            <div class="control">
                                <input type="text" class="input datepicker-here" style="width: 100%;"
                                       name="flight_dates" placeholder="Flight Dates" data-language="en"
                                       data-range="true" data-multiple-dates-separator=" - "
                                       data-position="top left">
                            </div>
                        </div>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <input type="submit" class="button is-info" value="Add Budget"/>
                    <button class="button close" type="button">Cancel</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="edit_budget_modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="max-height: 100vh;">
            <header class="modal-card-head">
                <h5 class="title is-5">Edit Budget</h5>
            </header>
            <form method="POST" action="/budget/edit_budget">
                <section class="modal-card-body">
                    {% csrf_token %}
                    <input name="budget_id" id="edit_budget_id" class="is-hidden"/>
                    <input name="account_id" value="{{ account.id }}" class="is-hidden"/>
                    <div class="columns is-multiline">
                        <div class="column is-12">
                            <div class="field">
                                <label class="label">Budget Name</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Budget Name" name="budget_name"
                                           id="edit_budget_name">
                                </div>
                            </div>
                        </div>
                        <div class="column is-12">
                            <div class="field">
                                <label class="label">Budget</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Budget (in dollars)"
                                           name="budget_amount"
                                           id="edit_budget_amount">
                                </div>
                            </div>
                        </div>
                        <div class="column is-12">
                            <div class="field">
                                <label class="label">Ad Networks</label>
                                <label class="checkbox">
                                    <input type="checkbox" name="google_ads" id="edit_google_ads" class="is-large">
                                    Google Ads
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="facebook_ads" id="edit_facebook_ads">
                                    Facebook Ads
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="bing_ads" id="edit_bing_ads">
                                    Bing Ads
                                </label>
                            </div>
                        </div>
                        <div class="column is-12">
                            <input type="text" name="grouping_type" id="edit_grouping_type" value="all_campaigns"
                                   class="is-hidden"/>
                            <div class="tabs is-centered is-boxed">
                                <ul>
                                    <li class="tab is-active" id="edit_all_campaigns_tab"
                                        onclick="openTab(event, 'edit_all_campaigns')">
                                        <a>
                                            <span>All Campaigns</span>
                                        </a>
                                    </li>
                                    <li class="tab" id="edit_manual_tab" onclick="openTab(event, 'edit_manual')">
                                        <a>
                                            <span>Manual Selection</span>
                                        </a>
                                    </li>
                                    <li class="tab" id="edit_text_tab" onclick="openTab(event, 'edit_text')">
                                        <a>
                                            <span>Text Filters</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div id="edit_all_campaigns" class="content-tab">
                                <p>All campaigns will be included in this budget</p>
                            </div>
                            <div id="edit_manual" class="content-tab" style="display:none">
                                <div class="field">
                                    <label class="label">Select Campaigns</label>
                                    <div class="control">
                                        <div class="select is-multiple is-fullwidth" id="campaign_list_across">
                                            <select name="campaigns"
                                                    multiple="multiple" id="edit_campaigns_gr_across">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="edit_text" class="content-tab" style="display:none">
                                <div class="field">
                                    <label class="label">Include Strings</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Separate by comma"
                                               name="include_strings" id="edit_include_strings">
                                    </div>
                                    <div class="field">
                                        <label class="label">Exclude Strings</label>
                                        <div class="control">
                                            <input class="input" type="text" placeholder="Separate by comma"
                                                   name="exclude_strings" id="edit_exclude_strings">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-12">
                            <hr/>
                            <div class="control">
                                <label class="radio">
                                    <input type="radio" name="time_period" value="monthly"
                                           id="edit_monthly_time_period">
                                    Monthly
                                </label>
                                <label class="radio">
                                    <input type="radio" name="time_period" value="flight" id="edit_flight_time_period">
                                    Flight
                                </label>
                            </div>
                        </div>
                        <div class="column is-12 is-hidden" id="edit_flight_dates">
                            <div class="control">
                                <input type="text" class="input datepicker-here" style="width: 100%;"
                                       name="flight_dates" placeholder="Flight Dates" data-language="en"
                                       data-range="true" data-multiple-dates-separator=" - "
                                       data-position="top left" id="edit_flight_dates_input">
                            </div>
                        </div>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <input type="submit" class="button is-info" value="Update Budget"/>
                    <button class="button close" type="button">Cancel</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="assign_accounts_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <h5 class="title is-5">Sources</h5>
            </header>
            <section class="modal-card-body">
                <form id="assign_accounts_form">
                    <input type="hidden" name="cid" value="{{ account.id }}">
                    <div class="column is-12">
                        <label>AdWords</label>
                        <div class="select is-multiple is-fullwidth">
                            <select name="adwords" class="account-multiple" multiple id="adwords_sources">
                            </select>
                        </div>
                    </div>
                    <div class="column is-12">
                        <label>Facebook</label>
                        <div class="select is-multiple is-fullwidth">
                            <select name="facebook" class="account-multiple" multiple id="facebook_sources">
                            </select>
                        </div>
                    </div>
                    <div class="column is-12">
                        <label>Bing</label>
                        <div class="select is-multiple is-fullwidth">
                            <select name="bing" class="account-multiple" multiple id="bing_sources">
                            </select>
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-info" id="assign_accounts_confirm_button">Save changes</button>
                <button class="button close">Cancel</button>
            </footer>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="campaigns_in_group_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <h5 class="title is-5">Campaigns In Group</h5>
            </header>
            <section class="modal-card-body">
                <table class="table is-fullwidth">
                    <thead>
                    <tr>
                        <th>
                            Campaign
                        </th>
                        <th>
                            Spend
                        </th>
                        <th>
                            Last Updated
                        </th>
                    </tr>
                    </thead>
                    <tbody id="campaigns_in_group_display">

                    </tbody>
                </table>
            </section>
            <footer class="modal-card-foot">
                <button class="button close">Cancel</button>
            </footer>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="exclusion_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <h5 class="title is-5">Master Exclusion</h5>
            </header>
            <form id="exclude_campaigns" method="post" action="/budget/update_exclusions">
                <section class="modal-card-body" style="height: 40vh;">
                    {% csrf_token %}
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <div class="tabs is-centered is-boxed">
                        <ul>
                            <li class="tab">
                                <a>
                                    Manual Selection
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="field">
                        <label class="label">Select Campaigns</label>
                        <div class="control">
                            <div class="select is-multiple is-fullwidth">
                                <select name="campaigns"
                                        multiple="multiple" id="exclude_campaigns_select">
                                </select>
                            </div>
                        </div>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <input class="button is-info" type="submit" value="Update Exclusions"/>
                    <button class="button close">Cancel</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="delete_budget_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <h5 class="title is-5">Delete Budget</h5>
            </header>
            <form method="post" action="/budget/delete_budget">
                <section class="modal-card-body">
                    {% csrf_token %}
                    <input type="hidden" name="budget_id" id="budget_id">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    Are you sure you want to delete this budget?
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-danger" type="submit">Delete</button>
                    <button class="button close-modal" type="button">Cancel</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="delete_mandate_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <h5 class="title is-5">Delete Additional Service</h5>
            </header>
            <form method="post" action="/budget/delete_mandate">
                <section class="modal-card-body">
                    {% csrf_token %}
                    <input type="hidden" name="mandate_id" id="mandate_id">
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    Are you sure you want to delete this additional service?
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-danger" type="submit">Delete</button>
                    <button class="button close-modal" type="button">Cancel</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="modal modal-fx-fadeInScale" id="google_analytics_modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <h5 class="title is-5">Link Google Analytics</h5>
            </header>
            <form method="post" action="/budget/link_google_analytics">
                <section class="modal-card-body">
                    {% if account.ga_view is not None %}<p>Current view ID: {{ account.ga_view.ga_view_id }}</p>
                        <hr/>{% endif %}
                    {% csrf_token %}
                    <input type="hidden" name="account_id" value="{{ account.id }}">
                    <div class="columns">
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Account</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="account_select" disabled>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Property</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="property_select" disabled>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">View</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="view_select" name="view_select" disabled>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-info" type="submit">Update</button>
                    <button class="button close-modal" type="button">Cancel</button>
                </footer>
            </form>
        </div>
    </div>
{% endblock %}

{% block extraJs %}
    <script>
        /**
         * EVENT LISTENERS
         */
        $('.delete').click(function () {
            $(this).closest('.message').addClass('is-hidden');
            $('.modal').removeClass('is-active');
        });

        $('.modal-trigger').click(function () {
            let $modal = $($(this).data('target'));
            $modal.addClass('is-active');
        });

        $('.modal-close, .modal-background, .close-modal').click(() => {
            $('.modal').removeClass('is-active');
        });

        let $flagAccountButton = $('#flag_account_toggle_button');
        let $goodAccountButton = $('#good_account_toggle_button');
        let $bcLink = $('#bc_link');
        let $flagged = $('[name="flagged"]');

        $goodAccountButton.click(() => {
            $goodAccountButton.removeClass('is-outlined');
            $flagAccountButton.addClass('is-outlined');
            $flagged.val('False');

            $bcLink.attr('placeholder', 'Optional');
        });

        $flagAccountButton.click(() => {
            $flagAccountButton.removeClass('is-outlined');
            $goodAccountButton.addClass('is-outlined');
            $flagged.val('True');

            $bcLink.attr('placeholder', '');
        });

        // proportional hours distribution
        $('#distribute_hours_button').click(() => {
            distributeHours();
        });

        // set this percentage to the span on input change
        $('.percentage-assignment').on('input', () => {
            setPercentageSum();
        });

        // check percentage form validity
        let $assignMembersForm = $('#assign_members_form');
        let $assignMembersSubmit = $('#submit_assign_form_button');
        $assignMembersSubmit.click(function (e) {
            e.preventDefault();

            let $percentageInputs = $('.percentage-assignment');
            let validForm = true;
            $percentageInputs.each((i, part) => {
                let value = parseFloat(part.value);
                if (value > 0) {
                    let type = part.name.split('_')[0]; // cm1, am2, etc.
                    let $memberField = $('[name=' + type + '_assign]');
                    if ($memberField.val() === '0') {
                        toastr.error('You attempted to assign a percentage to ' + type.toUpperCase() + ' without ' +
                            'an assigned member!');
                        validForm = false;
                    }
                }
            });

            if (!validForm) {
                return;
            }

            $assignMembersForm.submit();
        });

        $('#contact_details_button').click(() => {
            $('#contact_details_modal').addClass('is-active');
        });

        $('#update_services_button').click(() => {
            $('#update_services_modal').addClass('is-active');
        });

        $('#new_opportunity_button').click(() => {
            $('#new_opportunity_modal').addClass('is-active');
        });

        $('#view_calendar_button').click(() => {
            $('#view_calendar_modal').addClass('is-active');
        });

        $('#assign_members_button').click(() => {
            $('#assign_members_modal').addClass('is-active');
        });

        $('#new_mandate_button').click(() => {
            $('#new_mandate_modal').addClass('is-active');
        });

        $('#overall_budget_button').click(() => {
            $('#overall_budget_modal').addClass('is-active');
        });

        $('#additional_fee_button').click(() => {
            $('#additional_fee_modal').addClass('is-active');
        });

        $('#flag_account_button').click(() => {
            $('#flag_account_modal').addClass('is-active');
        });

        $('.edit-additional-fee-button').click(function () {
            $('#edit_additional_fee_modal').addClass('is-active');
            $('#edit_additional_fee_form [name="fee_id"]').val($(this).data('id'));
            $('#edit_additional_fee_form [name="name"]').val($(this).data('name'));
            $('#edit_additional_fee_form [name="fee"]').val($(this).data('fee'));
            $('#edit_additional_fee_form [name="month"]').val($(this).data('month'));
            $('#edit_additional_fee_form [name="year"]').val($(this).data('year'));
        });

        $('#add_promo_button').click(() => {
            $('#add_promo_modal').addClass('is-active');
        });

        $('#edit_promos_button').click(() => {
            location.href = '/clients/promos/edit';
        });

        $('#management_button').click(() => {
            $('#management_modal').addClass('is-active');
        });

        $('#quick_add_button').click(() => {
            $('#quick_add_modal').addClass('is-active');
        });

        $('#renew_overall_budget_button').click(() => {
            $('#renew_overall_budget_modal').addClass('is-active');
        });

        $('.modal-background').click(() => {
            $('.modal').removeClass('is-active');
        });

        const PAGEREFRESHTIME = 500;  // ms

        $('#edit_additional_fee_confirm_button').click(() => {
            $.ajax({
                url: '/budget/edit_additional_fee',
                data: $('#edit_additional_fee_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully updated this additional fee!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#flag_account_confirm_button').click(() => {
            if ($bcLink.val() === '' && $flagged.val() === 'True') {
                toastr.error('A basecamp link is required to flag an account!');
                return;
            }

            $.ajax({
                url: '/clients/accounts/flag',
                data: $('#flag_account_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully updated this account\'s flag status!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#delete_additional_fee_confirm_button').click(() => {
            $.ajax({
                url: '/budget/delete_additional_fee',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: $('#edit_additional_fee_form').serialize(),
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully deleted this additional fee!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#update_services_confirm_button').click(() => {
            $.ajax({
                url: '/clients/accounts/set_services',
                data: $('#update_services_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully updated services!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#update_client_details_button').click(function () {
            $.ajax({
                url: '/clients/set_client_details',
                type: 'POST',
                data: $('#client_details_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully updated client details!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
                error: () => {
                    toastr.error('Something went wrong!');
                }
            })
        });

        $('#new_opportunity_confirm_button').click(() => {
            $.ajax({
                url: '/clients/accounts/set_opportunity',
                data: $('#new_opportunity_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully created a new opportunity!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#quick_add_confirm_button').click(() => {
            $.ajax({
                url: '/clients/accounts/{{ account.id }}',
                data: $('#quick_add_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully submitted hours!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
                error: () => {
                    toastr.error('Error! Do you have permission to add hours to this account?');
                }
            });
        });

        $('#overall_budget_confirm_button').click(() => {
            $.ajax({
                url: '/budget/set_overall_budget',
                data: $('#overall_budget_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully updated the overall budget!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('.confirm-promo').click(function () {
            let confirmationType = $(this).data('confirmation-type');
            let promoID = $(this).data('promo-id');
            $.ajax({
                url: '/clients/promos/confirm',
                data: {
                    'account_id': {{ account.id }},
                    'promo_id': promoID,
                    'confirmation_type': confirmationType
                },
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                success: () => {
                    let startedOrEnded = confirmationType === 0 ? 'started' : 'ended';
                    toastr.success('Successfully marked promo as ' + startedOrEnded + '!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#new_mandate_confirm_button').click(() => {
            $.ajax({
                url: '/clients/accounts/mandates/new',
                data: $('#new_mandate_form').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'POST',
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully created a new mandate!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                }
            });
        });

        $('#assign_accounts_confirm_button').click(() => {
            $.ajax({
                type: 'POST',
                url: '/budget/client/accounts/add',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $('#assign_accounts_form').serialize(),
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully assigned sources to account {{ account.client_name }}!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
            });
        });

        $('#add_promo_confirm_button').click(() => {
            $.ajax({
                type: 'POST',
                url: '/clients/accounts/new_promo',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $('#add_promo_form').serialize(),
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully added promo!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
            });
        });

        $('#renew_overall_budget_confirm_button').click(() => {
            $.ajax({
                type: 'POST',
                url: '/budget/renew_overall_budget',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $('#renew_overall_budget_form').serialize(),
                success: () => {
                    toastr.success('Successfully renewed overall budget!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
            });
        });

        $('#renew_monthly_budget_button').click(function () {
            $.ajax({
                type: 'POST',
                url: '/budget/renew_monthly_budget',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: {
                    'account_id': {{ account.id }},
                    'budget_id': $(this).data('budget-id')
                },
                success: () => {
                    toastr.success('Successfully renewed this monthly budget!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
            });
        });

        $('#management_confirm_button').click(() => {
            $.ajax({
                type: 'POST',
                url: '/clients/edit_management_details',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $('#management_form').serialize(),
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully updated management fee structure!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
                error: () => {
                    toastr.error('Error! Please make sure all the form fields are filled out.');
                }
            });
        });

        $('#add_additional_fee_confirm_button').click(() => {
            $.ajax({
                type: 'POST',
                url: '/budget/create_additional_fee',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $('#additional_fee_form').serialize(),
                success: () => {
                    $('.modal').removeClass('is-active');
                    toastr.success('Successfully added a new fee!');
                    setTimeout(() => {
                        location.reload();
                    }, PAGEREFRESHTIME);
                },
                error: () => {
                    toastr.error('Error! Please make sure all the form fields are filled out.');
                }
            });
        });

        let $statusSelect = $('#account_status_select');
        let $statusRow = $('#account_status_row');
        let $inactiveReason = $('#account_inactive_reason');
        let $lostReason = $('#account_lost_reason');
        let $inactiveReturn = $('#account_inactive_return');

        $statusSelect.change(function () {
            let status = $(this).val();
            console.log(status);
            if (status === '2') {
                $inactiveReason.prop('disabled', false);
                $inactiveReturn.prop('disabled', false);
                $lostReason.prop('disabled', true);
                $statusRow.show();
            } else if (status === '3') {
                $inactiveReason.prop('disabled', true);
                $inactiveReturn.prop('disabled', true);
                $lostReason.prop('disabled', false);
                $statusRow.show();
            } else {
                $statusRow.hide();
            }
        });


        /**
         * HELPER FUNCTIONS
         */
        function distributeHours() {
            let hasSeo = {% if account.has_seo %}true{% else %}false{% endif %};
            let seoHours = {{ account.seo_hours|escapejs }};
            let hasCro = {% if account.has_cro %}true{% else %}false{% endif %};
            let croHours = {{ account.cro_hours|escapejs }};
            let totalHours = {{ account.all_hours|escapejs }};
            let ppc_hours = {{ account.ppc_hours|escapejs }};

            // Cms
            let cms = [];
            {% if account.cm1 != None %}cms.push(1);{% endif %}
            {% if account.cm2 != None %}cms.push(2);{% endif %}
            {% if account.cm3 != None %}cms.push(3);{% endif %}
            // Ams
            let ams = [];
            {% if account.am1 != None %}ams.push(1);{% endif %}
            {% if account.am2 != None %}ams.push(2);{% endif %}
            {% if account.am3 != None %}ams.push(3);{% endif %}
            // strats
            let strats = [];
            {% if account.strat1 != None %}strats.push(1);{% endif %}
            {% if account.strat2 != None %}strats.push(2);{% endif %}
            {% if account.strat3 != None %}strats.push(3);{% endif %}
            // seos
            let seos = [];
            {% if account.seo1 != None %}seos.push(1);{% endif %}
            {% if account.seo2 != None %}seos.push(2);{% endif %}
            {% if account.seo3 != None %}seos.push(3);{% endif %}

            /**
             * Calculate hour percentages
             */
            let cmPortion = 0.75;
            let amPortion = 0.25;
            let seoPortion = 0.0;

            if (hasSeo || hasCro) {
                let seoTotalPortion = ((seoHours + croHours) / totalHours);
                seoPortion = seoTotalPortion * 0.9;
                let remainingPortion = 1.0 - seoTotalPortion;
                cmPortion = remainingPortion * 0.75;
                amPortion = (remainingPortion * 0.25) + (seoPortion * 0.1);
            }

            let eachCm = (100.0 * cmPortion / cms.length).toFixed(2);
            let eachAm = (100.0 * amPortion / ams.length).toFixed(2);
            let eachSeo = (100.0 * seoPortion / seos.length).toFixed(2);

            /**
             * First set all to 0
             */
            for (let i = 1; i <= 3; i++) {
                $('[name=cm' + i + '_percent]').val('0.00');
                $('[name=am' + i + '_percent]').val('0.00');
                $('[name=strat' + i + '_percent]').val('0.00');
                $('[name=seo' + i + '_percent]').val('0.00');
            }

            cms.forEach(function (i) {
                $('[name=cm' + i + '_percent]').val(eachCm);
            });

            ams.forEach(function (i) {
                $('[name=am' + i + '_percent]').val(eachAm);
            });

            seos.forEach(function (i) {
                $('[name=seo' + i + '_percent]').val(eachSeo);
            });

            setPercentageSum();
        }

        // new mandate modal controls
        let $mandateType = $('#mandate_type');
        let $mandateHourlyRate = $('#mandate_hourly_rate');
        let $addMemberBtn = $('#add_member_btn');
        let mandateMembersDiv = document.querySelector('#mandate_members');

        $mandateType.change(function () {
            let init_hourly_rate = $(this).find(':selected').data('hourly');
            console.log(init_hourly_rate);
            $mandateHourlyRate.val(init_hourly_rate);
        });

        $addMemberBtn.click(function () {
            const memberMandateTemplate = document.getElementById('member_in_mandate_template').content;
            const clone = document.importNode(memberMandateTemplate, true);
            mandateMembersDiv.appendChild(clone);
        });

        let $ongoingCheck = $('#ongoing_check');
        let $setDurationForm = $('#set_duration_form');
        let $ongoingForm = $('#ongoing_form');
        let $hourlyCheck = $('#hourly_check');

        let $monthlyCost = $('#monthly_cost');
        let $monthlyHours = $('#monthly_hours');

        $ongoingCheck.change(function () {
            if ($(this).is(':checked')) {
                $setDurationForm.hide();
                $ongoingForm.show();
            } else {
                $ongoingForm.hide();
                $setDurationForm.show();
            }
        });

        $hourlyCheck.change(function () {
            if ($(this).is(':checked')) {
                $monthlyCost.prop('disabled', true);
                $monthlyHours.prop('disabled', false);
            } else {
                $monthlyHours.prop('disabled', true);
                $monthlyCost.prop('disabled', false);
            }
        });

        // calculate total assigned percentage
        function getPercentageSum() {
            let $percentageInputs = $('.percentage-assignment');
            let percentageSum = 0.0;

            $percentageInputs.each((i, part) => {
                let value = parseFloat(part.value);
                percentageSum += value;
            });

            return percentageSum.toFixed(2);
        }

        function setPercentageSum() {
            $('#percentage_total').text(getPercentageSum() + '%');
        }

        function getClientDetailsObjects() {
            let clientTeams = [];
            {% for team in account.team.all %}
                clientTeams.push('{{ team.pk }}');
            {% endfor %}

            $.ajax({
                url: '/clients/get_client_details_objects',
                type: 'GET',
                success: function (data) {
                    let teams = data['teams'];
                    let industries = data['industries'];

                    let selectIndustries = $('#select_industries');
                    let selectTeams = $('#select_teams');

                    teams.forEach((team) => {
                        let selected = clientTeams.includes(team['pk'].toString());
                        let opt = new Option(team['fields']['name'], team['pk'], false, selected);
                        selectTeams.append(opt);
                    });
                    industries.forEach((industry) => {
                        let selected = '{{ account.industry.pk }}' === industry['pk'].toString();
                        let opt = new Option(industry['fields']['name'], industry['pk'], false, selected);
                        selectIndustries.append(opt);
                    });

                    $('.selectable-details').selectize({
                        plugins: ['remove_button']
                    });
                    $('.set-details').selectize();
                }
            });
        }

        function generateHoursChart() {
            let allocatedHours = parseFloat('{{ account.allocated_hours_including_mandate }}');
            let actualHours = parseFloat('{{ account.hoursWorkedThisMonth }}');
            let remainingHours = parseFloat('{{ account.hoursRemainingMonth }}');

            let ctx = document.querySelector('#monthly_hours_chart').getContext('2d');
            let chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Allocated Hours', 'Actual Hours', 'Remaining Hours'],
                    datasets: [{
                        data: [allocatedHours, actualHours, remainingHours],
                        backgroundColor: ['#cc4b93', '#a946be', '#35375a']
                    }]
                },
                options: {
                    legend: {
                        display: false
                    },
                    rotation: -1 * Math.PI,
                    animation: false
                }
            });
        }


        /**
         * DOCUMENT READY EVENTS
         */
        $(document).ready(() => {
            setPercentageSum();
            getClientDetailsObjects();
            // generateHoursChart();
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev, next, today',
                    center: 'title',
                    right: 'month, listWeek'
                },
                aspectRatio: 2,
                defaultDate: moment(),
                defaultView: 'month',
                events: [
                    {% for promo in promos %}
                        {
                            title: '{{ promo.name }}',
                            description: '{{ promo.desc }}',
                            start: moment('{{ promo.formatted_start }}'),
                            end: moment('{{ promo.formatted_end }}'),
                            className: {% if promo.is_active %}'m-fc-event--success'
                                {% else %}'m-fc - event--warning'{% endif %}
                        }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            });

            // budget pacer calculations
            let now = new Date();
            let today = now.getDate();
            let daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const MSPERDAY = 1000 * 60 * 60 * 24;
            $('.budget-pacer').each(function () {
                let isMonthly = $(this).data('is-monthly') === 'True';
                let percentage;
                if (isMonthly) {
                    percentage = today * 100.0 / daysInMonth;
                } else {
                    // flight budget
                    let startDate = $(this).data('start-date');
                    let endDate = $(this).data('end-date');
                    let sdArr = startDate.split(',');
                    let edArr = endDate.split(',');
                    // convert to js dates
                    startDate = new Date(sdArr[0] + sdArr[1]);
                    endDate = new Date(edArr[0] + edArr[1]);
                    let daysInDateRange = Math.round(endDate - startDate) / MSPERDAY;  // dateRange is a ms object
                    let daysElapsed = Math.round((now - startDate) / MSPERDAY);
                    percentage = daysElapsed * 100 / daysInDateRange;
                }
                percentage = parseFloat(percentage).toFixed(2).toString();
                $(this).css('left', percentage + '%');
            });
            $('.budget-date').text(today + '/' + daysInMonth);

            // account management status row
            let status = $statusSelect.val();
            if (status === '2') {
                $inactiveReason.prop('disabled', false);
                $inactiveReturn.prop('disabled', false);
                $lostReason.prop('disabled', true);
                $statusRow.show();
            } else if (status === '3') {
                $inactiveReason.prop('disabled', true);
                $inactiveReturn.prop('disabled', true);
                $lostReason.prop('disabled', false);
                $statusRow.show();
            }
        });


        /**
         * BUDGET SCRIPTS
         */
        let $flightRadio = $('#flight_time_period');
        let $monthRadio = $('#monthly_time_period');
        let $flightDates = $('#flight_dates');

        $flightRadio.change(function () {
            $flightDates.removeClass('is-hidden');
        });

        $monthRadio.change(function () {
            $flightDates.addClass('is-hidden');
        });

        let $editFlightRadio = $('#edit_flight_time_period');
        let $editMonthRadio = $('#edit_monthly_time_period');
        let $editFlightDates = $('#edit_flight_dates');

        $editFlightRadio.change(function () {
            $editFlightDates.removeClass('is-hidden');
        });

        $editMonthRadio.change(function () {
            $editFlightDates.addClass('is-hidden');
        });

        document.querySelector('#ga_btn').addEventListener('click', function (event) {
            event.preventDefault();
            let ga_modal = document.querySelector('#google_analytics_modal');
            ga_modal.classList.add('is-active');

            ga_modal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                ga_modal.classList.remove('is-active');
            });

            let budgetCloseEls = ga_modal.querySelectorAll('.close');

            budgetCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    ga_modal.classList.remove('is-active');
                });
            });
        });

        document.querySelector('#add_budget_btn').addEventListener('click', function (event) {
            event.preventDefault();
            let addBudgetModal = document.querySelector('#add_budget_modal');
            addBudgetModal.classList.add('is-active');

            addBudgetModal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                addBudgetModal.classList.remove('is-active');
            });

            let budgetCloseEls = addBudgetModal.querySelectorAll('.close');

            budgetCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    addBudgetModal.classList.remove('is-active');
                });
            });
        });

        document.querySelector('#sources_btn').addEventListener('click', function (event) {
            if ($(this).text() !== 'Sources') {
                return;
            }
            event.preventDefault();
            let sourcesModal = document.querySelector('#assign_accounts_modal');
            sourcesModal.classList.add('is-active');

            sourcesModal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                sourcesModal.classList.remove('is-active');
            });

            let sourceCloseEls = sourcesModal.querySelectorAll('.close');

            sourceCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    sourcesModal.classList.remove('is-active');
                });
            });
        });

        document.querySelector('#exclusion_btn').addEventListener('click', function (event) {
            event.preventDefault();
            let exclusionModal = document.querySelector('#exclusion_modal');
            exclusionModal.classList.add('is-active');

            exclusionModal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                exclusionModal.classList.remove('is-active');
            });

            let sourceCloseEls = exclusionModal.querySelectorAll('.close');

            sourceCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    exclusionModal.classList.remove('is-active');
                });
            });
        });

        $('.edit-budget-btn').click(function (event) {
            event.preventDefault();
            let editModalBudget = document.querySelector('#edit_budget_modal');
            editModalBudget.classList.add('is-active');

            editModalBudget.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                editModalBudget.classList.remove('is-active');
            });

            let editCloseEls = editModalBudget.querySelectorAll('.close');

            editCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    editModalBudget.classList.remove('is-active');
                });
            });

            let budgetId = $(this).data('budget-id');
            $('#edit_budget_id').val(budgetId);

            $.ajax({
                url: '/budget/get_info',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: {
                    'budget_id': budgetId
                },
                success: (data) => {
                    let fields = data.budget[0].fields;

                    let $budgetName = $('#edit_budget_name');
                    let $budgetAmount = $('#edit_budget_amount');
                    let $networkGoogle = $('#edit_google_ads');
                    let $networkFB = $('#edit_facebook_ads');
                    let $networkBing = $('#edit_bing_ads');
                    let $monthly = $('#edit_monthly_time_period');
                    let $flight = $('#edit_flight_time_period');

                    let groupingType = fields['grouping_type'];
                    if (groupingType === 0) {  // manual
                        $('#edit_manual_tab').click();
                        let campaigns = data.campaigns.map(camp => camp.fields.campaign_id);
                        let $campaignSelect = $('#edit_campaigns_gr_across');
                        setTimeout(() => {  // selectize takes time to initialize
                            let selectize = $campaignSelect[0].selectize;
                            selectize.setValue(campaigns);
                        }, 200);
                    } else if (groupingType === 1) {  // text filters
                        $('#edit_text_tab').click();
                        let $includeStrings = $('#edit_include_strings');
                        let $excludeStrings = $('#edit_exclude_strings');
                        $includeStrings.val(fields['text_includes']);
                        $excludeStrings.val(fields['text_excludes']);
                    }

                    $budgetName.val(fields['name']);
                    $budgetAmount.val(fields['budget']);
                    $networkGoogle[0].checked = fields['has_adwords'];
                    $networkFB[0].checked = fields['has_facebook'];
                    $networkBing[0].checked = fields['has_bing'];
                    $monthly[0].checked = fields['is_monthly'];
                    $flight[0].checked = !fields['is_monthly'];

                    if ($flight[0].checked) {
                        let evt = document.createEvent('HTMLEvents');
                        evt.initEvent('change', false, true);
                        $flight[0].dispatchEvent(evt);
                        let $flightInput = $('#edit_flight_dates_input');
                        let startDate = fields['start_date'].slice(0, 10).split('-');
                        startDate = startDate[1] + '/' + startDate[2] + '/' + startDate[0];
                        let endDate = fields['end_date'].slice(0, 10).split('-');
                        endDate = endDate[1] + '/' + endDate[2] + '/' + endDate[0];
                        $flightInput.val(startDate + ' - ' + endDate);
                    }
                },
                error: function (ajaxContext) {
                    toastr.error(ajaxContext.statusText)
                },
            });
        });

        $('.campaigns_in_group_link').click(function (event) {
            event.preventDefault();
            let campsInGroupModal = document.querySelector('#campaigns_in_group_modal');
            campsInGroupModal.classList.add('is-active');

            campsInGroupModal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                campsInGroupModal.classList.remove('is-active');
            });

            let sourceCloseEls = campsInGroupModal.querySelectorAll('.close');

            sourceCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    campsInGroupModal.classList.remove('is-active');
                });
            });

            // populate div with campaigns in the group
            let budgetID = $(this).data('budget-id');
            let $campsInGroupDisplay = $('#campaigns_in_group_display');
            $campsInGroupDisplay.empty();

            $.ajax({
                url: '/budget/groupings/get_campaigns_in_budget',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: {
                    'budget_id': budgetID
                },
                success: (data) => {
                    let campaigns = data['campaigns'];
                    console.log(data);
                    campaigns.forEach(camp => {
                        let row = document.createElement('tr');

                        let text;
                        if (camp['model'] === 'adwords_dashboard.campaign') {
                            text = document.createTextNode('A - ' + camp['fields']['campaign_name']);
                        }
                        if (camp['model'] === 'facebook_dashboard.facebookcampaign') {
                            text = document.createTextNode('F - ' + camp['fields']['campaign_name']);
                        }
                        if (camp['model'] === 'bing_dashboard.bingcampaign') {
                            text = document.createTextNode('B - ' + camp['fields']['campaign_name']);
                        }

                        let td1 = document.createElement('td');
                        td1.appendChild(text);

                        let td2 = document.createElement('td');
                        let spend;
                        if (data['is_monthly']) {
                            spend = document.createTextNode(camp['fields']['campaign_cost']);
                        } else {
                            spend = document.createTextNode(data['cdrs'][camp['fields']['campaign_id']]);
                        }
                        td2.appendChild(spend);

                        let td3 = document.createElement('td');
                        let last_updated;
                        if (data['is_monthly']) {
                            last_updated = document.createTextNode(camp['fields']['updated'].split('.')[0]);
                        } else {
                            last_updated = document.createTextNode(data['cupdate'][camp['fields']['campaign_id']]);
                        }
                        td3.appendChild(last_updated);

                        row.appendChild(td1);
                        row.appendChild(td2);
                        row.appendChild(td3);
                        $campsInGroupDisplay.append(row);
                    });
                },
                error: function (ajaxContext) {
                    toastr.error(ajaxContext.statusText)
                },
            });
        });

        // Tabs
        let openTab = function (evt, tabName) {
            let i, x, tablinks;
            let groupingSelector = 'grouping_type';
            if (tabName.includes('edit')) {
                groupingSelector = 'edit_grouping_type';
            }
            let groupingType = document.getElementById(groupingSelector);
            groupingType.value = tabName;
            x = document.getElementsByClassName('content-tab');
            for (i = 0; i < x.length; i++) {
                x[i].style.display = 'none';
            }
            tablinks = document.getElementsByClassName('tab');
            for (i = 0; i < x.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(' is-active', '');
            }
            document.getElementById(tabName).style.display = 'block';
            document.querySelector('#' + tabName + '_tab').className += ' is-active';
            if (tabName === 'manual') {
                manualCampaigns('campaigns_gr_across');
            } else if (tabName === 'edit_manual') {
                manualCampaigns('edit_campaigns_gr_across');
            }
        };

        let manualCampaigns = function (elementID) {
            let ids = '';
            {% for a in account.adwords.all %}
                ids += '{{ a.dependent_account_id }}{% if not forloop.last %},{% endif %}';
            {% endfor %}
            {% for a in account.facebook.all %}
                ids += ',{{ a.account_id }}';
            {% endfor %}
            {% for a in account.bing.all %}
                ids += ',{% if not forloop.last %},{% endif %}';
            {% endfor %}

            let data = {
                'account_id': '{{ account.id }}',
                'account_ids': ids,
                'channel': $('#select_accounts_cgr').find(':selected').data('channel')
            };

            $.ajax({
                url: '/budget/groupings/get_campaigns',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: data,
                success: function (data) {
                    let campaigns = data['campaigns'];
                    let excluded_campaigns = data['excluded_campaigns'].map(a => a.pk);
                    campaigns.forEach(item => {
                        let selected = false;
                        if (elementID === 'exclude_campaigns_select') {
                            selected = excluded_campaigns.includes(item.pk);
                        }
                        if (item['model'] === 'adwords_dashboard.campaign') {
                            let new_option = new Option('A - ' + item['fields']['campaign_name'], item['fields']['campaign_id'], false, selected);
                            $('#' + elementID).append(new_option).trigger('change');
                        }
                        if (item['model'] === 'bing_dashboard.bingcampaign') {
                            let new_option = new Option('B - ' + item['fields']['campaign_name'], item['fields']['campaign_id'], false, selected);
                            $('#' + elementID).append(new_option).trigger('change');
                        }
                        if (item['model'] === 'facebook_dashboard.facebookcampaign') {
                            let new_option = new Option('F - ' + item['fields']['campaign_name'], item['fields']['campaign_id'], false, selected);
                            $('#' + elementID).append(new_option).trigger('change');
                        }
                    });

                    $('#' + elementID).selectize({
                        plugins: ['remove_button']
                    });
                },
                error: function (ajaxContext) {
                    toastr.error(ajaxContext.statusText)
                },
                complete: function () {
                }

            });
        };

        $('#sources_btn').one('click', function () {
            $(this).addClass('is-loading');

            $.ajax({
                url: '/budget/groupings/get_accounts',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: {
                    'account_id': '{{ account.id }}'
                },
                success: (data) => {
                    let accounts = data['accounts'];
                    let existing_aw = data['existing_aw'].map(a => a.pk);
                    let existing_fb = data['existing_fb'].map(a => a.pk);
                    let existing_bing = data['existing_bing'].map(a => a.pk);
                    accounts.forEach(acc => {
                        if (acc['model'] === 'adwords_dashboard.dependentaccount') {
                            let selected = existing_aw.includes(acc.pk);
                            let new_option = new Option(acc['fields']['dependent_account_name'], acc['fields']['dependent_account_id'], false, selected);
                            $('#adwords_sources').append(new_option).trigger('change');
                        } else if (acc['model'] === 'facebook_dashboard.facebookaccount') {
                            let selected = existing_fb.includes(acc.pk);
                            let new_option = new Option(acc['fields']['account_name'], acc['fields']['account_id'], false, selected);
                            $('#facebook_sources').append(new_option).trigger('change');
                        } else if (acc['model'] === 'bing_dashboard.bingaccounts') {
                            let selected = existing_bing.includes(acc.pk);
                            let new_option = new Option(acc['fields']['account_name'], acc['fields']['account_id'], false, selected);
                            $('#bing_sources').append(new_option).trigger('change');
                        }
                    });

                    $('.account-multiple').selectize({
                        plugins: ['remove_button'],
                    });

                    $(this).removeClass('is-loading');
                    $(this).text('Sources');
                },
                error: function (ajaxContext) {
                    toastr.error(ajaxContext.statusText)
                },
            });
        });

        $('.delete-budget-btn').click(function () {
            let budgetID = $(this).data('budget-id');
            $('#budget_id').val(budgetID);

            let deleteBudgetModal = document.querySelector('#delete_budget_modal');
            deleteBudgetModal.classList.add('is-active');

            deleteBudgetModal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                deleteBudgetModal.classList.remove('is-active');
            });

            let sourceCloseEls = deleteBudgetModal.querySelectorAll('.close');

            sourceCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    deleteBudgetModal.classList.remove('is-active');
                });
            });
        });

        $('.delete-mandate-btn').click(function () {
            let mandateID = $(this).data('mandate-id');
            $('#mandate_id').val(mandateID);

            let deleteMandateModal = document.querySelector('#delete_mandate_modal');
            deleteMandateModal.classList.add('is-active');

            deleteMandateModal.querySelector('.modal-background').addEventListener('click', function (e) {
                e.preventDefault();
                deleteMandateModal.classList.remove('is-active');
            });

            let sourceCloseEls = deleteMandateModal.querySelectorAll('.close');

            sourceCloseEls.forEach(function (el) {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    deleteMandateModal.classList.remove('is-active');
                });
            });
        });

        /**
         * Management fees (copy pasted from old edit page, pretty ugly)
         */
        let $createNewFeeBtn = $('#create_new_fee_structure_button');
        let $useExistingFeeBtn = $('#use_existing_fee_structure_button');
        let $createNewFeeDiv = $('#create_new_fee_structure');
        let $useExistingFeeDiv = $('#use_existing_fee_structure');
        let $feeStructureType = $('#fee_structure_type');

        $createNewFeeBtn.click(function () {
            $feeStructureType.val('1');
            $useExistingFeeDiv.hide();
            $createNewFeeDiv.show();
        });

        $useExistingFeeBtn.click(function () {
            $feeStructureType.val('2');
            $createNewFeeDiv.hide();
            $useExistingFeeDiv.show();
        });

        let $addFeeBtn = $('.add-fee-level-button');
        let $feeForm = $('#management_fee_form');
        let $rowNum = $('#row_num_input');

        let feeRows = 1;
        let feeRowHtml = `
                  <div class="columns">
                    <div class="column is-3">
                      <label class="label">Low Budget Bound ($):</label>
                      <input class="input" name="low-bound1" />
                    </div>
                    <div class="column is-3">
                      <label class="label">High Budget Bound ($):</label>
                      <input class="input" name="high-bound1" />
                    </div>
                    <div class="column is-2">
                      <label class="label">Fee type:</label>
                      <select class="input"
                              name="fee-type1"
                              style="width: 100%;">
                              <option value="0">%</option>
                              <option value="1">$</option>
                      </select>
                    </div>
                    <div class="column is-2">
                      <label class="label">Fee:</label>
                      <input class="input" name="fee1" />
                    </div>
                  </div>
                  `;

        $addFeeBtn.click(function () {
            feeRows++;
            $rowNum.val(feeRows);
            let feeRowHtmlTmp = feeRowHtml.replace('low-bound1', 'low-bound' + feeRows)
                .replace('high-bound1', 'high-bound' + feeRows)
                .replace('fee-type1', 'fee-type' + feeRows)
                .replace('fee1', 'fee' + feeRows);
            $feeForm.append(feeRowHtmlTmp);
        });

        let $mfSelect = $('#existing_structure');
        let $presetMf = $('#preset_mf');
        let $presetMfTbody = $('#preset_mf_tbody');
        let $presetSetupFee = $('#setup_fee_preset');

        $mfSelect.change(function () {
            if ($mfSelect.val() === '0') {
                $presetMfTbody.html('');
                $presetMf.hide();
                return;
            }

            /**
             * Get the management fee structure
             */
            $.ajax({
                url: '/clients/get_management_fee_details/' + $mfSelect.val(),
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                success: function (data) {
                    $presetMfTbody.html('');
                    $presetSetupFee.html(data.initial_fee);
                    for (let key in data.fee_intervals) {
                        let fee_interval = data.fee_intervals[key];
                        let inner_html = '';
                        inner_html += '<tr>';
                        inner_html += '<td>';
                        inner_html += '$' + fee_interval.lowerBound + ' - $' + fee_interval.upperBound;
                        inner_html += '</td>';
                        inner_html += '<td>';
                        if (fee_interval.style === 0) { // %
                            inner_html += fee_interval.fee + '%';
                        } else { // $
                            inner_html += '$' + fee_interval.fee;
                        }
                        inner_html += '</td>';
                        inner_html += '</tr>';
                        $presetMfTbody.append(inner_html);
                    }
                    $presetMf.show();
                }
            });
        });

        let $accountSelect = $('#account_select');
        let $propertySelect = $('#property_select');
        let $viewSelect = $('#view_select');

        let setupAccountsSelect = function () {
            $.ajax({
                url: '/insights/get_accounts',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                success: (data) => {
                    let gaAccs = data['items'];
                    gaAccs.forEach(acc => {
                        let markup = '<option value="' + acc['id'] + '">' + acc['name'] + '</option>';
                        $accountSelect.append(markup);
                    });
                    $accountSelect.prop('disabled', false);
                }
            });
        };

        let setupPropertySelect = function (accountId) {
            $.ajax({
                url: '/insights/get_properties',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: {'account_id': accountId},
                success: (data) => {
                    let gaProps = data['items'];
                    $propertySelect.html('');
                    let defaultOption = '<option selected hidden disabled>--</option>';
                    $propertySelect.append(defaultOption);
                    gaProps.forEach(prop => {
                        let markup = '<option value="' + prop['id'] + '">' + prop['name'] + '</option>';
                        $propertySelect.append(markup);
                    });
                    $propertySelect.prop('disabled', false);
                }
            });
        };

        let setupViewSelect = function (accountId, propId) {
            $.ajax({
                url: '/insights/get_views',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: {
                    'account_id': accountId,
                    'prop_id': propId
                },
                success: (data) => {
                    let gaViews = data['items'];
                    $viewSelect.html('');
                    gaViews.forEach(view => {
                        let markup = '<option value="' + view['id'] + '">' + view['name'] + '</option>';
                        $viewSelect.append(markup);
                    });
                    $viewSelect.prop('disabled', false);
                }
            });
        };

        $(document).ready(function () {
            setupAccountsSelect();

            $accountSelect.change(function () {
                setupPropertySelect($(this).val());
            });

            $propertySelect.change(function () {
                setupViewSelect($accountSelect.val(), $(this).val());
            });
        });
    </script>
{% endblock %}
