{% extends 'layout.html' %}

{% block extraCss %}
{% endblock %}

{% block main_body %}
    <section class="hero">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    Insights
                </h1>
                <h2 class="subtitle">
                    {% if account is None %}
                        All Accounts
                    {% else %}
                        {{ account }}
                    {% endif %}
                </h2>
                <div class="columns">
                    <div class="column is-4">
                        <div class="field">
                            <label class="label">Account</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="account_select" disabled>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column is-4">
                        <div class="field">
                            <label class="label">Property</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="property_select" disabled>
                                        <option>Select an account</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column is-4">
                        <div class="field">
                            <label class="label">View</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="view_select" disabled>
                                        <option>Select a property</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="columns is-multiline">
                    {% for opp in opportunities %}
                        <div class="column is-3">
                            <div class="box">
                                <p class="title is-4 has-text-danger">Insight</p>
                                {{ opp.report.report }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <script>
        let $accountSelect = $('#account_select');
        let $propertySelect = $('#property_select');
        let $viewSelect = $('#view_select');

        let setupAccountsSelect = function () {
            $.ajax({
                url: '/insights/get_accounts',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                success: (data) => {
                    let gaAccs = data['items'];
                    gaAccs.forEach(acc => {
                        let markup = '<option value="' + acc['id'] + '">' + acc['name'] + '</option>';
                        $accountSelect.append(markup);
                    });
                    $accountSelect.prop('disabled', false);
                }
            });
        };

        let setupPropertySelect = function (accountId) {
            $.ajax({
                url: '/insights/get_properties',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                type: 'POST',
                data: {'account_id': accountId},
                success: (data) => {
                    console.log(data);
                    {#let gaAccs = data['items'];#}
                    {#gaAccs.forEach(acc => {#}
                    {#    let markup = '<option value="' + acc['id'] + '">' + acc['name'] + '</option>';#}
                    {#    $accountSelect.append(markup);#}
                    {# });#}
                    {#$accountSelect.prop('disabled', false);#}
                }
            });
        };

        let setupViewSelect = function () {

        };

        $(document).ready(function () {
            setupAccountsSelect();

            $accountSelect.change(function () {
                console.log($(this).val());
                setupPropertySelect($(this).val());
            });

            $propertySelect.change(function () {
                setupViewSelect($(this).val());
            });
        });
    </script>
{% endblock %}