{% extends 'layout.html' %}

{% block extraCss %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
{% endblock %}

{% block main_body %}
    <section class="hero">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    {% if account is None %}
                        All Accounts
                    {% else %}
                        {{ account }}
                    {% endif %}
                </h1>
                <h2 class="subtitle">
                    <p id="insights_text" class="is-hidden">Insights</p>
                    <button class="button" id="get_insights">Get Insights</button>
                </h2>
                <div class="columns is-multiline" id="insights">
                    {% for opp in opportunities %}
                        <div class="column is-3">
                            <div class="box">
                                <p class="title is-4 has-text-danger">Insight</p>
                                {{ opp.report.report }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <script>
        let $getInsightsButton = $('#get_insights');
        let $insightsDiv = $('#insights');
        let $insightsText = $('#insights_text');

        $getInsightsButton.one('click', () => {
            $getInsightsButton.addClass('is-loading');
            // pulls all insights for this account, all separate requests
            $.ajax({
                url: '/insights/get_ecom_best_demographics_insights/54904496',  // mondou for test
                success: data => {
                    let insights = data['insights'];
                    insights.forEach(insight => {
                        let insightBox = '<div class="column is-3"><div class="box"><p class="title is-4 has-text-info">' +
                            'Insight</p>' + insight.fields.description + '</div></div>';
                        $insightsDiv.append(insightBox);
                    });
                    $getInsightsButton.addClass('is-hidden');
                },
                error: error => {
                    console.log(error);
                }
            });

            $.ajax({
                url: '/insights/get_organic_searches_by_region_insight/54904496',  // mondou for test
                success: data => {
                    let insights = data['insights'];
                    insights.forEach(insight => {
                        let insightBox = '<div class="column is-3"><div class="box"><p class="title is-4 has-text-info">' +
                            'Insight</p>' + insight.fields.description + '</div></div>';
                        $insightsDiv.append(insightBox);
                    });
                    $getInsightsButton.addClass('is-hidden');
                },
                error: error => {
                    console.log(error);
                }
            });

            $.ajax({
                url: '/insights/get_organic_searches_over_time_by_medium_insight/54904496',  // mondou for test
                success: data => {
                    let googleSearches = data['google_searches'].map(x => parseInt(x));
                    let bingSearches = data['bing_searches'].map(x => parseInt(x));

                    // create box
                    let column = document.createElement('div');
                    column.className = 'column is-6';
                    let box = document.createElement('box');
                    box.className = 'box';
                    let p = document.createElement('p');
                    p.className = 'title is-4 has-text-info';
                    p.appendChild(document.createTextNode('Organic Searches Over Time by Medium'));
                    let bingChart = document.createElement('canvas');
                    bingChart.id = 'bingChart';
                    let googleChart = document.createElement('canvas');
                    googleChart.id = 'googleChart';

                    box.appendChild(p);
                    box.appendChild(googleChart);
                    box.appendChild(bingChart);
                    column.appendChild(box);
                    $insightsDiv.append(column);
                    $getInsightsButton.addClass('is-hidden');
                    $insightsText.removeClass('is-hidden');

                    new Chart(document.querySelector('#googleChart'), {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Jul', 'Aug', 'Sep', 'Nov', 'Dec'],
                            datasets: [
                                {
                                    data: googleSearches,
                                    borderColor: 'tomato'
                                },
                            ]
                        },
                        options: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Google'
                            }
                        }
                    });
                    new Chart(document.querySelector('#bingChart'), {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Jul', 'Aug', 'Sep', 'Nov', 'Dec'],
                            datasets: [
                                {
                                    data: bingSearches,
                                    label: 'Bing',
                                    borderColor: 'lightskyblue'
                                }
                            ]
                        },
                        options: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Bing'
                            },
                        }
                    });
                },
                error: error => {
                    console.log(error);
                }
            });

            $.ajax({
                url: '/insights/get_ecom_ppc_best_ad_groups_insight/54904496',  // mondou for test
                success: data => {
                    let insights = data['insights'];
                    insights.forEach(insight => {
                        let insightBox = '<div class="column is-3"><div class="box"><p class="title is-4 has-text-info">' +
                            'Insight</p>' + insight.fields.description + '</div></div>';
                        $insightsDiv.append(insightBox);
                    });
                    $getInsightsButton.addClass('is-hidden');
                },
                error: error => {
                    console.log(error);
                }
            })
        });
    </script>
{% endblock %}