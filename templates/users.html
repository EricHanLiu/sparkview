<!DOCTYPE html> {% extends 'main.html' %} {% load staticfiles %} {% load custom_filters %} {% block content %}

    <div class="m-content">
        <div class="row">
            <div class="col-xl-12">
                <div class="m-portlet m-portlet--creative m-portlet--first m-portlet--bordered-semi">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h2 class="m-portlet__head-label m-portlet__head-label--bloom">
                                    <span>Userlist</span>
                                </h2>
                            </div>
                        </div>
                    </div>

                    <div class="m-portlet__body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="btn-group m-btn-group m-btn-group--pill m-btn-group--air" role="group"
                                     aria-label="...">
                                    <button type="button" class="m-btn btn btn-outline-accent" data-toggle="modal"
                                            data-target="#m_modal_add_user">Add user
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% for detail in details %}
                            <div class="m-separator m-separator--metal"></div>
                            <div class="m-portlet m-portlet--tabs m-portlet--success m-portlet--head-solid-bg m-portlet--head-sm m-portlet--collapse"
                                 m-portlet="true" id="m_portlet_tools_6">
                                <div class="m-portlet__head m-portlet__head--bloom">
                                    <div class="m-portlet__head-caption">
                                        <div class="m-portlet__head-title">
                                            <h3 class="m-portlet__head-text">
                                                {{ detail.user }} <i class="fa fa-plus-circle" data-toggle="modal"
                                                                     data-target="#m_modal_accounts"
                                                                     data-userid="{{ detail.user.id }}"
                                                                     style="background: #212529; color: #FFF;"></i>
                                                <i class="fa fa-minus-circle" data-toggle="modal"
                                                    data-target="#m_modal_delete_user"
                                                    data-userid="{{ detail.user.id }}"
                                                    data-username="{{ detail.user }}"></i>
                                            </h3>
                                        </div>
                                    </div>
                                    <div class="m-portlet__head-tools">
                                        <ul class="nav nav-tabs m-tabs m-tabs-line  m-tabs-line--right" role="tablist">
                                            <li class="nav-item m-tabs__item">
                                                <a class="nav-link m-tabs__link active" data-toggle="tab"
                                                   href="#m_tabs_7_1-{{ detail.user.id }}"
                                                   role="tab" aria-selected="true">
                                                    AdWords
                                                </a>
                                            </li>
                                            <li class="nav-item m-tabs__item">
                                                <a class="nav-link m-tabs__link" data-toggle="tab"
                                                   href="#m_tabs_7_2-{{ detail.user.id }}"
                                                   role="tab" aria-selected="false">
                                                    Bing
                                                </a>
                                            </li>
                                            <li class="nav-item m-tabs__item">
                                                <a class="nav-link m-tabs__link" data-toggle="tab"
                                                   href="#m_tabs_7_3-{{ detail.user.id }}" role="tab"
                                                   aria-selected="false">
                                                    Facebook
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="m-portlet__body">
                                    <div class="tab-content">
                                        <div class="tab-pane active show" id="m_tabs_7_1-{{ detail.user.id }}"
                                             role="tabpanel">
                                            <p>
                                                {% for cm in detail.aw_to %}
                                                    <span id="{{ cm.dependent_account_id }}"
                                                          class="m-badge m-badge--info m-badge--wide">
                                                CM: {{ cm.dependent_account_name }} <a style="color: #FFF;"
                                                                                       onclick="removeAccount({{ cm.dependent_account_id }}, 'cm', 'adwords')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                CM: No accounts
                                            </span>
                                                {% endfor %}
                                            </p>
                                            <p>
                                                {% for cm2 in detail.aw_cm2 %}
                                                    <span id="{{ cm2.dependent_account_id }}"
                                                          class="m-badge m-badge--success m-badge--wide">
                                                CM2: {{ cm2.dependent_account_name }}
                                                    <a style="color: #FFF;"
                                                       onclick="removeAccount({{ cm2.dependent_account_id }}, 'cm2', 'adwords')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                CM2: No accounts
                                            </span>
                                                {% endfor %}
                                            </p>
                                            <p>
                                                {% for cm3 in detail.aw_cm3 %}
                                                    <span id="{{ cm3.dependent_account_id }}"
                                                          class="m-badge m-badge--warning m-badge--wide">
                                                CM3: {{ cm3.dependent_account_name }} <a style="color: #FFF;"
                                                                                         onclick="removeAccount({{ cm3.dependent_account_id }}, 'cm3', 'adwords')">X</a>
                                                    </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                CM3: No accounts
                                            </span>
                                                {% endfor %}
                                            </p>
                                        </div>
                                        <div class="tab-pane" id="m_tabs_7_2-{{ detail.user.id }}" role="tabpanel">
                                            <p>
                                                {% for cm in detail.bing_to %}
                                                    <span id="{{ cm.account_id }}"
                                                          class="m-badge m-badge--primary m-badge--wide">
                                                CM: {{ cm.account_name }} <a style="color: #FFF;"
                                                                             onclick="removeAccount({{ cm.account_id }}, 'cm', 'bing')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">CM: No accounts</span>
                                                {% endfor %}
                                            </p>
                                            <p>
                                                {% for cm2 in detail.bing_cm2 %}
                                                    <span id="{{ cm2.account_id }}"
                                                          class="m-badge m-badge--success m-badge--wide">
                                                CM2: {{ cm2.account_name }} <a style="color: #FFF;"
                                                                               onclick="removeAccount({{ cm2.account_id }}, 'cm2', 'bing')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                CM2: No accounts
                                            </span>
                                                {% endfor %}
                                            </p>
                                            <p>
                                                {% for cm3 in detail.bing_cm3 %}
                                                    <span id="{{ cm3.account_id }}"
                                                          class="m-badge m-badge--warning m-badge--wide">
                                                CM3: {{ cm3.account_name }} <a style="color: #FFF;"
                                                                               onclick="removeAccount({{ cm3.account_id }}, 'cm3', 'bing')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                CM3: No accounts
                                            </span>
                                                {% endfor %}
                                            </p>
                                        </div>
                                        <div class="tab-pane" id="m_tabs_7_3-{{ detail.user.id }}" role="tabpanel">
                                            <p>
                                                {% for fcm in detail.facebook_to %}
                                                    <span id="{{ fcm.account_id }}"
                                                          class="m-badge m-badge--primary m-badge--wide">CM: {{ fcm.account_name }} <a
                                                            style="color: #FFF;"
                                                            onclick="removeAccount('{{ fcm.account_id }}', 'cm', 'facebook')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">CM: No accounts</span>
                                                {% endfor %}
                                            </p>
                                            <p>
                                                {% for fcm2 in detail.facebook_cm2 %}
                                                    <span id="{{ cm2.account_id }}"
                                                          class="m-badge m-badge--success m-badge--wide">CM2: {{ fcm2.account_name }} <a
                                                            style="color: #FFF;"
                                                            onclick="removeAccount('{{ fcm2.account_id }}', 'cm2', 'facebook')">X</a>
                                                    </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                        CM2: No accounts
                                                    </span>
                                                {% endfor %}
                                            </p>
                                            <p>
                                                {% for fcm3 in detail.facebook_cm3 %}
                                                    <span id="{{ fcm3.account_id }}"
                                                          class="m-badge m-badge--warning m-badge--wide">CM3: {{ fcm3.account_name }} <a
                                                            style="color: #FFF;"
                                                            onclick="removeAccount('{{ fcm3.account_id }}', 'cm3', 'facebook')">X</a>
                                            </span>
                                                {% empty %}
                                                    <span class="m-badge m-badge--danger m-badge--wide">
                                                CM3: No accounts
                                            </span>
                                                {% endfor %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!--End::Main Portlet-->
    </div>

    <!--Modal add accounts-->
    <div class="modal fade" id="m_modal_accounts" tabindex="-1" role="dialog" aria-labelledby="modalAssignAccounts">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Assign accounts</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="uid">
                    <form id="add-accounts">
                        <div class="form-group">
                            <h5>AdWords</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="aw-cm" class="form-control-label">CM:</label>
                                    <select class="form-control m-input--large" name="adwords_cm"
                                            multiple="multiple" id="m_select2_adwords"
                                            style="width: 100%;">
                                        {% for a in adwords %}
                                            <option value="{{ a.dependent_account_id }}">{{ a.dependent_account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="aw-cm2" class="form-control-label">CM2:</label>
                                    <select class="form-control m-input--large" name="adwords_cm2"
                                            multiple="multiple" id="m_select2_adwords_cm2"
                                            style="width: 100%;">
                                        {% for a in adwords %}
                                            <option value="{{ a.dependent_account_id }}">{{ a.dependent_account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="aw-cm" class="form-control-label">CM3:</label>
                                    <select class="form-control m-input--large" name="adwords_cm3"
                                            multiple="multiple" id="m_select2_adwords_cm3"
                                            style="width: 100%;">
                                        {% for a in adwords %}
                                            <option value="{{ a.dependent_account_id }}">{{ a.dependent_account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <h5>Bing</h5>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="aw-cm" class="form-control-label">CM:</label>
                                    <select class="form-control m-input--large" name="bing_cm"
                                            multiple="multiple" id="m_select2_bing"
                                            style="width: 100%;">
                                        {% for b in bing %}
                                            <option value="{{ b.account_id }}">{{ b.account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="aw-cm2" class="form-control-label">CM2:</label>
                                    <select class="form-control m-input--large" name="bing_cm2"
                                            multiple="multiple" id="m_select2_bing_cm2"
                                            style="width: 100%;">
                                        {% for b in bing %}
                                            <option value="{{ b.account_id }}">{{ b.account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="aw-cm" class="form-control-label">CM3:</label>
                                    <select class="form-control m-input--large" name="bing_cm3"
                                            multiple="multiple" id="m_select2_bing_cm3"
                                            style="width: 100%;">
                                        {% for b in bing %}
                                            <option value="{{ b.account_id }}">{{ b.account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <h5>Facebook</h5>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="facebook" class="form-control-label">CM:</label>
                                    <select class="form-control m-input--large" name="facebook"
                                            multiple="multiple" id="m_select2_facebook"
                                            style="width: 100%;">
                                        {% for f in facebook %}
                                            <option value="{{ f.account_id }}">{{ f.account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="facebook_cm2" class="form-control-label">CM2:</label>
                                    <select class="form-control m-input--large" name="facebook_cm2"
                                            multiple="multiple" id="m_select2_facebook_cm2"
                                            style="width: 100%;">
                                        {% for f in facebook %}
                                            <option value="{{ f.account_id }}">{{ f.account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="facebook_cm3" class="form-control-label">CM3:</label>
                                    <select class="form-control m-input--large" name="facebook_cm3"
                                            multiple="multiple" id="m_select2_facebook_cm3"
                                            style="width: 100%;">
                                        {% for f in facebook %}
                                            <option value="{{ f.account_id }}">{{ f.account_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" onclick="submitAccounts()" class="btn btn-primary">Submit</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!--End::Modal add accounts -->

    <!--Modal add new user-->
    <div class="modal fade" id="m_modal_add_user" tabindex="-1" role="dialog" aria-labelledby="modal_add_user">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Create User</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="m-form" id="m_form_add_user">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="input_username">Username:</label>
                                        <input type="text" name="username" class="form-control m-input"
                                               placeholder="Please enter a username">
                                        <span class="m-form__help">Required. 150 characters or fewer.</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="input_first_name">Password:</label>
                                        <input type="password" name="password" id="password"
                                               class="form-control m-input"
                                               placeholder="********">
                                        <span class="m-form__help">
                                   <p>Your password must contain at least 8 characters and can't be entirely numeric.</p>
                                </span>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="input_last_name">Password confirmation:</label>
                                        <input type="password" name="confirm_password" class="form-control m-input"
                                               placeholder="********">
                                        <span class="m-form__help">Enter the same password as before, for verification.</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="input_first_name">First Name:</label>
                                        <input type="text" name="first_name" class="form-control m-input"
                                               placeholder="Please enter first name">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="input_last_name">Last Name:</label>
                                        <input type="text" name="last_name" class="form-control m-input"
                                               placeholder="Please enter last name">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-form__group">
                                <label for="input_email">Email address:</label>
                                <input type="email" name="email" class="form-control m-input"
                                       placeholder="example@domain.com">
                            </div>
                            <div class="m-form__group form-group">
                                <label for="">Permissions:</label>
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" name="is_staff"> Staff Member
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" onclick="submitNewUser()" class="btn btn-brand">Submit</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!--End::Modal add new user -->

    <!--Modal delete user-->
    <div class="modal fade" id="m_modal_delete_user" tabindex="-1" role="dialog" aria-labelledby="modalDeleteUser">
        <div class="modal-dialog modal-md modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="m_title_username">
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="d_uid">
                    <span class="text-center">Are you sure you want to delete the user?</span>
                </div>
                <div class="modal-footer">
                    <button type="submit" onclick="deleteUser()" class="btn btn-primary">Yes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                </div>
            </div>
        </div>
    </div>
    <!--End::Modal delete user -->

    <script type="text/javascript">

        function deleteUser() {
            let uid = $('#d_uid').val();
            let data = JSON.stringify({
                'user_id': uid
            });
            $.ajax({
                type: "POST",
                url: "/users/delete",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: data,
                complete: function() {
                    setTimeout(function () {
                        location.reload();
                    }, 2500);
                },
                success: function (data) {
                    $('#m_modal_delete_user').modal('hide');
                    toastr.success(data['username'] + ' deleted from the database');
                },
                error: function (ajaxContext) {
                        toastr.error(ajaxContext.statusText)
                }
            })
        }

        function removeAccount(acc_id, cm_lvl, platform) {

            data = JSON.stringify({
                'acc_id': acc_id,
                'cm': cm_lvl,
                'platform': platform
            });

            $.ajax({
                type: "POST",
                url: "/users/accounts/delete",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: data,
                complete: function () {
                    setTimeout(function () {
                        location.reload();
                    }, 2500);
                },
                success: function () {
                    swal({
                        "title": "",
                        "text": "Removed account from user profile.",
                        "type": "success",
                        "confirmButtonClass": "btn btn-secondary m-btn m-btn--wide"
                    });
                }
            })
                .done(function (data) {
                    if (data['error'] === 'OK') {
                        console.log('OK');
                    }
                });
        }

        function submitAccounts() {

            var accounts = $('#add-accounts').serializeArray();
            var uid = $('#uid').val();
            accounts.push({name: 'uid', value: uid});

            $.ajax({
                type: "POST",
                url: "",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $.param(accounts),
                complete: function () {
                    setTimeout(function () {
                        location.reload();
                    }, 2500);
                },
                success: function () {
                    swal({
                        "title": "",
                        "text": "Accounts assigned to user profile.",
                        "type": "success",
                        "confirmButtonClass": "btn btn-secondary m-btn m-btn--wide"
                    });
                }
            }).done(function (data) {
                if (data['error'] === 'OK') {
                    console.log('Added!');
                }
            });
        }

        function submitNewUser() {
            let form = $('#m_form_add_user');
            let modal = $('#m_modal_add_user');
            let data = form.serializeArray();

            $.validator.addMethod('specialChars', function (value) {
                return /^[a-zA-Z0-9@.+\-_]+$/.test(value);
            }, 'Letters, digits and  @/./+/-/_ characters are permitted.');

            let validator = form.validate({
                ignore: ":hidden",

                rules: {
                    username: {
                        required: true,
                        minlength: 3,
                        maxlength: 150,
                        specialChars: true,
                    },
                    password: {
                        required: true,
                        minlength: 8
                    },
                    confirm_password: {
                        required: true,
                        minlength: 8,
                        equalTo: '#password'
                    },
                    first_name: {
                        required: true,
                    },
                    last_name: {
                        required: true,
                    },
                    email: {
                        required: true,
                        email: true,
                    }

                },
                messages: {
                    username: {
                        required: 'Please enter a username.',
                        minlength: jQuery.validator.format('At least {0} characters are required.'),
                        maxlength: jQuery.validator.format('At least {0} characters are required.'),
                        specialChar: true,
                    },
                    password: {
                        required: 'A password for the new user is required.',
                        minlength: jQuery.validator.format('At least {0} characters are required.'),
                    },
                    confirm_password: {
                        required: 'The confirmation for password is required.',
                        minlength: jQuery.validator.format('At least {0} characters are required.'),
                        equalTo: 'Passwords must be the same.'
                    },
                    first_name: {
                        required: 'Please enter first name for the new user.'
                    },
                    last_name: {
                        required: 'Please enter last name for the new user.'
                    },
                },
            });

            if(validator.form()){
                $.ajax({
                    url: '/users/add',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    type: 'POST',
                    data: data,

                    success: function (data) {
                        if(data['error_message']) {
                            toastr.error(data['error_message'])
                        } else {
                            toastr.success('User ' + data['username'] + ' added to database.');
                            modal.modal('hide');
                            form.trigger('reset');
                        }
                    },
                    error: function (ajaxContext) {
                        toastr.error(ajaxContext.statusText)
                    },
                    complete: function () {
                        setTimeout(function () {
                            location.reload();
                        }, 3500);
                    }
                });
            }
        }
    </script>


{% endblock %}