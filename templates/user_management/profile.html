<!DOCTYPE html>
{% extends 'main.html' %}
{% load staticfiles %}

{% load template_filters %}
{% load notification_tags %}
{% load humanize %}
{% load custom_filters %}
{% load template_filters %}

{% block extraCss %}
    <style>
        #my_skills_datatable td, th {
            text-align: center;
        }

        #reports_datatable {
            text-align: center;
        }
        .late-onboard:hover {
            cursor:pointer;
        }

    </style>
{% endblock %}

{% block leftAside %}
{% endblock %}

{% block content %}
    <div class="m-content">
        {% with notifications=request.user|get_unread_notifications %}
            {% if notifications.count > 0 %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    </button>
                    <strong>Heads Up!</strong> You have unread notifications.
                </div>
            {% endif %}
        {% endwith %}
        {% if backups.count > 0 %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                </button>
                <strong>Reminder!</strong> You currently are backing up {{ backups.count }} accounts. Don't forget to
                check on them!
            </div>
        {% endif %}
        {% if star_accounts.count > 0 %}
            <div class="alert alert-primary alert-dismissible fade show" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                </button>
                <strong>Flagged account alert!</strong> You are assigned to {{ star_accounts.count }} flagged accounts.
                You can find them in the <strong>Flagged Accounts</strong> section below.
            </div>
        {% endif %}
        <div class="row">
            <div class="col-xl-4">
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    {{ member.user.first_name }} {{ member.user.last_name }}
                                    &nbsp;
                                    <a href="/user_management/members/{{ member.id }}/edit" style="color: #000;">
                  <span class="la la-edit">
                  </span>
                                    </a>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <div class="form-group m-form__group">
                            <label for="input_email">Email address:</label>
                            <input type="email" class="form-control m-input" value="{{ member.user.email }}" disabled>
                        </div>
                        <div class="form-group m-form__group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="team">Team:</label>
                                    {% for team in member.team.all %}
                                        <input type="text" class="form-control m-input" value="{{ team.name }}"
                                               disabled>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <label for="role">Role:</label>
                                    <input type="text" class="form-control m-input" value="{{ member.role.name }}"
                                           disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    KPIs
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'>
                            <thead>
                            <tr>
                                <th>
                                    Account
                                </th>
                                <th>
                                    ROAS
                                </th>
                                <th>
                                    Target ROAS
                                </th>
                                <th>
                                    CPA
                                </th>
                                <th>
                                    Target CPA
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for account in accounts %}
                                <tr>
                                    <td>
                                        <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>
                                    </td>
                                    {% if account.target_roas > 0.0 %}
                                        <td>
                                            {{ account.roas_this_month|format_money }}
                                        </td>
                                        <td>
                                            {{ account.target_roas|format_money }}
                                        </td>
                                    {% else %}
                                        <td>
                                            None
                                        </td>
                                        <td>
                                            None
                                        </td>
                                    {% endif %}
                                    {% if account.target_cpa > 0.0 %}
                                        <td>
                                            {{ account.cpa_this_month|format_money }}
                                        </td>
                                        <td>
                                            {{ account.target_cpa|format_money }}
                                        </td>
                                    {% else %}
                                        <td>
                                            None
                                        </td>
                                        <td>
                                            None
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    My Hours This Month
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="my_hours_datatable">
                            <thead>
                            <tr>
                                <th>
                                    Account
                                </th>
                                <th>
                                    Hours
                                </th>
                                <th>
                                    Month
                                </th>
                                <th>
                                    Date Added
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for hourRow in hoursThisMonth %}
                                <tr>
                                    <td>
                                        {{ hourRow.account.client_name }}
                                    </td>
                                    <td>
                                        {{ hourRow.hours }}
                                    </td>
                                    <td>
                                        {{ hourRow.get_month_display }}, {{ hourRow.year }}
                                    </td>
                                    <td>
                                        {{ hourRow.created_at }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% if trainer_hours_this_month.count > 0 %}
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        Trainer Hours This Month
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="my_hours_datatable">
                                <thead>
                                <tr>
                                    <th>
                                        Trainee
                                    </th>
                                    <th>
                                        Hours
                                    </th>
                                    <th>
                                        Month
                                    </th>
                                    <th>
                                        Date Added
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for hourRow in trainer_hours_this_month %}
                                    <tr>
                                        <td>
                                            {{ hourRow.trainee.user.get_full_name }}
                                        </td>
                                        <td>
                                            {{ hourRow.hours }}
                                        </td>
                                        <td>
                                            {{ hourRow.get_month_display }}, {{ hourRow.year }}
                                        </td>
                                        <td>
                                            {{ hourRow.created }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
                {% if trainee_hours_this_month.count > 0 %}
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        Trainee Hours This Month
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="my_hours_datatable">
                                <thead>
                                <tr>
                                    <th>
                                        Trainer
                                    </th>
                                    <th>
                                        Hours
                                    </th>
                                    <th>
                                        Month
                                    </th>
                                    <th>
                                        Date Added
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for hourRow in trainee_hours_this_month %}
                                    <tr>
                                        <td>
                                            {{ hourRow.trainee.user.get_full_name }}
                                        </td>
                                        <td>
                                            {{ hourRow.hours }}
                                        </td>
                                        <td>
                                            {{ hourRow.get_month_display }}, {{ hourRow.year }}
                                        </td>
                                        <td>
                                            {{ hourRow.created }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
                {% if value_added_hours.count > 0 %}
                    <!-- value added hours -->
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        My Value Added Hours This Month
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="my_value_hours_datatable">
                                <thead>
                                <tr>
                                    <th>
                                        Account
                                    </th>
                                    <th>
                                        Hours
                                    </th>
                                    <th>
                                        Month
                                    </th>
                                    <th>
                                        Date Added
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for hourRow in value_added_hours %}
                                    <tr>
                                        <td>
                                            {{ hourRow.account.client_name }}
                                        </td>
                                        <td>
                                            {{ hourRow.hours }}
                                        </td>
                                        <td>
                                            {{ hourRow.get_month_display }}, {{ hourRow.year }}
                                        </td>
                                        <td>
                                            {{ hourRow.created_at }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
                <!-- End value added hours -->
            </div>
            <div class="col-xl-8">
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Hours
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <div class="m-portlet ">
                            <div class="m-portlet__body  m-portlet__body--no-padding">
                                <div class="m-portlet__body m-portlet__body--no-padding">
                                    <div class="row m-row--no-padding m-row--col-separator-xl">
                                        <div class="col-md-12 col-lg-12 col-xl-4">
                                            <div class="m-widget1">
                                                <div class="m-widget1__item">
                                                    <div class="row m-row--no-padding align-items-center">
                                                        <div class="col">
                                                            <h3 class="m-widget1__title">Allocated Hours</h3>
                                                            <span class="m-widget1__desc">This month</span>
                                                        </div>
                                                        <div class="col m--align-right">
                                                            <span class="m-widget1__number m--font-brand">{{ member.allocated_hours_this_month|floatformat:2 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="m-widget1__item">
                                                    <div class="row m-row--no-padding align-items-center">
                                                        <div class="col">
                                                            <h3 class="m-widget1__title">Value Added Hours</h3>
                                                            <span class="m-widget1__desc">This month</span>
                                                        </div>
                                                        <div class="col m--align-right">
                                                            <span class="m-widget1__number m--font-accent">{{ member.value_added_hours_this_month|floatformat:2 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 col-lg-12 col-xl-4">
                                            <div class="m-widget1">
                                                <div class="m-widget1__item">
                                                    <div class="row m-row--no-padding align-items-center">
                                                        <div class="col">
                                                            <h3 class="m-widget1__title">Hours Available</h3>
                                                            <span class="m-widget1__desc">This month</span>
                                                        </div>
                                                        <div class="col m--align-right">
                                                            <span class="m-widget1__number m--font-accent">{{ member.hours_available|floatformat:2 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="m-widget1__item">
                                                    <div class="row m-row--no-padding align-items-center">
                                                        <div class="col">
                                                            <h3 class="m-widget1__title">Training Hours</h3>
                                                            <span class="m-widget1__desc">This month</span>
                                                        </div>
                                                        <div class="col m--align-right">
                                                            <span class="m-widget1__number m--font-info">{{ trainee_hour_total }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 col-lg-12 col-xl-4">
                                            <div class="m-widget1">
                                                <div class="m-widget1__item">
                                                    <div class="row m-row--no-padding align-items-center">
                                                        <div class="col">
                                                            <h3 class="m-widget1__title">Actual Hours</h3>
                                                            <span class="m-widget1__desc">This month</span>
                                                        </div>
                                                        <div class="col m--align-right">
                                                            <span class="m-widget1__number m--font-success">{{ member.actual_hours_this_month|floatformat:2 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row m-row--no-padding m-row--col-separator-xl" style="margin-top:0.5rem;">
                                    <div class="progress m-progress--lg" style="width:100%;">
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ member.buffer_learning_percentage }}%"
                                             data-toggle="m-tooltip"
                                             data-original-title="Learning Buffer: {{ member.learning_hours }} hours"
                                             aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-warning" role="progressbar"
                                             style="width: {{ member.buffer_trainers_percentage }}%"
                                             data-toggle="m-tooltip"
                                             data-original-title="Trainer Buffer: {{ member.training_hours }} hours"
                                             aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             style="width: {{ member.buffer_sales_percentage }}%"
                                             data-toggle="m-tooltip"
                                             data-original-title="Sales Buffer: {{ member.sales_hours }} hours"
                                             aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-info" role="progressbar"
                                             style="width: {{ member.buffer_planning_percentage }}%"
                                             data-toggle="m-tooltip"
                                             data-original-title="Planning Buffer: {{ member.planning_hours }} hours"
                                             aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ member.buffer_internal_percentage }}%"
                                             data-toggle="m-tooltip"
                                             data-original-title="Internal Buffer: {{ member.internal_hours }} hours"
                                             aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ member.allocated_hours_percentage }}%"
                                             data-toggle="m-tooltip"
                                             data-original-title="Allocated Hours: {{ member.allocated_hours_this_month }} hours"
                                             aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if onboarding_accounts.count > 0 %}
                    <!-- Onboarding accounts -->
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        Onboarding Accounts
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            {% for account in onboarding_accounts %}
                                <div class="onboard-account" style="border: 1px solid #f4f5f8; padding: 1rem 1rem 0rem 1rem;">
                                    <div class="row">
                                        <div class="col-12">
                                            <a href="/clients/accounts/{{ account.id }}"><h4 style="display:inline;" {% if account.late_onboard_reason != None %}data-toggle="m-tooltip" data-original-title="{{ account.late_onboard_reason }}"{% endif %}>{{ account.client_name }}</h4></a>&nbsp;&nbsp;<span class="m-badge m-badge--{% if account.is_late_to_onboard %}danger{% else %}info{% endif %}" style="margin-bottom: 0.5rem;">{{ account.onboarding_duration_elapsed }}</span>
                                        </div>
                                    </div>
                                    <br />
                                    {% if account.has_ppc %}
                                    <div class="row">
                                        <div class="col-1">
                                            <span class="m-badge m-badge--{% if account.is_late_to_onboard %}danger late-onboard{% else %}info{% endif %} m-badge--wide m-badge--rounded"
                                                  data-account-id="{{ account.id }}" {% if account.is_late_to_onboard %}data-toggle="modal" data-target="#late_onboard_modal"{% endif %}
                                                  style="width:100%; {% if account.ppc_onboarding_steps_complete %}background:#34bfa3;{% endif %}">
                                                {% if account.ppc_onboarding_steps_complete %}Complete{% else %}{% if not account.is_late_to_onboard %}On pace{% else %}Late{% endif %}{% endif %}
                                            </span>
                                        </div>
                                        <div class="col-11">
                                            <div class="m-list-badge m--margin-bottom-20">
                                                <div class="m-list-badge__label m--font-info">PPC</div>
                                                <div class="m-list-badge__items">
                                                    {% for step in account.ppc_steps %}
                                                        <a href="/clients/accounts/onboard/{{ account.id }}" class="m-list-badge__item m-list-badge__item--{% if step.complete %}success{% else %}metal{% endif %}">{{ step.step.name }}</a>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if account.has_seo %}
                                    <div class="row">
                                        <div class="col-1">
                                            <span class="m-badge m-badge--{% if account.is_late_to_onboard %}danger late-onboard{% else %}info{% endif %} m-badge--wide m-badge--rounded"
                                                  data-account-id="{{ account.id }}" {% if account.is_late_to_onboard %}data-toggle="modal" data-target="#late_onboard_modal"{% endif %}
                                                  style="width:100%; {% if account.seo_onboarding_steps_complete %}background:#34bfa3;{% endif %}">
                                                {% if account.seo_onboarding_steps_complete %}Complete{% else %}{% if not account.is_late_to_onboard %}On pace{% else %}Late{% endif %}{% endif %}</span>
                                        </div>
                                        <div class="col-11">
                                            <div class="m-list-badge m--margin-bottom-20">
                                                <div class="m-list-badge__label m--font-info">SEO</div>
                                                <div class="m-list-badge__items">
                                                    {% for step in account.seo_steps %}
                                                        <a href="/clients/accounts/onboard/{{ account.id }}" class="m-list-badge__item m-list-badge__item--{% if step.complete %}success{% else %}metal{% endif %}">{{ step.step.name }}</a>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if account.has_cro %}
                                    <div class="row">
                                        <div class="col-1">
                                            <span class="m-badge m-badge--{% if account.is_late_to_onboard %}danger late-onboard{% else %}info{% endif %} m-badge--wide m-badge--rounded"
                                                  data-account-id="{{ account.id }}" {% if account.is_late_to_onboard %}data-toggle="modal" data-target="#late_onboard_modal"{% endif %}
                                                  style="width:100%; {% if account.cro_onboarding_steps_complete %}background:#34bfa3;{% endif %}">
                                                {% if account.cro_onboarding_steps_complete %}Complete{% else %}{% if not account.is_late_to_onboard %}On pace{% else %}Late{% endif %}{% endif %}</span>
                                        </div>
                                        <div class="col-11">
                                            <div class="m-list-badge m--margin-bottom-20">
                                                <div class="m-list-badge__label m--font-info">CRO</div>
                                                <div class="m-list-badge__items">
                                                    {% for step in account.cro_steps %}
                                                        <a href="/clients/accounts/onboard/{{ account.id }}" class="m-list-badge__item m-list-badge__item--{% if step.complete %}success{% else %}metal{% endif %}">{{ step.step.name }}</a>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- end Onboarding accounts -->
                {% endif %}

                <!-- Accounts -->
                {% if accounts.count > 0 %}
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        My Accounts
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            {% for account in accounts %}
                                <div class="row" style="border: 1px solid #f4f5f8; padding: 1rem 1rem 1rem 1rem;">
                                    <div class="col-3">
                                        <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>
                                        <p>My hours this month: {{ accountHours|get_item_from_list:account.id  }}/{{ accountAllocation|get_item_from_list:account.id }}</p>
                                        <div class="m--space-30">
                                            {% with aw=account.adwords.all bing=account.bing.all fb=account.facebook.all %}
                                                <span class="m-badge {% if aw %}m-badge--primary{% endif %}"
                                                      data-toggle="m-tooltip"
                                                      data-original-title="
                                                        {% if aw %}
                                                            {% for a in aw %}
                                                                {{ a.dependent_account_name }}{% if not forloop.last %},{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            No AdWords Account
                                                        {% endif %}">A</span>
                                                <span class="m-badge {% if bing %}m-badge--success{% endif %}"
                                                      data-toggle="m-tooltip"
                                                      data-original-title="
                                                        {% if bing %}
                                                            {% for b in bing %}
                                                                {{ b.account_name }}{% if not forloop.last %},{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            No Bing Account
                                                        {% endif %}">B</span>
                                                <span class="m-badge {% if fb %}m-badge--info{% endif %}"
                                                      data-toggle="m-tooltip"
                                                      data-original-title="
                                                        {% if fb %}
                                                            {% for f in fb %}
                                                                {{ f.account_name }}{% if not forloop.last %},{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            No Facebook Account
                                                        {% endif %}">F</span>
                                            {% endwith %}
                                        </div>
                                    </div>
                                    <div class="col-9">
                                        <div class="row">
                                            <div class="col-md-4"><b>Current</b>:
                                                {{ account.currency }}{{ account.current_spend|floatformat:2|intcomma }}
                                            </div>
                                            <div class="col-md-4"><b>Budget</b>:
                                                {{ account.currency }}{{ account.current_budget|intcomma }}
                                            </div>
                                            <div class="col-md-4">
                                                <b>Projected</b>:
                                                {{ account.currency }}{{ account.project_average|floatformat:2|intcomma }}
                                            </div>
                                        </div>
                                        <div class="progress m-progress--lg"
                                             style="position: relative!important; height:30px !important;">
                                            <div id="{{ account.id }}_progressbar"
                                                 class="progress-bar {% if account.underpacing_average %}bg-warning{% elif account.project_average > account.current_budget %}bg-danger{% else %}bg-success{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ account.spend_percentage }}%;"
                                                 aria-valuemin="0" aria-valuemax="100"
                                                 aria-valuenow="{{ account.spend_percentage }}"
                                                 data-toggle="m-tooltip" data-placement="top" title=""
                                                 data-original-title="{{ account.current_spend }}/{{ account.current_budget }}">
                                                {{ account.spend_percentage|floatformat:2 }}%
                                            </div>
                                            <div class="black-marker"
                                                 style="width: {{ black_marker }}%"
                                                 aria-valuenow="{{ black_marker }}"
                                                 aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            {% endfor %}
{#                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'#}
{#                                   id="my_clients_datatable">#}
{#                                <thead class="thead-inverse">#}
{#                                <tr class="main-table-header">#}
{#                                    <th>#}
{#                                        Client#}
{#                                    </th>#}
{#                                    <th>Account</th>#}
{#                                    <th>#}
{#                                        My Actual Hours#}
{#                                    </th>#}
{#                                    <th>#}
{#                                        My Allocated Hours#}
{#                                    </th>#}
{#                                    <th>#}
{#                                        Total Actual Hours#}
{#                                    </th>#}
{#                                    <th>#}
{#                                        Total Allocated Hours#}
{#                                    </th>#}
{#                                </tr>#}
{#                                </thead>#}
{#                                <tbody>#}
{#                                {% for account in accounts %}#}
{#                                    <tr>#}
{#                                        <td>#}
{#                                            {{ account.parentClient.name }}#}
{#                                        </td>#}
{#                                        <td>#}
{#                                            <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>#}
{#                                        </td>#}
{#                                        <td>#}
{#                                            {{ accountHours|get_item_from_list:account.id }}#}
{#                                        </td>#}
{#                                        <td>#}
{#                                            {{ accountAllocation|get_item_from_list:account.id }}#}
{#                                        </td>#}
{#                                        <td>#}
{#                                            {{ account.hoursWorkedThisMonth|floatformat:2 }}#}
{#                                        </td>#}
{#                                        <td>#}
{#                                            {{ account.all_hours|floatformat:2 }}#}
{#                                        </td>#}
{#                                    </tr>#}
{#                                {% endfor %}#}
{#                                </tbody>#}
{#                            </table>#}
                        </div>
                    </div>
                {% endif %}
                <!-- end accounts -->

                {% if backups.count > 0 %}
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        My Backup Accounts
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="my_backup_clients_datatable">
                                <thead class="thead-inverse">
                                <tr class="main-table-header">
                                    <th>
                                        Client
                                    </th>
                                    <th>Account</th>
                                    <th>
                                        My Actual Hours
                                    </th>
                                    <th>
                                        Total Actual Hours
                                    </th>
                                    <th>
                                        Total Allocated Hours
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for backup in backups %}
                                    <tr>
                                        <td>
                                            {{ backup.account.parentClient.name }}
                                        </td>
                                        <td>
                                            <a href="/clients/accounts/{{ backup.account.id }}">{{ backup.account.client_name }}</a>
                                        </td>
                                        <td>
                                            {# backupHours|get_item_from_list:account.id #} 0
                                        </td>
                                        <td>
                                            {{ backup.account.hoursWorkedThisMonth|floatformat:2 }}
                                        </td>
                                        <td>
                                            {{ backup.account.all_hours|floatformat:2 }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                {% if star_accounts.count > 0 %}
                    <!-- Being starred accounts (admin only) -->
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        Flagged Accounts
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="star_clients_datatable">
                                <thead class="thead-inverse">
                                <tr class="main-table-header">
                                    <th>
                                        Client
                                    </th>
                                    <th>Account</th>
                                    <th>
                                        Total Actual Hours
                                    </th>
                                    <th>
                                        Total Allocated Hours
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for account in star_accounts %}
                                    <tr>
                                        <td>
                                            {{ account.parentClient.name }}
                                        </td>
                                        <td>
                                            <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>
                                        </td>
                                        <td>
                                            {{ account.hoursWorkedThisMonth|floatformat:2 }}
                                        </td>
                                        <td>
                                            {{ account.all_hours|floatformat:2 }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- End starred accounts -->
                {% endif %}

                <!-- reporting portlet -->
                {% if reporting_period %}
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        {% csrf_token %}
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        {{ last_month_str }} Reports
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="reports_datatable">
                                <thead class="thead-inverse">
                                <tr class="main-table-header">
                                    <th>
                                        Account
                                    </th>
                                    <th>
                                        Report Type
                                    </th>
                                    <th>
                                        Due Date
                                    </th>
                                    <th>
                                        AM
                                    </th>
                                    <th>
                                        Sent to AM
                                    </th>
                                    <th>
                                        Sent to Client
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for report in reports %}
                                    <tr>
                                        <td>
                                            <a href="/clients/accounts/{{ report.account.id }}">{{ report.report_name }}</a>
                                        </td>
                                        <td>
                                            {% if report.report_type != None %}
                                                {{ report.get_report_type_display }}
                                            {% else %}

                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if report.due_date == None %}
                                                <div class="form-group m-form__group row">
                                                    <div class="col-lg-12 col-md-12 col-sm-12">
                                                        <input type="text" data-account="{{ report.account.id }}"
                                                               class="form-control m_datepicker"
                                                               readonly="" placeholder="Set Due Date Here">
                                                    </div>
                                                </div>
                                            {% else %}
                                                {{ report.due_date }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ report.account.main_am }}
                                        </td>
                                        <td>
                                            <label class="m-checkbox">
                                                <input type="checkbox" class="sent-to-am"
                                                       data-account="{{ report.account.id }}"
                                                        {% if report.received_by_am %} checked disabled{% endif %}>
                                                <span></span>
                                            </label>
                                        </td>
                                        <td>
                                            <label class="m-checkbox">
                                                <input type="checkbox" class="sent-to-client"
                                                       data-account="{{ report.account.id }}" {% if report.sent_by_am %}
                                                       checked disabled{% endif %}>
                                                <span></span>
                                            </label>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
                <!-- end reporting portlet -->
                {% if promos.count > 0 %}
                    <!-- Calendar promos -->
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text">
                                        Promos
                                    </h3>
                                </div>
                            </div>
                            <div class="m-portlet__head-tools">
                                <ul class="nav nav-tabs m-tabs m-tabs-line  m-tabs-line--right" role="tablist">
                                    <li class="nav-item m-tabs__item">
                                        <a class="nav-link m-tabs__link active show" data-toggle="tab"
                                           href="#m_tabs_7_1" role="tab" aria-selected="true">
                                            Calendar
                                        </a>
                                    </li>
                                    <li class="nav-item m-tabs__item">
                                        <a class="nav-link m-tabs__link" data-toggle="tab" href="#m_tabs_7_2" role="tab"
                                           aria-selected="false">
                                            Summary
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <div class="tab-content">
                                <div class="tab-pane active show" id="m_tabs_7_1" role="tabpanel">
                                    <div id="calendar" class="fc fc-unthemed fc-ltr">

                                    </div>
                                </div>
                                <div class="tab-pane active show" id="m_tabs_7_2" role="tabpanel">
                                    <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                           id="account_change_datatable">
                                        <thead class="thead-inverse">
                                        <tr class="main-table-header">
                                            <th>
                                                Promo Name
                                            </th>
                                            <th>
                                                Start Date
                                            </th>
                                            <th>
                                                End Date
                                            </th>
                                            <th>
                                                Desc
                                            </th>
                                            <th>
                                                Services
                                            </th>
                                            <th>
                                                Confirmed Started
                                            </th>
                                            <th>
                                                Confirmed Ended
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for promo in promos %}
                                            <tr>
                                                <td>
                                                    {{ promo }}
                                                </td>
                                                <td>
                                                    {{ promo.start_date }}
                                                </td>
                                                <td>
                                                    {{ promo.end_date }}
                                                </td>
                                                <td>
                                                    {{ promo.desc }}
                                                </td>
                                                <td>
                                                    {{ promo.services_str }}
                                                </td>
                                                <td>
                                                    <input type="checkbox" class="confirm-promo"
                                                           data-account-id="{{ promo.account.id }}"
                                                           data-promo-id="{{ promo.id }}"
                                                           data-account-id="{{ account.id }}" data-confirmation-type="0"
                                                           {% if promo.confirmed_started != None %}checked
                                                           disabled{% endif %}/>
                                                </td>
                                                <td>
                                                    <input type="checkbox" class="confirm-promo"
                                                           data-account-id="{{ promo.account.id }}"
                                                           data-promo-id="{{ promo.id }}"
                                                           data-account-id="{{ account.id }}" data-confirmation-type="1"
                                                           {% if promo.confirmed_ended != None %}checked
                                                           disabled{% endif %}/>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end promos -->
                {% endif %}

                {% if backing_me.count > 0 %}
                    <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                        <div class="m-portlet__head">
                            <div class="m-portlet__head-caption">
                                <div class="m-portlet__head-title">
                                    <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                        People backing me up
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="m-portlet__body">
                            <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                                   id="my_backup_clients_datatable">
                                <thead class="thead-inverse">
                                <tr class="main-table-header">
                                    <th>Member</th>
                                    <th>
                                        Account
                                    </th>
                                    <th>
                                        Basecamp
                                    </th>
                                    <th>
                                        Date Range
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for backup_period in backing_me %}
                                    {% for backup in backup_period.backup_set.all %}
                                        <tr>
                                            <td>
                                                <a href="/user_management/accounts/{{ backup.member.id }}">{{ backup.member.user.get_full_name }}</a>
                                            </td>
                                            <td>
                                                <a href="/clients/accounts/{{ backup.account.id }}">{{ backup.account.client_name }}</a>
                                            </td>
                                            <td>
                                                <a href="{{ backup.bc_link }}">Basecamp</a>
                                            </td>
                                            <td>
                                                {{ backup_period.start_date }} - {{ backup_period.end_date }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                <!-- Member skills -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Member Skills
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline'
                               id="my_skills_datatable">
                            <thead class="thead-inverse">
                            <tr class="main-table-header">
                                {% for member_skill in member_skills %}
                                    <th>
                                        {{ member_skill.skill.name }}
                                    </th>
                                {% endfor %}
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                {% for member_skill in member_skills %}
                                    <td>
                                        <span class="m-badge m-badge--
                                                {{ score_badges|get_item_from_list:member_skill.score }}"></span>
                                    </td>
                                {% endfor %}
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- end member skills -->

                <!-- Incidents -->
                <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                                    Incidents
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="m-portlet__body">
                        {% if member.incidents == 0 %}
                            <p>You have no incidents!</p>
                        {% else %}
                            <table class='table table-striped m-table m-table--head-separator-bloom dataTable'>
                                <thead>
                                <tr>
                                    <th>
                                        Date
                                    </th>
                                    <th>
                                        Description
                                    </th>
                                    <th>
                                        Members
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for incident in incidents %}
                                    <tr>
                                        <td>
                                            {{ incident.date }}
                                        </td>
                                        <td>
                                            {{ incident.description }}
                                        </td>
                                        <td>
                                            {% for offender in incident.members.all %}{{ offender }}<br/>{% endfor %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>
                <!-- End incidents -->
            </div>
        </div>

        <!--End::Main Portlet-->
    </div>

    <!-- Flag account -->
    <div class="modal fade" id="late_onboard_modal" tabindex="-1" role="dialog" aria-labelledby="m_position_allocation">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reason for late onboarding</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true"></span>
                    </button>
                </div>
                <form class="m-form" method="POST" action="/user_management/late_onboard">
                    {% csrf_token %}
                    <input name="account_id" id="m_account_id" type="text" value="" style="display:none;"/>
                    <div class="modal-body">
                        <div class="m-portlet__body">
                            <div class="form-group m-form__group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Reason:</label>
                                        <input type="text" name="late_reason" class="form-control m-input" maxlength="140" required/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Submit" class="btn btn-brand">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Flag account modal -->
{% endblock %}

{% block extraJs %}
    <script>
        $(document).ready(function () {
            var $sentToAmCheck = $('.sent-to-am');
            var $sentToClientCheck = $('.sent-to-client');
            var $dueDatePickers = $('.m_datepicker');

            var csrftoken = $("[name=csrfmiddlewaretoken]").val();

            let $promoCheck = $('.confirm-promo');

            $promoCheck.click(function () {
                let confirmation_type = $(this).data('confirmation-type');
                let promo_type = $(this).data('promo-id');
                let account_id = $(this).data('account-id');
                if ($(this).is(':checked')) {
                    $.ajax({
                        url: '/clients/promos/confirm',
                        data: {
                            'account_id': account_id,
                            'promo_id': promo_type,
                            'confirmation_type': confirmation_type
                        },
                        headers: {'X-CSRFToken': csrftoken},
                        type: 'POST',
                        success: function (data) {
                            console.log(data);
                            $(this).prop('disabled', 'disabled');
                        }
                    });
                }

            });

            $('#late_onboard_modal').on('show.bs.modal', function (e) {
                let account_id = $(e.relatedTarget).data('account-id');
                $('#m_account_id').attr('value', account_id);
            });

            $dueDatePickers.datepicker({
                todayHighlight: !0,
                autoclose: !0,
                format: 'yyyy-mm-dd',
                orientation: "bottom left",
                templates: {
                    leftArrow: '<i class="la la-angle-left"></i>',
                    rightArrow: '<i class="la la-angle-right"></i>'
                }
            }).on('show.bs.modal', function (event) {
                event.stopPropagation();
            });

            /**
             * Calendar
             */
            $('#calendar').fullCalendar({
                header: {
                    left: "prev, next, today",
                    center: "title",
                    right: "month, listWeek"
                },
                aspectRatio: 2,
                defaultDate: moment(),
                defaultView: 'month',
                events: [
                    {% for promo in promos %}
                        {
                            title: "{{ promo }}",
                            description: "{{ promo.desc }}",
                            start: moment("{{ promo.formatted_start }}"),
                            end: moment("{{ promo.formatted_end }}"),
                            className: "{% if promo.is_active %}m-fc-event--solid-success{% else %}m-fc-event--solid-warning{% endif %}"
                        }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            });

            /**
             * Checks off report box
             * @param  {string} el  jQuery element
             * @param  {string} url string
             * @return {}
             */
            var checkReportBox = function (el, url) {
                $.ajax({
                    url: '/clients/reports/' + url,
                    data: {
                        'account_id': el.data('account'),
                        'month': {{ reports.0.month }}
                    },
                    headers: {'X-CSRFToken': csrftoken},
                    type: 'POST',
                    success: function (data) {
                        console.log(data);
                    }
                });
            };

            var setDueDate = function (el) {
                $.ajax({
                    url: '/clients/reports/set-due-date',
                    data: {
                        'account_id': el.data('account'),
                        'month': {{ reports.0.month }},
                        'due_date': el.val()
                    },
                    headers: {'X-CSRFToken': csrftoken},
                    type: 'POST',
                    success: function (data) {
                        console.log(data);
                    }
                });
            };

            $dueDatePickers.change(function () {
                setDueDate($(this));
                $(this).attr('disabled', 'disabled');
            });


            $sentToAmCheck.click(function () {
                if ($(this).is(':checked')) {
                    checkReportBox($(this), 'confirm_sent_am');
                    $(this).attr('disabled', 'disabled');
                }
            });

            $sentToClientCheck.click(function () {
                if ($(this).is(':checked')) {
                    checkReportBox($(this), 'confirm_sent_client');
                    $(this).attr('disabled', 'disabled');
                }
            });


        });
    </script>
{% endblock %}
