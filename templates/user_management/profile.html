<!DOCTYPE html>
{% extends 'main.html' %}
{% load staticfiles %}

{% load template_filters %}

{% block extraCss %}
<style>
  #my_skills_datatable td, th {
    text-align: center;
  }

  #reports_datatable {
    text-align: center;
  }
</style>
{% endblock %}

{% block leftAside %}
{% endblock %}

{% block content %}
<div class="m-content">
  <div class="row">
    <div class="col-xl-4">
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                {{ member.user.first_name }} {{ member.user.last_name }}
                &nbsp;
                <a href="/user_management/members/{{ member.id }}/edit" style="color: #000;">
                  <span class="la la-edit">
                  </span>
                </a>
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <div class="form-group m-form__group">
            <label for="input_email">Email address:</label>
            <input type="email" class="form-control m-input" value="{{ member.user.email }}" disabled>
          </div>
          <div class="form-group m-form__group">
            <div class="row">
              <div class="col-md-6">
                <label for="team">Team:</label>
                {% for team in member.team.all %}
                <input type="text" class="form-control m-input" value="{{ team.name }}" disabled>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <label for="role">Role:</label>
                <input type="text" class="form-control m-input" value="{{ member.role.name }}" disabled>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                My Hours This Month
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="my_hours_datatable">
            <thead>
              <tr>
                <th>
                  Account
                </th>
                <th>
                  Hours
                </th>
                <th>
                  Month
                </th>
                <th>
                  Date Added
                </th>
              </tr>
            </thead>
            <tbody>
              {% for hourRow in hoursThisMonth %}
                <tr>
                  <td>
                    {{ hourRow.account.client_name }}
                  </td>
                  <td>
                    {{ hourRow.hours }}
                  </td>
                  <td>
                    {{ hourRow.get_month_display }}, {{ hourRow.year }}
                  </td>
                  <td>
                    {{ hourRow.created_at }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
        <!-- value added hours -->
      {% if value_added_hours.count > 0 %}
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                My Value Added Hours This Month
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="my_value_hours_datatable">
            <thead>
              <tr>
                <th>
                  Account
                </th>
                <th>
                  Hours
                </th>
                <th>
                  Month
                </th>
                <th>
                  Date Added
                </th>
              </tr>
            </thead>
            <tbody>
              {% for hourRow in value_added_hours %}
                <tr>
                  <td>
                    {{ hourRow.account.client_name }}
                  </td>
                  <td>
                    {{ hourRow.hours }}
                  </td>
                  <td>
                    {{ hourRow.get_month_display }}, {{ hourRow.year }}
                  </td>
                  <td>
                    {{ hourRow.created_at }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
      <!-- End value added hours -->
    </div>
    <div class="col-xl-8">
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                Hours
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <div class="m-portlet ">
            <div class="m-portlet__body  m-portlet__body--no-padding">
              <div class="row m-row--no-padding m-row--col-separator-xl">
                <div class="col-md-12 col-lg-6 col-xl-4">
                  <!--begin::Total Profit-->
                  <div class="m-widget24">
                    <div class="m-widget24__item">
                      <h4 class="m-widget24__title">
                        Allocated Hours
                      </h4><br>
                      <span class="m-widget24__desc">
                          Hours to work this month
                      </span>
                      <span class="m-widget24__stats m--font-brand" style="margin-bottom:2.86rem;">
                        {{ member.allocatedHoursMonth|floatformat:2 }}
                      </span>
                    </div>
                  </div>
                  <!--end::Total Profit-->
                </div>
                <div class="col-md-12 col-lg-6 col-xl-4">
                  <!--begin::New Feedbacks-->
                  <div class="m-widget24">
                    <div class="m-widget24__item">
                      <h4 class="m-widget24__title">
                        Hours Available
                      </h4><br>
                      <span class="m-widget24__desc">
                          Hours available to be allocated
                      </span>
                      <span class="m-widget24__stats m--font-info" style="margin-bottom:2.86rem;">
                        {{ member.hours_available|floatformat:2 }}
                      </span>
                    </div>
                  </div>
                  <!--end::New Feedbacks-->
                </div>
                <div class="col-md-12 col-lg-6 col-xl-4">
                  <!--begin::New Orders-->
                  <div class="m-widget24">
                    <div class="m-widget24__item">
                      <h4 class="m-widget24__title">
                        Actual Hours
                      </h4><br>
                      <span class="m-widget24__desc">
                          Hours worked this month
                      </span>
                      <span class="m-widget24__stats m--font-danger" style="margin-bottom:2.86rem;">
                        {{ member.actualHoursThisMonth|floatformat:2 }}
                      </span>
                    </div>
                  </div>
                  <!--end::New Orders-->
                </div>
              </div>
              <br />
              <hr />
              <div class="row m-row--no-padding m-row--col-separator-xl" style="margin-top:0.5rem;">
                <div class="progress m-progress--lg" style="width:100%;">
                  <div class="progress-bar" role="progressbar" style="width: {{ member.buffer_learning_percentage }}%" data-toggle="m-tooltip" data-original-title="Learning Buffer: {{ member.learning_hours }} hours" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                  <div class="progress-bar bg-warning" role="progressbar" style="width: {{ member.buffer_trainers_percentage }}%" data-toggle="m-tooltip" data-original-title="Trainer Buffer: {{ member.training_hours }} hours" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                  <div class="progress-bar bg-danger" role="progressbar" style="width: {{ member.buffer_sales_percentage }}%" data-toggle="m-tooltip" data-original-title="Sales Buffer: {{ member.sales_hours }} hours" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                  <div class="progress-bar bg-info" role="progressbar" style="width: {{ member.buffer_planning_percentage }}%" data-toggle="m-tooltip" data-original-title="Planning Buffer: {{ member.planning_hours }} hours" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                  <div class="progress-bar" role="progressbar" style="width: {{ member.buffer_internal_percentage }}%" data-toggle="m-tooltip" data-original-title="Internal Buffer: {{ member.internal_hours }} hours" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                  <div class="progress-bar bg-success" role="progressbar" style="width: {{ member.allocated_hours_percentage }}%" data-toggle="m-tooltip" data-original-title="Allocated Hours: {{ member.allocatedHoursMonth }} hours" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Accounts -->
      {% if accounts.count > 0 %}
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                My Accounts
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="my_clients_datatable">
            <thead class="thead-inverse">
              <tr class="main-table-header">
                <th>
                  Client
                </th>
                <th>Account</th>
                <th>
                  My Actual Hours
                </th>
                <th>
                  My Allocated Hours
                </th>
                <th>
                  Total Actual Hours
                </th>
                <th>
                  Total Allocated Hours
                </th>
              </tr>
            </thead>
            <tbody>
              {% for account in accounts %}
              <tr>
                <td>
                  {{ account.parentClient.name }}
                </td>
                <td>
                  <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>
                </td>
                <td>
                  {{ accountHours|get_item_from_list:account.id }}
                </td>
                <td>
                  {{ accountAllocation|get_item_from_list:account.id }}
                </td>
                <td>
                  {{ account.hoursWorkedThisMonth|floatformat:2 }}
                </td>
                <td>
                  {{ account.allHours|floatformat:2 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
      <!-- end accounts -->

      <!-- reporting portlet -->
      {% if reporting_period %}
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        {% csrf_token %}
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                {{ month_str }} Reports
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="reports_datatable">
            <thead class="thead-inverse">
              <tr class="main-table-header">
                <th>
                  Account
                </th>
                <th>
                  Report Type
                </th>
                <th>
                  Due Date
                </th>
                <th>
                  Sent to AM
                </th>
                <th>
                  Sent to Client
                </th>
              </tr>
            </thead>
            <tbody>
              {% for report in reports %}
              <tr>
                <td>
                  <a href="/clients/accounts/{{ report.account.id }}">{{ report.report_name }}</a>
                </td>
                <td>
                  {{ report.get_report_type_display }}
                </td>
                <td>
                  {% if report.due_date == None %}
                  <div class="form-group m-form__group row">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <input type="text" data-account="{{ report.account.id }}" class="form-control m_datepicker"
                               readonly="" placeholder="Set Due Date Here">
                    </div>
                  </div>
                  {% else %}
                  {{ report.due_date }}
                  {% endif %}
                </td>
                <td>
                  <label class="m-checkbox">
                    <input type="checkbox" class="sent-to-am" data-account="{{ report.account.id }}" {% if report.received_by_am %} checked disabled{% endif %}>
                    <span></span>
                  </label>
                </td>
                <td>
                  <label class="m-checkbox">
                    <input type="checkbox" class="sent-to-client" data-account="{{ report.account.id }}" {% if report.sent_by_am %} checked disabled{% endif %}>
                    <span></span>
                  </label>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
      <!-- end reporting portlet -->

      <!-- Calendar promos -->
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text">
              Promo Calendar
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <div id="calendar" class="fc fc-unthemed fc-ltr">

          </div>
        </div>
      </div>
      <!-- end promos -->

      {% if request.user.is_staff and starAccounts.count > 0 %}
      <!-- Being starred accounts (admin only) -->
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                Flagged Accounts
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="star_clients_datatable">
            <thead class="thead-inverse">
              <tr class="main-table-header">
                <th>
                  Client
                </th>
                <th>Account</th>
                <th>
                  Total Actual Hours
                </th>
                <th>
                  Total Allocated Hours
                </th>
              </tr>
            </thead>
            <tbody>
              {% for account in starAccounts %}
              <tr>
                <td>
                  {{ account.parentClient.name }}
                </td>
                <td>
                  <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>
                </td>
                <td>
                  {{ account.hoursWorkedThisMonth|floatformat:2 }}
                </td>
                <td>
                  {{ account.allHours|floatformat:2 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- End starred accounts -->
      {% endif %}

      {% if backup_accounts.count > 0 %}
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                My Backup Accounts
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="my_backup_clients_datatable">
            <thead class="thead-inverse">
              <tr class="main-table-header">
                <th>
                  Client
                </th>
                <th>Account</th>
                <th>
                  My Actual Hours
                </th>
                <th>
                  My Allocated Hours
                </th>
                <th>
                  Total Actual Hours
                </th>
                <th>
                  Total Allocated Hours
                </th>
              </tr>
            </thead>
            <tbody>
              {% for account in backupAccounts %}
              <tr>
                <td>
                  {{ account.parentClient.name }}
                </td>
                <td>
                  <a href="/clients/accounts/{{ account.id }}">{{ account.client_name }}</a>
                </td>
                <td>
                  {{ backupHours|get_item_from_list:account.id }}
                </td>
                <td>
                  {{ backupAccountAllocation|get_item_from_list:account.id }}
                </td>
                <td>
                  {{ account.hoursWorkedThisMonth|floatformat:2 }}
                </td>
                <td>
                  {{ account.allHours|floatformat:2 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Member skills -->
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                Member Skills
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          <table class='table table-striped table-bordered table-hover table-checkable dataTable no-footer dtr-inline' id="my_skills_datatable">
            <thead class="thead-inverse">
              <tr class="main-table-header">
                {% for memberSkill in memberSkills %}
                <th>
                  {{ memberSkill.skill.name }}
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for memberSkill in memberSkills %}
                <td>
                  <span class="m-badge m-badge--{{ scoreBadges|get_item_from_list:memberSkill.score }}"></span>
                </td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- end member skills -->

      <!-- Incidents -->
      <div class="m-portlet m-portlet--mobile m-portlet--body-progress-">
        <div class="m-portlet__head">
          <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
              <h3 class="m-portlet__head-text" style="font-size: 1.3rem;">
                Incidents
              </h3>
            </div>
          </div>
        </div>
        <div class="m-portlet__body">
          {% if member.incidents == 0 %}
          <p>You have no incidents!</p>
          {% else %}
          <table class='table table-striped m-table m-table--head-separator-bloom dataTable'>
            <thead>
              <tr>
                <th>
                  Date
                </th>
                <th>
                  Description
                </th>
                <th>
                  Members
                </th>
              </tr>
            </thead>
            <tbody>
              {% for incident in incidents %}
              <tr>
                <td>
                  {{ incident.date }}
                </td>
                <td>
                  {{ incident.description }}
                </td>
                <td>
                  {% for offender in incident.members.all %}{{ offender }}<br/>{% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>
      <!-- End incidents -->
    </div>
  </div>

  <!--End::Main Portlet-->
</div>
{% endblock %}

{% block extraJs %}
{% if reporting_period %}
<script>
$(document).ready(function () {
  var $sentToAmCheck = $('.sent-to-am');
  var $sentToClientCheck = $('.sent-to-client');
  var $dueDatePickers = $('.m_datepicker');

  var csrftoken = $("[name=csrfmiddlewaretoken]").val();

  $dueDatePickers.datepicker({
      todayHighlight: !0,
      autoclose: !0,
      format: 'yyyy-mm-dd',
      orientation: "bottom left",
      templates: {leftArrow: '<i class="la la-angle-left"></i>', rightArrow: '<i class="la la-angle-right"></i>'}
  }).on('show.bs.modal', function (event) {
     event.stopPropagation();
  });

  /**
   * Calendar
   */
   $('#calendar').fullCalendar({
     header: {
       left: "prev, next, today",
       center: "title",
       right: "month, listWeek"
     },
     aspectRatio: 2,
     defaultDate: moment(),
     defaultView: 'listWeek',
     events: [
       {% for promo in promos %}
       {
         title: "{{ promo }}",
         description: "{{ promo.desc }}",
         start: moment("{{ promo.formatted_start }}"),
         end: moment("{{ promo.formatted_end }}"),
         className: "{% if promo.is_active %}m-fc-event--solid-success{% else %}m-fc-event--solid-warning{% endif %}"
       }{% if not forloop.last %},{% endif %}
       {% endfor %}
     ]
   });

  /**
   * Checks off report box
   * @param  {string} el  jQuery element
   * @param  {string} url string
   * @return {}
   */
  var checkReportBox = function (el, url) {
    $.ajax({
        url: '/clients/reports/' + url,
        data: {
          'account_id': el.data('account'),
          'month': {{ reports.0.month }}
        },
        headers: {'X-CSRFToken': csrftoken},
        type: 'POST',
        success: function (data) {
          console.log(data);
        }
    });
  };

  var setDueDate = function (el) {
    $.ajax({
        url: '/clients/reports/set-due-date',
        data: {
          'account_id': el.data('account'),
          'month': {{ reports.0.month }},
          'due_date' : el.val()
        },
        headers: {'X-CSRFToken': csrftoken},
        type: 'POST',
        success: function (data) {
          console.log(data);
        }
    });
  }

  $dueDatePickers.change(function () {
    setDueDate($(this));
    $(this).attr('disabled', 'disabled');
  });


  $sentToAmCheck.click(function () {
    if ($(this).is(':checked')) {
      checkReportBox($(this), 'confirm_sent_am');
      $(this).attr('disabled', 'disabled');
    }
  });

  $sentToClientCheck.click(function () {
    if ($(this).is(':checked')) {
      checkReportBox($(this), 'confirm_sent_client');
      $(this).attr('disabled', 'disabled');
    }
  });


});
</script>
{% endif %}
{% endblock %}
